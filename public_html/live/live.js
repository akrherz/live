Ext.override(Date,{toUTC:function(){return this.add(Date.MINUTE,this.getTimezoneOffset())},fromUTC:function(){return this.add(Date.MINUTE,-this.getTimezoneOffset())}});Ext.override(Ext.Panel,{setIconCls:function(a){Ext.fly(this.ownerCt.getTabEl(this)).child(".x-tab-strip-text").replaceClass(this.iconCls,a);this.setIconClass(a)}});
Ext.override(Ext.Element,{printCSS:null,printStyle:!1,printTitle:document.title,print:function(a){Ext.apply(this,a);a=Ext.get(this.id).dom;this.isGrid&&(a=a.parentNode);var b=document.getElementById("printcontainer"),d=document.getElementById("printframe"),f="";b&&(d&&b.removeChild(d),a.removeChild(b));for(d=0;d<a.attributes.length;d++)if(Ext.isEmpty(a.attributes[d].value)||"null"!=a.attributes[d].value.toLowerCase())if(b=Ext.isEmpty(a.attributes[d].value)?'{0}="true" ':'{0}="{1}" ',this.printStyle?
this.printStyle:"style"!=a.attributes[d].name.toLowerCase())f+=String.format(b,a.attributes[d].name,a.attributes[d].value);b="";if(this.printCSS)for(Ext.isArray(this.printCSS)||(this.printCSS=[this.printCSS]),d=0;d<this.printCSS.length;d++)b+=String.format('<link rel="stylesheet" type="text/css" href="{0}"/>',this.printCSS[d]);f=String.format('<HTML><HEAD>{0}<TITLE>{1}</TITLE></HEAD><BODY onload="{2}"><DIV {3}>{4}</DIV></BODY></HTML>',b,this.printTitle,"",f,a.innerHTML);b=document.createElement("div");
b.setAttribute("style","width:0px;height:0px;"+(Ext.isSafari?"display:none;":"visibility:hidden;"));b.setAttribute("id","printcontainer");a.appendChild(b);Ext.isIE&&(b.style.display="none");d=document.createElement("iframe");d.setAttribute("id","printframe");d.setAttribute("name","printframe");b.appendChild(d);d.contentWindow.document.open();d.contentWindow.document.write(f);d.contentWindow.document.close();this.isGrid&&(a=Ext.get(d.contentWindow.document.body),a=Ext.get(a.first().dom.parentNode),
a.child("div.x-panel-body").setStyle("height",""),a.child("div.x-grid3").setStyle("height",""),a.child("div.x-grid3-scroller").setStyle("height",""));Ext.isIE?d.contentWindow.document.execCommand("print"):d.contentWindow.print()}});var Base64=function(){return{encode:function(a){var b="",d,f,h,g,l,n,r=0;do d=a.charCodeAt(r++),f=a.charCodeAt(r++),h=a.charCodeAt(r++),g=d>>2,d=(d&3)<<4|f>>4,l=(f&15)<<2|h>>6,n=h&63,isNaN(f)?l=n=64:isNaN(h)&&(n=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(n);
while(r<a.length);return b},decode:function(a){var b="",d,f,h,g,l,n=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),d=d<<2|f>>4,f=(f&15)<<
4|g>>2,h=(g&3)<<6|l,b+=String.fromCharCode(d),64!=g&&(b+=String.fromCharCode(f)),64!=l&&(b+=String.fromCharCode(h));while(n<a.length);return b}}}(),hexcase=0,b64pad="=",chrsz=8;function hex_sha1(a){return binb2hex(core_sha1(str2binb(a),a.length*chrsz))}function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),a.length*chrsz))}function str_sha1(a){return binb2str(core_sha1(str2binb(a),a.length*chrsz))}function hex_hmac_sha1(a,b){return binb2hex(core_hmac_sha1(a,b))}
function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b))}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}
function core_sha1(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;var d=Array(80),f=1732584193,h=-271733879,g=-1732584194,l=271733878,n=-1009589776,r,m,w,u,s,v,x,y;for(r=0;r<a.length;r+=16){u=f;s=h;v=g;x=l;y=n;for(m=0;80>m;m++)d[m]=16>m?a[r+m]:rol(d[m-3]^d[m-8]^d[m-14]^d[m-16],1),w=safe_add(safe_add(rol(f,5),sha1_ft(m,h,g,l)),safe_add(safe_add(n,d[m]),sha1_kt(m))),n=l,l=g,g=rol(h,30),h=f,f=w;f=safe_add(f,u);h=safe_add(h,s);g=safe_add(g,v);l=safe_add(l,x);n=safe_add(n,y)}return[f,h,g,l,n]}
function sha1_ft(a,b,d,f){return 20>a?b&d|~b&f:40>a?b^d^f:60>a?b&d|b&f|d&f:b^d^f}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function core_hmac_sha1(a,b){var d=str2binb(a);16<d.length&&(d=core_sha1(d,a.length*chrsz));for(var f=Array(16),h=Array(16),g=0;16>g;g++)f[g]=d[g]^909522486,h[g]=d[g]^1549556828;d=core_sha1(f.concat(str2binb(b)),512+b.length*chrsz);return core_sha1(h.concat(d),672)}
function safe_add(a,b){var d=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(d>>16)<<16|d&65535}function rol(a,b){return a<<b|a>>>32-b}function str2binb(a){for(var b=[],d=(1<<chrsz)-1,f=0;f<a.length*chrsz;f+=chrsz)b[f>>5]|=(a.charCodeAt(f/chrsz)&d)<<32-chrsz-f%32;return b}function binb2str(a){for(var b="",d=(1<<chrsz)-1,f=0;f<32*a.length;f+=chrsz)b+=String.fromCharCode(a[f>>5]>>>32-chrsz-f%32&d);return b}
function binb2hex(a){for(var b=hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",f=0;f<4*a.length;f++)d+=b.charAt(a[f>>2]>>8*(3-f%4)+4&15)+b.charAt(a[f>>2]>>8*(3-f%4)&15);return d}function binb2b64(a){for(var b="",d,f,h=0;h<4*a.length;h+=3)for(d=(a[h>>2]>>8*(3-h%4)&255)<<16|(a[h+1>>2]>>8*(3-(h+1)%4)&255)<<8|a[h+2>>2]>>8*(3-(h+2)%4)&255,f=0;4>f;f++)b=8*h+6*f>32*a.length?b+b64pad:b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>6*(3-f)&63);return b}
var MD5=function(){var a=function(a,l){var b=(a&65535)+(l&65535);return(a>>16)+(l>>16)+(b>>16)<<16|b&65535},b=function(a){for(var l=[],b=0;b<8*a.length;b+=8)l[b>>5]|=(a.charCodeAt(b/8)&255)<<b%32;return l},d=function(a){for(var l="",b=0;b<32*a.length;b+=8)l+=String.fromCharCode(a[b>>5]>>>b%32&255);return l},f=function(a){for(var b="",l=0;l<4*a.length;l++)b+="0123456789abcdef".charAt(a[l>>2]>>l%4*8+4&15)+"0123456789abcdef".charAt(a[l>>2]>>l%4*8&15);return b},h=function(a){for(var l="",b,d,n=0;n<4*
a.length;n+=3)for(b=(a[n>>2]>>n%4*8&255)<<16|(a[n+1>>2]>>(n+1)%4*8&255)<<8|a[n+2>>2]>>(n+2)%4*8&255,d=0;4>d;d++)l=8*n+6*d>32*a.length?l+"":l+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(b>>6*(3-d)&63);return l},g=function(l,b,d,n,g,r){l=a(a(b,l),a(n,r));return a(l<<g|l>>>32-g,d)},l=function(a,l,b,d,n,r,f){return g(l&b|~l&d,a,l,n,r,f)},n=function(a,l,b,d,n,r,f){return g(l&d|b&~d,a,l,n,r,f)},r=function(a,l,b,d,n,r,f){return g(b^(l|~d),a,l,n,r,f)},m=function(b,d){b[d>>5]|=
128<<d%32;b[(d+64>>>9<<4)+14]=d;for(var f=1732584193,h=-271733879,m=-1732584194,p=271733878,w,z,B,C,q=0;q<b.length;q+=16)w=f,z=h,B=m,C=p,f=l(f,h,m,p,b[q+0],7,-680876936),p=l(p,f,h,m,b[q+1],12,-389564586),m=l(m,p,f,h,b[q+2],17,606105819),h=l(h,m,p,f,b[q+3],22,-1044525330),f=l(f,h,m,p,b[q+4],7,-176418897),p=l(p,f,h,m,b[q+5],12,1200080426),m=l(m,p,f,h,b[q+6],17,-1473231341),h=l(h,m,p,f,b[q+7],22,-45705983),f=l(f,h,m,p,b[q+8],7,1770035416),p=l(p,f,h,m,b[q+9],12,-1958414417),m=l(m,p,f,h,b[q+10],17,-42063),
h=l(h,m,p,f,b[q+11],22,-1990404162),f=l(f,h,m,p,b[q+12],7,1804603682),p=l(p,f,h,m,b[q+13],12,-40341101),m=l(m,p,f,h,b[q+14],17,-1502002290),h=l(h,m,p,f,b[q+15],22,1236535329),f=n(f,h,m,p,b[q+1],5,-165796510),p=n(p,f,h,m,b[q+6],9,-1069501632),m=n(m,p,f,h,b[q+11],14,643717713),h=n(h,m,p,f,b[q+0],20,-373897302),f=n(f,h,m,p,b[q+5],5,-701558691),p=n(p,f,h,m,b[q+10],9,38016083),m=n(m,p,f,h,b[q+15],14,-660478335),h=n(h,m,p,f,b[q+4],20,-405537848),f=n(f,h,m,p,b[q+9],5,568446438),p=n(p,f,h,m,b[q+14],9,-1019803690),
m=n(m,p,f,h,b[q+3],14,-187363961),h=n(h,m,p,f,b[q+8],20,1163531501),f=n(f,h,m,p,b[q+13],5,-1444681467),p=n(p,f,h,m,b[q+2],9,-51403784),m=n(m,p,f,h,b[q+7],14,1735328473),h=n(h,m,p,f,b[q+12],20,-1926607734),f=g(h^m^p,f,h,b[q+5],4,-378558),p=g(f^h^m,p,f,b[q+8],11,-2022574463),m=g(p^f^h,m,p,b[q+11],16,1839030562),h=g(m^p^f,h,m,b[q+14],23,-35309556),f=g(h^m^p,f,h,b[q+1],4,-1530992060),p=g(f^h^m,p,f,b[q+4],11,1272893353),m=g(p^f^h,m,p,b[q+7],16,-155497632),h=g(m^p^f,h,m,b[q+10],23,-1094730640),f=g(h^m^
p,f,h,b[q+13],4,681279174),p=g(f^h^m,p,f,b[q+0],11,-358537222),m=g(p^f^h,m,p,b[q+3],16,-722521979),h=g(m^p^f,h,m,b[q+6],23,76029189),f=g(h^m^p,f,h,b[q+9],4,-640364487),p=g(f^h^m,p,f,b[q+12],11,-421815835),m=g(p^f^h,m,p,b[q+15],16,530742520),h=g(m^p^f,h,m,b[q+2],23,-995338651),f=r(f,h,m,p,b[q+0],6,-198630844),p=r(p,f,h,m,b[q+7],10,1126891415),m=r(m,p,f,h,b[q+14],15,-1416354905),h=r(h,m,p,f,b[q+5],21,-57434055),f=r(f,h,m,p,b[q+12],6,1700485571),p=r(p,f,h,m,b[q+3],10,-1894986606),m=r(m,p,f,h,b[q+10],
15,-1051523),h=r(h,m,p,f,b[q+1],21,-2054922799),f=r(f,h,m,p,b[q+8],6,1873313359),p=r(p,f,h,m,b[q+15],10,-30611744),m=r(m,p,f,h,b[q+6],15,-1560198380),h=r(h,m,p,f,b[q+13],21,1309151649),f=r(f,h,m,p,b[q+4],6,-145523070),p=r(p,f,h,m,b[q+11],10,-1120210379),m=r(m,p,f,h,b[q+2],15,718787259),h=r(h,m,p,f,b[q+9],21,-343485551),f=a(f,w),h=a(h,z),m=a(m,B),p=a(p,C);return[f,h,m,p]},w=function(a,l){var d=b(a);16<d.length&&(d=m(d,8*a.length));for(var n=Array(16),f=Array(16),g=0;16>g;g++)n[g]=d[g]^909522486,f[g]=
d[g]^1549556828;d=m(n.concat(b(l)),512+8*l.length);return m(f.concat(d),640)};return{hexdigest:function(a){return f(m(b(a),8*a.length))},b64digest:function(a){return h(m(b(a),8*a.length))},hash:function(a){return d(m(b(a),8*a.length))},hmac_hexdigest:function(a,b){return f(w(a,b))},hmac_b64digest:function(a,b){return h(w(a,b))},hmac_hash:function(a,b){return d(w(a,b))},test:function(){return"900150983cd24fb0d6963f7d28e17f72"===MD5.hexdigest("abc")}}}();
Function.prototype.bind||(Function.prototype.bind=function(a){var b=this,d=Array.prototype.slice,f=Array.prototype.concat,h=d.call(arguments,1);return function(){return b.apply(a?a:this,f.call(h,d.call(arguments,0)))}});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var d=this.length,f=Number(b)||0,f=0>f?Math.ceil(f):Math.floor(f);for(0>f&&(f+=d);f<d;f++)if(f in this&&this[f]===a)return f;return-1});
(function(a){function b(a,b){return new g.Builder(a,b)}function d(a){return new g.Builder("message",a)}function f(a){return new g.Builder("iq",a)}function h(a){return new g.Builder("presence",a)}var g;g={VERSION:"1.1.0",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",
SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style",
"height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(a){for(var b=0;b<g.XHTML.tags.length;b++)if(a==g.XHTML.tags[b])return!0;return!1},validAttribute:function(a,b){if("undefined"!==typeof g.XHTML.attributes[a]&&0<g.XHTML.attributes[a].length)for(var d=0;d<g.XHTML.attributes[a].length;d++)if(b==g.XHTML.attributes[a][d])return!0;
return!1},validCSS:function(a){for(var b=0;b<g.XHTML.css.length;b++)if(a==g.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(a,b){g.NS[a]=b},forEachChild:function(a,b,d){var f,h;for(f=0;f<a.childNodes.length;f++)h=a.childNodes[f],h.nodeType!=
g.ElementType.NORMAL||b&&!this.isTagEqual(h,b)||d(h)},isTagEqual:function(a,b){return a.tagName.toLowerCase()==b.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var a;void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){g._xmlGenerator||
(g._xmlGenerator=g._makeGenerator());return g._xmlGenerator},_getIEXmlDom:function(){for(var a=null,b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),d=0;d<b.length;d++)if(null===a)try{a=new ActiveXObject(b[d])}catch(f){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=g.xmlGenerator().createElement(a),d,f,h;for(d=1;d<arguments.length;d++)if(arguments[d])if("string"==
typeof arguments[d]||"number"==typeof arguments[d])b.appendChild(g.xmlTextNode(arguments[d]));else if("object"==typeof arguments[d]&&"function"==typeof arguments[d].sort)for(f=0;f<arguments[d].length;f++)"object"==typeof arguments[d][f]&&"function"==typeof arguments[d][f].sort&&b.setAttribute(arguments[d][f][0],arguments[d][f][1]);else if("object"==typeof arguments[d])for(h in arguments[d])arguments[d].hasOwnProperty(h)&&b.setAttribute(h,arguments[d][h]);return b},xmlescape:function(a){a=a.replace(/\&/g,
"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlTextNode:function(a){return g.xmlGenerator().createTextNode(a)},xmlHtmlNode:function(a){window.DOMParser?(parser=new DOMParser,node=parser.parseFromString(a,"text/xml")):(node=new ActiveXObject("Microsoft.XMLDOM"),node.async="false",node.loadXML(a));return node},getText:function(a){if(!a)return null;var b="";0===a.childNodes.length&&a.nodeType==g.ElementType.TEXT&&(b+=a.nodeValue);
for(var d=0;d<a.childNodes.length;d++)a.childNodes[d].nodeType==g.ElementType.TEXT&&(b+=a.childNodes[d].nodeValue);return g.xmlescape(b)},copyElement:function(a){var b,d;if(a.nodeType==g.ElementType.NORMAL){d=g.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)d.setAttribute(a.attributes[b].nodeName.toLowerCase(),a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)d.appendChild(g.copyElement(a.childNodes[b]))}else a.nodeType==g.ElementType.TEXT&&(d=g.xmlGenerator().createTextNode(a.nodeValue));
return d},createHtml:function(a){var b,d,f,h,u,s,v,x,y,p,A;if(a.nodeType==g.ElementType.NORMAL)if(h=a.nodeName.toLowerCase(),g.XHTML.validTag(h))try{d=g.xmlElement(h);for(b=0;b<g.XHTML.attributes[h].length;b++)if(u=g.XHTML.attributes[h][b],s=a.getAttribute(u),"undefined"!=typeof s&&null!==s&&""!==s&&!1!==s&&0!==s)if("style"==u&&"object"==typeof s&&"undefined"!=typeof s.cssText&&(s=s.cssText),"style"==u){v=[];x=s.split(";");for(f=0;f<x.length;f++)y=x[f].split(":"),p=y[0].replace(/^\s*/,"").replace(/\s*$/,
"").toLowerCase(),g.XHTML.validCSS(p)&&(A=y[1].replace(/^\s*/,"").replace(/\s*$/,""),v.push(p+": "+A));0<v.length&&(s=v.join("; "),d.setAttribute(u,s))}else d.setAttribute(u,s);for(b=0;b<a.childNodes.length;b++)d.appendChild(g.createHtml(a.childNodes[b]))}catch(z){d=g.xmlTextNode("")}else for(d=g.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)d.appendChild(g.createHtml(a.childNodes[b]));else if(a.nodeType==g.ElementType.FRAGMENT)for(d=g.xmlGenerator().createDocumentFragment(),
b=0;b<a.childNodes.length;b++)d.appendChild(g.createHtml(a.childNodes[b]));else a.nodeType==g.ElementType.TEXT&&(d=g.xmlTextNode(a.nodeValue));return d},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,
"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=g.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?
a.split("/")[0]:null},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var b;if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var d=a.nodeName,f,h;a.getAttribute("_realname")&&(d=a.getAttribute("_realname"));b="<"+d;for(f=0;f<a.attributes.length;f++)"_realname"!=
a.attributes[f].nodeName&&(b+=" "+a.attributes[f].nodeName.toLowerCase()+"='"+a.attributes[f].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'");if(0<a.childNodes.length){b+=">";for(f=0;f<a.childNodes.length;f++)switch(h=a.childNodes[f],h.nodeType){case g.ElementType.NORMAL:b+=g.serialize(h);break;case g.ElementType.TEXT:b+=g.xmlescape(h.nodeValue);break;case g.ElementType.CDATA:b+="<![CDATA["+h.nodeValue+"]]\x3e"}b+="</"+d+">"}else b+="/>";return b},
_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){g._connectionPlugins[a]=b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=g.NS.CLIENT:b||(b={xmlns:g.NS.CLIENT});this.node=this.nodeTree=g.xmlElement(a,b)}};g.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return g.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.node.setAttribute(b,
a[b]);return this},c:function(a,b,d){a=g.xmlElement(a,b,d);this.node.appendChild(a);d||(this.node=a);return this},cnode:function(a){var b,d=g.xmlGenerator();try{b=void 0!==d.importNode}catch(f){b=!1}a=b?d.importNode(a,!0):g.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){a=g.xmlTextNode(a);this.node.appendChild(a);return this},h:function(a){var b=document.createElement("body");b.innerHTML=a;for(a=g.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);
return this}};g.Handler=function(a,b,d,f,h,u,s){this.handler=a;this.ns=b;this.name=d;this.type=f;this.id=h;this.options=s||{matchBare:!1};this.options.matchBare||(this.options.matchBare=!1);this.from=this.options.matchBare?u?g.getBareJidFromJid(u):null:u;this.user=!0};g.Handler.prototype={isMatch:function(a){var b,d=null,d=this.options.matchBare?g.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");b=!1;if(this.ns){var f=this;g.forEachChild(a,null,function(a){a.getAttribute("xmlns")==
f.ns&&(b=!0)});b=b||a.getAttribute("xmlns")==this.ns}else b=!0;return!b||this.name&&!g.isTagEqual(a,this.name)||this.type&&a.getAttribute("type")!=this.type||this.id&&a.getAttribute("id")!=this.id||this.from&&d!=this.from?!1:!0},run:function(a){var b=null;try{b=this.handler(a)}catch(d){throw d.sourceURL?g.fatal("error: "+this.handler+" "+d.sourceURL+":"+d.line+" - "+d.name+": "+d.message):d.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",d,d.message)),
g.fatal("error: "+this.handler+" "+d.fileName+":"+d.lineNumber+" - "+d.name+": "+d.message)):g.fatal("error: "+d.message+"\n"+d.stack),d;}return b},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};g.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0};g.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},
toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};g.Connection=function(a,b){this.service=a;this._options=b||{};var d=this._options.protocol||"";0===a.indexOf("ws:")||0===a.indexOf("wss:")||0===d.indexOf("ws")?this._proto=new g.Websocket(this):this._proto=new g.Bosh(this);this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=
[];this._authentication={};this._disconnectTimeout=this._idleTimeout=null;this.do_authentication=!0;this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var f in g._connectionPlugins)g._connectionPlugins.hasOwnProperty(f)&&(d=function(){},d.prototype=g._connectionPlugins[f],
this[f]=new d,this[f].init(this))};g.Connection.prototype={reset:function(){this._proto._reset();this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return"string"==typeof a||"number"==
typeof a?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,b,d,f,h,u){this.jid=a;this.authzid=g.getBareJidFromJid(this.jid);this.authcid=g.getNodeFromJid(this.jid);this.pass=b;this.servtype="xmpp";this.connect_callback=d;this.authenticated=this.connected=this.disconnecting=!1;this.errors=0;this.domain=this.domain||g.getDomainFromJid(this.jid);this._changeConnectStatus(g.Status.CONNECTING,null);this._proto._connect(f,h,u)},attach:function(a,b,d,f,g,h,s){this._proto.attach(a,b,d,f,g,h,
s)},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},send:function(a){if(null!==a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,b,d,f){var g=null,h=this;"function"===typeof a.tree&&(a=a.tree());var s=a.getAttribute("id");s||(s=this.getUniqueId("sendIQ"),
a.setAttribute("id",s));var v=this.addHandler(function(a){g&&h.deleteTimedHandler(g);var f=a.getAttribute("type");if("result"==f)b&&b(a);else if("error"==f)d&&d(a);else throw{name:"StropheError",message:"Got bad IQ type of "+f};},null,"iq",null,s);f&&(g=this.addTimedHandler(f,function(){h.deleteHandler(v);d&&d(null);return!1}));this.send(a);return s},_queueData:function(a){if(null===a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},
_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,b){var d=new g.TimedHandler(a,b);this.addTimeds.push(d);return d},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,b,d,f,h,u,s){a=new g.Handler(a,b,d,f,h,u,s);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(g.Status.DISCONNECTING,
a);g.info("Disconnect was called because: "+a);this.connected&&(a=!1,this.disconnecting=!0,this.authenticated&&(a=h({xmlns:g.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a))},_changeConnectStatus:function(a,b){for(var d in g._connectionPlugins)if(g._connectionPlugins.hasOwnProperty(d)){var f=this[d];if(f.statusChanged)try{f.statusChanged(a,b)}catch(h){g.error(""+d+" plugin caused an exception changing status: "+
h)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(u){g.error("User connection callback caused an exception: "+u)}},_doDisconnect:function(){null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);g.info("_doDisconnect was called");this._proto._doDisconnect();this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(g.Status.DISCONNECTED,
null);this.connected=!1},_dataRecv:function(a,b){g.info("_dataRecv called");var d=this._proto._reqToData(a);if(null!==d){this.xmlInput!==g.Connection.prototype.xmlInput&&(d.nodeName===this._proto.strip&&d.childNodes.length?this.xmlInput(d.childNodes[0]):this.xmlInput(d));this.rawInput!==g.Connection.prototype.rawInput&&(b?this.rawInput(b):this.rawInput(g.serialize(d)));for(var f;0<this.removeHandlers.length;)f=this.removeHandlers.pop(),f=this.handlers.indexOf(f),0<=f&&this.handlers.splice(f,1);for(;0<
this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else if(f=d.getAttribute("type"),null!==f&&"terminate"==f)this.disconnecting||(f=d.getAttribute("condition"),d=d.getElementsByTagName("conflict"),null!==f?("remote-stream-error"==f&&0<d.length&&(f="conflict"),this._changeConnectStatus(g.Status.CONNFAIL,f)):this._changeConnectStatus(g.Status.CONNFAIL,"unknown"),this.disconnect("unknown stream-error"));else{var h=
this;g.forEachChild(d,null,function(a){var b,d;d=h.handlers;h.handlers=[];for(b=0;b<d.length;b++){var f=d[b];try{!f.isMatch(a)||!h.authenticated&&f.user?h.handlers.push(f):f.run(a)&&h.handlers.push(f)}catch(l){g.warn("Removing Strophe handlers due to uncaught exception: "+l.message)}}})}}},mechanisms:{},_connect_cb:function(a,b,d){g.info("_connect_cb was called");this.connected=!0;if(a=this._proto._reqToData(a))if(this.xmlInput!==g.Connection.prototype.xmlInput&&(a.nodeName===this._proto.strip&&a.childNodes.length?
this.xmlInput(a.childNodes[0]):this.xmlInput(a)),this.rawInput!==g.Connection.prototype.rawInput&&(d?this.rawInput(d):this.rawInput(g.serialize(a))),this._proto._connect_cb(a)!==g.Status.CONNFAIL){this._authentication.sasl_scram_sha1=!1;this._authentication.sasl_plain=!1;this._authentication.sasl_digest_md5=!1;this._authentication.sasl_anonymous=!1;this._authentication.legacy_auth=!1;var f=0<a.getElementsByTagName("stream:features").length;f||(f=0<a.getElementsByTagName("features").length);d=a.getElementsByTagName("mechanism");
var h=[],u;u=!1;if(f){if(0<d.length)for(f=0;f<d.length;f++)u=g.getText(d[f]),this.mechanisms[u]&&h.push(this.mechanisms[u]);this._authentication.legacy_auth=0<a.getElementsByTagName("auth").length;(u=this._authentication.legacy_auth||0<h.length)?!1!==this.do_authentication&&this.authenticate(h):this._proto._no_auth_received(b)}else this._proto._no_auth_received(b)}},authenticate:function(a){var d;for(d=0;d<a.length-1;++d){for(var h=d,m=d+1;m<a.length;++m)a[m].prototype.priority>a[h].prototype.priority&&
(h=m);h!=d&&(m=a[d],a[d]=a[h],a[h]=m)}h=!1;for(d=0;d<a.length;++d)if(a[d].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new a[d];this._sasl_mechanism.onStart(this);a=b("auth",{xmlns:g.NS.SASL,
mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(d=this._sasl_mechanism.onChallenge(this,null),a.t(Base64.encode(d)));this.send(a.tree());h=!0;break}h||(null===g.getNodeFromJid(this.jid)?(this._changeConnectStatus(g.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(g.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(f({type:"get",to:this.domain,
id:"_auth_1"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).tree())))},_sasl_challenge_cb:function(a){a=Base64.decode(g.getText(a));a=this._sasl_mechanism.onChallenge(this,a);var d=b("response",{xmlns:g.NS.SASL});""!==a&&d.t(Base64.encode(a));this.send(d.tree());return!0},_auth1_cb:function(a){a=f({type:"set",id:"_auth_2"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).up().c("password").t(this.pass);g.getResourceFromJid(this.jid)||(this.jid=
g.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(g.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){if(this._sasl_data["server-signature"]){var b;matches=Base64.decode(g.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"==matches[1]&&(b=matches[2]);if(b!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,
this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}g.info("SASL authentication succeeded.");if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);this._addSysHandler(this._sasl_auth1_cb.bind(this),
null,"stream:features",null,null);this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var b,d;for(b=0;b<a.childNodes.length;b++)d=a.childNodes[b],"bind"==d.nodeName&&(this.do_bind=!0),"session"==d.nodeName&&(this.do_session=!0);this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=g.getResourceFromJid(this.jid))?this.send(f({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).c("resource",{}).t(a).tree()):this.send(f({type:"set",
id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).tree())):this._changeConnectStatus(g.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type")){g.info("SASL binding failed.");var b;0<a.getElementsByTagName("conflict").length&&(b="conflict");this._changeConnectStatus(g.Status.AUTHFAIL,b);return!1}a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=g.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),
null,null,null,"_session_auth_2"),this.send(f({type:"set",id:"_session_auth_2"}).c("session",{xmlns:g.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)));else return g.info("SASL binding failed."),this._changeConnectStatus(g.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(g.info("Session creation failed."),
this._changeConnectStatus(g.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(g.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=
!0,this._changeConnectStatus(g.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(g.Status.AUTHFAIL,null),this.disconnect("authentication failed"));return!1},_addSysTimedHandler:function(a,b){var d=new g.TimedHandler(a,b);d.user=!1;this.addTimeds.push(d);return d},_addSysHandler:function(a,b,d,f,h){a=new g.Handler(a,b,d,f,h);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){g.info("_onDisconnectTimeout was called");this._proto._onDisconnectTimeout();
this._doDisconnect();return!1},_onIdle:function(){for(var a,b,d,f;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var g=(new Date).getTime();f=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)d=b.lastCalled+b.period,0>=d-g?b.run()&&f.push(b):f.push(b);this.timedHandlers=f;clearTimeout(this._idleTimeout);
this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}};a&&a(g,b,d,f,h);g.SASLMechanism=function(a,b,d){this.name=a;this.isClientFirst=b;this.priority=d};g.SASLMechanism.prototype={_sasl_data:{},test:function(a){return!0},onStart:function(a){this._connection=a},onChallenge:function(a,b){throw Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};g.SASLAnonymous=function(){};
g.SASLAnonymous.prototype=new g.SASLMechanism("ANONYMOUS",!1,10);g.SASLAnonymous.test=function(a){return null===a.authcid};g.Connection.prototype.mechanisms[g.SASLAnonymous.prototype.name]=g.SASLAnonymous;g.SASLPlain=function(){};g.SASLPlain.prototype=new g.SASLMechanism("PLAIN",!0,20);g.SASLPlain.test=function(a){return null!==a.authcid};g.SASLPlain.prototype.onChallenge=function(a,b){var d=a.authzid,d=d+"\x00"+a.authcid,d=d+"\x00";return d+=a.pass};g.Connection.prototype.mechanisms[g.SASLPlain.prototype.name]=
g.SASLPlain;g.SASLSHA1=function(){};g.SASLSHA1.prototype=new g.SASLMechanism("SCRAM-SHA-1",!0,40);g.SASLSHA1.test=function(a){return null!==a.authcid};g.SASLSHA1.prototype.onChallenge=function(a,b,d){b=d||MD5.hexdigest(1234567890*Math.random());a="n="+a.authcid;a=a+",r="+b;this._sasl_data.cnonce=b;this._sasl_data["client-first-message-bare"]=a;a="n,,"+a;this.onChallenge=function(a,b){for(var d,f,g,h="c=biws,",l=this._sasl_data["client-first-message-bare"]+","+b+",",n=this._sasl_data.cnonce,r=/([a-z]+)=([^,]+)(,|$)/;b.match(r);)switch(matches=
b.match(r),b=b.replace(matches[0],""),matches[1]){case "r":d=matches[2];break;case "s":f=matches[2];break;case "i":g=matches[2]}if(d.substr(0,n.length)!==n)return this._sasl_data={},a._sasl_failure_cb();h+="r="+d;l+=h;f=Base64.decode(f);d=f=core_hmac_sha1(a.pass,f+"\x00\x00\x00\u0001");for(i=1;i<g;i++)for(f=core_hmac_sha1(a.pass,binb2str(f)),k=0;5>k;k++)d[k]^=f[k];d=binb2str(d);g=core_hmac_sha1(d,"Client Key");d=str_hmac_sha1(d,"Server Key");f=core_hmac_sha1(str_sha1(binb2str(g)),l);a._sasl_data["server-signature"]=
b64_hmac_sha1(d,l);for(k=0;5>k;k++)g[k]^=f[k];return h+=",p="+Base64.encode(binb2str(g))}.bind(this);return a};g.Connection.prototype.mechanisms[g.SASLSHA1.prototype.name]=g.SASLSHA1;g.SASLMD5=function(){};g.SASLMD5.prototype=new g.SASLMechanism("DIGEST-MD5",!1,30);g.SASLMD5.test=function(a){return null!==a.authcid};g.SASLMD5.prototype._quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};g.SASLMD5.prototype.onChallenge=function(a,b,d){var f=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;
d=d||MD5.hexdigest(""+1234567890*Math.random());for(var g="",h=null,s="",v;b.match(f);)switch(v=b.match(f),b=b.replace(v[0],""),v[2]=v[2].replace(/^"(.+)"$/,"$1"),v[1]){case "realm":g=v[2];break;case "nonce":s=v[2];break;case "host":h=v[2]}b=a.servtype+"/"+a.domain;null!==h&&(b=b+"/"+h);f=MD5.hash(a.authcid+":"+g+":"+this._connection.pass)+":"+s+":"+d;h="AUTHENTICATE:"+b;a="charset=utf-8,"+("username="+this._quote(a.authcid)+",");a+="realm="+this._quote(g)+",";a+="nonce="+this._quote(s)+",";a+="nc=00000001,";
a+="cnonce="+this._quote(d)+",";a+="digest-uri="+this._quote(b)+",";a+="response="+MD5.hexdigest(MD5.hexdigest(f)+":"+s+":00000001:"+d+":auth:"+MD5.hexdigest(h))+",";a+="qop=auth";this.onChallenge=function(a,b){return""}.bind(this);return a};g.Connection.prototype.mechanisms[g.SASLMD5.prototype.name]=g.SASLMD5})(function(a,b,d,f,h){window.Strophe=a;window.$build=b;window.$msg=d;window.$iq=f;window.$pres=h});
Strophe.Request=function(a,b,d,f){this.id=++Strophe._requestId;this.xmlData=a;this.data=Strophe.serialize(a);this.func=this.origFunc=b;this.rid=d;this.date=NaN;this.sends=f||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?(new Date-this.dead)/1E3:0};this.xhr=this._newXHR()};
Strophe.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"==a.tagName)throw Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)),"parsererror";}else this.xhr.responseText&&(Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),
Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};Strophe.Bosh=function(a){this._conn=a;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this._requests=[]};
Strophe.Bosh.prototype={strip:null,_buildBody:function(){var a=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});null!==this.sid&&a.attrs({sid:this.sid});return a},_reset:function(){this.rid=Math.floor(4294967295*Math.random());this.sid=null},_connect:function(a,b,d){this.wait=a||this.wait;this.hold=b||this.hold;a=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});
d&&a.attrs({route:d});d=this._conn._connect_cb;this._requests.push(new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,d.bind(this._conn)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(a,b,d,f,h,g,l){this._conn.jid=a;this.sid=b;this.rid=d;this._conn.connect_callback=f;this._conn.domain=Strophe.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=h||this.wait;this.hold=g||this.hold;this.window=l||this.window;
this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null)},_connect_cb:function(a){var b=a.getAttribute("type"),d;if(null!==b&&"terminate"==b)return Strophe.error("BOSH-Connection failed: "+d),d=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==d&&0<a.length&&(d="conflict"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,d)):this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(),Strophe.Status.CONNFAIL;
this.sid||(this.sid=a.getAttribute("sid"));if(d=a.getAttribute("requests"))this.window=parseInt(d,10);if(d=a.getAttribute("hold"))this.hold=parseInt(d,10);if(a=a.getAttribute("wait"))this.wait=parseInt(a,10)},_disconnect:function(a){this._sendTerminate(a)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(4294967295*Math.random())},_emptyQueue:function(){return 0===this._requests.length},_hitError:function(a){this.errors++;Strophe.warn("request errored, status: "+a+", number of errors: "+
this.errors);4<this.errors&&this._onDisconnectTimeout()},_no_auth_received:function(a){a=a?a.bind(this._conn):this._conn._connect_cb.bind(this._conn);var b=this._buildBody();this._requests.push(new Strophe.Request(b.tree(),this._onRequestStateChange.bind(this,a.bind(this._conn)),b.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){}},_onIdle:function(){var a=
this._conn._data;this._conn.authenticated&&0===this._requests.length&&0===a.length&&!this._conn.disconnecting&&(Strophe.info("no requests during idle cycle, sending blank request"),a.push(null));if(2>this._requests.length&&0<a.length&&!this._conn.paused){body=this._buildBody();for(i=0;i<a.length;i++)null!==a[i]&&("restart"===a[i]?body.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH}):body.cnode(a[i]).up());delete this._conn._data;this._conn._data=[];
this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),body.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}0<this._requests.length&&(time_elapsed=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait)&&(Strophe.warn("Request "+this._requests[0].id+
" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))},_onRequestStateChange:function(a,b){Strophe.debug("request id "+b.id+"."+b.sends+" state changed to "+b.xhr.readyState);if(b.abort)b.abort=!1;else{var d;if(4==b.xhr.readyState){d=0;try{d=b.xhr.status}catch(f){}"undefined"==typeof d&&(d=0);if(this.disconnecting&&400<=d)this._hitError(d);else{var h=this._requests[0]==b,g=this._requests[1]==b;if(0<d&&500>d||5<b.sends)this._removeRequest(b),
Strophe.debug("request id "+b.id+" should now be removed");if(200==d)(g||h&&0<this._requests.length&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),Strophe.debug("request id "+b.id+"."+b.sends+" got 200"),a(b),this.errors=0;else if(Strophe.error("request id "+b.id+"."+b.sends+" error "+d+" happened"),0===d||400<=d&&600>d||12E3<=d)this._hitError(d),400<=d&&500>d&&(this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null),this._conn._doDisconnect());
0<d&&500>d||5<b.sends||this._throttledRequestHandler()}}}},_processRequest:function(a){var b=this,d=this._requests[a],f=-1;try{4==d.xhr.readyState&&(f=d.xhr.status)}catch(h){Strophe.error("caught an error in _requests["+a+"], reqStatus: "+f)}"undefined"==typeof f&&(f=-1);if(d.sends>this.maxRetries)this._onDisconnectTimeout();else{var g=d.age(),g=!isNaN(g)&&g>Math.floor(Strophe.TIMEOUT*this.wait),l=null!==d.dead&&d.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait),f=4==d.xhr.readyState&&(1>
f||500<=f);if(g||l||f)l&&Strophe.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),d.abort=!0,d.xhr.abort(),d.xhr.onreadystatechange=function(){},this._requests[a]=new Strophe.Request(d.xmlData,d.origFunc,d.rid,d.sends),d=this._requests[a];if(0===d.xhr.readyState){Strophe.debug("request id "+d.id+"."+d.sends+" posting");try{d.xhr.open("POST",this._conn.service,!0)}catch(n){Strophe.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,
"bad-service");this._conn.disconnect();return}a=function(){d.date=new Date;if(b._conn._options.customHeaders){var a=b._conn._options.customHeaders,f;for(f in a)a.hasOwnProperty(f)&&d.xhr.setRequestHeader(f,a[f])}d.xhr.send(d.data)};1<d.sends?(f=1E3*Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(d.sends,3)),setTimeout(a,f)):a();d.sends++;this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput&&(d.xmlData.nodeName===this.strip&&d.xmlData.childNodes.length?this._conn.xmlOutput(d.xmlData.childNodes[0]):
this._conn.xmlOutput(d.xmlData));this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput&&this._conn.rawOutput(d.data)}else Strophe.debug("_processRequest: "+(0===a?"first":"second")+" request has readyState of "+d.xhr.readyState)}},_removeRequest:function(a){Strophe.debug("removing request");var b;for(b=this._requests.length-1;0<=b;b--)a==this._requests[b]&&this._requests.splice(b,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];
null===b.dead&&(b.dead=new Date);this._processRequest(a)},_reqToData:function(a){try{return a.getResponse()}catch(b){if("parsererror"!=b)throw b;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(a){Strophe.info("_sendTerminate was called");var b=this._buildBody().attrs({type:"terminate"});a&&b.cnode(a.tree());a=new Strophe.Request(b.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),b.tree().getAttribute("rid"));this._requests.push(a);this._throttledRequestHandler()},
_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(this._conn._onIdle.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):Strophe.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&
(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};Strophe.Websocket=function(a){this._conn=a;this.strip="stream:stream";var b=a.service;if(0!==b.indexOf("ws:")&&0!==b.indexOf("wss:")){var d="",d="ws"===a._options.protocol&&"https:"!==window.location.protocol?d+"ws":d+"wss",d=d+("://"+window.location.host),d=0!==b.indexOf("/")?d+(window.location.pathname+b):d+b;a.service=d}};
Strophe.Websocket.prototype={_buildStream:function(){return $build("stream:stream",{to:this._conn.domain,xmlns:Strophe.NS.CLIENT,"xmlns:stream":Strophe.NS.STREAM,version:"1.0"})},_check_streamerror:function(a,b){var d=a.getElementsByTagName("stream:error");if(0===d.length)return!1;var d=d[0],f="",h="";ns="urn:ietf:params:xml:ns:xmpp-streams";for(i=0;i<d.childNodes.length;i++){e=d.childNodes[i];if(e.getAttribute("xmlns")!==ns)break;"text"===e.nodeName?h=e.textContent:f=e.nodeName}errorString="WebSocket stream error: ";
errorString=f?errorString+f:errorString+"unknown";h&&(errorString+=" - "+f);Strophe.error(errorString);this._conn._changeConnectStatus(b,f);this._conn._doDisconnect();return!0},_reset:function(){},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(a){if(this._check_streamerror(a,
Strophe.Status.CONNFAIL))return Strophe.Status.CONNFAIL},_handleStreamStart:function(a){var b=!1,d=a.getAttribute("xmlns");"string"!==typeof d?b="Missing xmlns in stream:stream":d!==Strophe.NS.CLIENT&&(b="Wrong xmlns in stream:stream: "+d);d=a.namespaceURI;"string"!==typeof d?b="Missing xmlns:stream in stream:stream":d!==Strophe.NS.STREAM&&(b="Wrong xmlns:stream in stream:stream: "+d);a=a.getAttribute("version");"string"!==typeof a?b="Missing version in stream:stream":"1.0"!==a&&(b="Wrong version in stream:stream: "+
a);return b?(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,b),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(a){if(0===a.data.indexOf("<stream:stream ")||0===a.data.indexOf("<?xml")){var b=a.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==b&&(b=a.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>"),b=(new DOMParser).parseFromString(b,"text/xml").documentElement,this._conn.xmlInput(b),this._conn.rawInput(a.data),this._handleStreamStart(b)&&(this._connect_cb(b),this.streamStart=
a.data.replace(/^<stream:(.*)\/>$/,"<stream:$1>")))}else"</stream:stream>"===a.data?(this._conn.rawInput(a.data),this._conn.xmlInput(document.createElement("stream:stream")),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,error),this._conn._doDisconnect()):(b=this._streamWrap(a.data),b=(new DOMParser).parseFromString(b,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(b,null,a.data))},_disconnect:function(a){if(this.socket.readyState!==WebSocket.CLOSED){a&&
this._conn.send(a);this._conn.xmlOutput(document.createElement("stream:stream"));this._conn.rawOutput("</stream:stream>");try{this.socket.send("</stream:stream>")}catch(b){Strophe.info("Couldn't send closing stream tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){Strophe.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(a){return this.streamStart+a+"</stream:stream>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(a){}this.socket=
null},_emptyQueue:function(){return!0},_onClose:function(a){this._conn.connected&&!this._conn.disconnecting?(Strophe.error("Websocket closed unexcectedly"),this._conn._doDisconnect()):Strophe.info("Websocket closed")},_no_auth_received:function(a){Strophe.error("Server did not send any auth methods");this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Server did not send any auth methods");a&&(a=a.bind(this._conn),a());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_onError:function(a){Strophe.error("Websocket error "+
a);this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established was disconnected.");this._disconnect()},_onIdle:function(){var a=this._conn._data;if(0<a.length&&!this._conn.paused){for(i=0;i<a.length;i++)if(null!==a[i]){var b,d;"restart"===a[i]?(b=this._buildStream(),d=this._removeClosingTag(b),b=b.tree()):(b=a[i],d=Strophe.serialize(b));this._conn.xmlOutput(b);this._conn.rawOutput(d);this.socket.send(d)}this._conn._data=[]}},_onMessage:function(a){var b;
if("</stream:stream>"===a.data)this._conn.rawInput("</stream:stream>"),this._conn.xmlInput(document.createElement("stream:stream")),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===a.data.search("<stream:stream ")){if(data=a.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>"),b=(new DOMParser).parseFromString(data,"text/xml").documentElement,!this._handleStreamStart(b))return}else data=this._streamWrap(a.data),b=(new DOMParser).parseFromString(data,"text/xml").documentElement;
this._check_streamerror(b,Strophe.Status.ERROR)||(this._conn.disconnecting&&"presence"===b.firstChild.nodeName&&"unavailable"===b.firstChild.getAttribute("type")?(this._conn.xmlInput(b),this._conn.rawInput(Strophe.serialize(b))):this._conn._dataRecv(b,a.data))}},_onOpen:function(){Strophe.info("Websocket open");var a=this._buildStream();this._conn.xmlOutput(a.tree());a=this._removeClosingTag(a);this._conn.rawOutput(a);this.socket.send(a)},_removeClosingTag:function(a){a=Strophe.serialize(a);return a=
a.replace(/<(stream:stream .*[^\/])\/>$/,"<$1>")},_reqToData:function(a){return a},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(a){this._connection=a;this._identities=[];this._features=[];this._items=[];a.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);a.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(a,b,d,f){for(var h=0;h<this._identities.length;h++)if(this._identities[h].category==a&&this._identities[h].type==b&&this._identities[h].name==
d&&this._identities[h].lang==f)return!1;this._identities.push({category:a,type:b,name:d,lang:f});return!0},addFeature:function(a){for(var b=0;b<this._features.length;b++)if(this._features[b]==a)return!1;this._features.push(a);return!0},addItem:function(a,b,d,f){if(d&&!f)return!1;this._items.push({jid:a,name:b,node:d,call_back:f});return!0},info:function(a,b,d,f){var h={xmlns:Strophe.NS.DISCO_INFO};b&&(h.node=b);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",h);this._connection.sendIQ(a,
d,f)},items:function(a,b,d,f){var h={xmlns:Strophe.NS.DISCO_ITEMS};b&&(h.node=b);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",h);this._connection.sendIQ(a,d,f)},_onDiscoInfo:function(a){var b=a.getAttribute("id"),d=a.getAttribute("from"),f=a.getElementsByTagName("query")[0].getAttribute("node");a={xmlns:Strophe.NS.DISCO_INFO};f&&(a.node=f);b=$iq({type:"result",id:b,to:d}).c("query",a);for(d=0;d<this._identities.length;d++)a={category:this._identities[d].category,type:this._identities[d].type},
this._identities[d].name&&(a.name=this._identities[d].name),this._identities[d].lang&&(a["xml:lang"]=this._identities[d].lang),b.c("identity",a).up();for(d=0;d<this._features.length;d++)b.c("feature",{"var":this._features[d]}).up();this._connection.send(b.tree())},_onDiscoItems:function(a){var b=a.getAttribute("id"),d=a.getAttribute("from"),f={xmlns:Strophe.NS.DISCO_ITEMS},h=a.getElementsByTagName("query")[0].getAttribute("node");if(h){f.node=h;for(var g=null,l=0;l<this._items.length;l++)if(this._items[l].node==
h){g=this._items[l].call_back(a);break}}else g=this._items;a=$iq({type:"result",id:b,to:d}).c("query",f);for(l=0;l<g.length;l++)b={jid:g[l].jid},g[l].name&&(b.name=g[l].name),g[l].node&&(b.node=g[l].node),a.c("item",b).up();this._connection.send(a.tree())}});Ext.ns("Application");
Application.LoginWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{html:'<img src="../images/nws.png" width="100"/>',height:105,width:105},{xtype:"panel",autoShow:!0,el:"myloginform",layout:"form",id:"myform",width:276,labelWidth:76,defaultType:"textfield",defaults:{allowBlank:!1},items:[{anchor:"100%",el:"username",id:"username",autoShow:!0,fieldLabel:"Username"},{anchor:"100%",el:"password",id:"password",autoShow:!0,fieldLabel:"Password",listeners:{specialkey:function(a,b){b.getKey()===
b.ENTER&&(Application.doLogin(),b.stopEvent())}}}],buttons:[{text:"Show Debug",handler:function(){Ext.getCmp("debug").show()}},{text:"Browser Save Login",handler:function(a,b){Ext.get("submit").dom.click()}},{text:"Login",handler:Application.doLogin}]},{xtype:"panel",colspan:2,contentEl:"loginmessage",preventBodyReset:!0}];Ext.apply(this,Ext.apply(this.initialConfig,{width:420,height:250,autoScroll:!0,modal:!0,closable:!1,title:"NWSChat Live Login",layout:"table",layoutConfig:{columns:2}}));Application.LoginWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.insertFirst(this.items.items[2].body,{msg:a,date:new Date})}});Ext.ns("Application");
Application.DebugWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{xtype:"panel",title:"Debug Log",html:"<p>Browser CodeName: "+navigator.appCodeName+"</p><p>Browser Name: "+navigator.appName+"</p><p>Browser Version: "+navigator.appVersion+"</p><p>Cookies Enabled: "+navigator.cookieEnabled+"</p><p>Platform: "+navigator.platform+"</p><p>User-agent header: "+navigator.userAgent+"</p>",autoScroll:!0}];this.tbar=[{text:"Click to send this log to developer!",icon:"icons/print.png",handler:function(){Ext.Ajax.request({url:"bug.php",
method:"POST",success:function(a){alert(a.responseText)},failure:function(){},headers:{"my-header":"foo"},params:{data:Application.DebugWindow.items.items[0].body.dom.innerHTML,user:Application.USERNAME}})}},{text:"Clear Log",icon:"icons/close.png",handler:function(){this.items.items[0].update("")},scope:this}];Ext.apply(this,Ext.apply(this.initialConfig,{width:600,height:300,title:"Debug Window",closeAction:"hide",hidden:!0,autoScroll:!0,layout:"fit"}));Application.DebugWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.insertFirst(this.items.items[0].body,{msg:a,date:new Date})}});Ext.ns("Application");
Application.MUCChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",chatType:"groupchat",barejid:null,handle:null,anonymous:null,joinedChat:!1,initComponent:function(){this.items=[{xtype:"chatgridpanel",region:"center"},{xtype:"chattextentry",region:"south",height:50,split:!0}];"allchats"!=this.initialConfig.chatType?(this.items.push({xtype:"mucroomusers",region:"east",width:175,collapsible:!0,split:!0}),this.iconCls="tabno"):this.items[1].emptyText="Type message here";Ext.apply(this,
Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.iconCls&&a.setIconCls("tabno")},deactivate:function(a){a.iconCls&&a.setIconCls("tabno")}}}));Application.MUCChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},clearRoom:function(){this.gp.getStore().removeAll();this.roomusers.root.removeAll()},getJidByHandle:function(a){a=this.roomusers.root.findChild("text",a);return null==a||Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPMUCHOST?null:a.attributes.jid},
buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];if("allchats"==this.chatType)this.gp.toolbars[0].items.items[4].disable(),this.gp.soundOn=!1,this.te.items.items[1].setText("To Room?");else{this.roomusers=this.items.items[2];new Ext.tree.TreeSorter(this.roomusers,{folderSort:!0,dir:"asc",property:"text"});this.anonymous&&this.te.disable();var a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::mute";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[4].toggle(!0,
!0),this.gp.toolbars[0].items.items[4].setText("Sounds Muted"),this.gp.soundOn=!1);a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::nwsbothidden";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[3].toggle(!0,!0),this.gp.toolbars[0].items.items[3].setText("NWSBot Hidden"),this.gp.store.filterBy(nwsbotFilter))}}});Ext.reg("mucchatpanel",Application.MUCChatPanel);Ext.ns("Application");
Application.MUCRoomUsers=Ext.extend(Ext.tree.TreePanel,{bodyStyle:{"margin-left":"-15px"},title:"0 people in room",rootVisible:!1,lines:!1,autoScroll:!0,initComponent:function(){this.root={text:"test",listeners:{append:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")},remove:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")}}};var a={plugins:new Ext.ux.DataTip({tpl:"<div>JID: {jid}<br />Affiliation: {affiliation}<br />Role: {role}</div>",constrainPosition:!0}),
listeners:{click:function(a){if(a.attributes.jid&&(username=Strophe.getNodeFromJid(a.attributes.jid),username!=Application.USERNAME)){var d=a.attributes.jid;Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPHOST&&(d=Strophe.getBareJidFromJid(a.attributes.jid));Application.log("Wish to start chat with:"+d);(cp=Ext.getCmp("chatpanel").getChat(d))||(cp=Ext.getCmp("chatpanel").addChat(d));Ext.getCmp("chatpanel").setActiveTab(cp)}}}};Ext.apply(this,Ext.apply(this.initialConfig,a));Application.MUCRoomUsers.superclass.initComponent.apply(this,
arguments);this.buildItems()},buildItems:function(){}});Ext.reg("mucroomusers",Application.MUCRoomUsers);Ext.ns("Application");Application.colors="000000 666666 D51460 FF0000 993333 FF9900 005500 009900 00DD00 0066CC 3399FF 0000FF 6666FF".split(" ");Application.colorpointer=0;Application.UserColorStore=new Ext.data.Store({fields:["user","color"]});
Application.getUserColor=function(a){idx=Application.UserColorStore.find("user",a);-1==idx?(c=Application.colors[Application.colorpointer],Application.UserColorStore.add(new Ext.data.Record({user:a,color:c})),Application.colorpointer++,12<Application.colorpointer&&(Application.colorpointer=0)):c=Application.UserColorStore.getAt(idx).get("color");return c};Ext.ns("Application");
Application.msgFormatter=new Ext.XTemplate('<p class="mymessage">',"<span ",'<tpl if="values.me == values.author">','class="author-me"',"</tpl>",'<tpl if="values.me != values.author">','class="{[this.getAuthorClass(values.jid)]}" style="color: #{[Application.getUserColor(values.author)]};"',"</tpl>",">(",'<tpl if="this.isNotToday(ts)">','{ts:date("d M")} ',"</tpl>",'{ts:date("g:i A")}) ','<tpl if="values.room != null">',"[{room}] ","</tpl>","{author}:</span> ","{message}</p>",{isNotToday:function(a){return(new Date).format("md")!=
a.format("md")},getAuthorClass:function(a){return null==a?"author-default":"nwsbot"==Strophe.getNodeFromJid(a)?"author-nwsbot":Strophe.getNodeFromJid(a).match(/^nws/)?"author-nws":"author-chatpartner"}});
Application.ChatGridPanel=Ext.extend(Ext.grid.GridPanel,{region:"center",soundOn:!0,nwsbotHide:!1,stripeRows:!0,autoExpandColumn:"message",autoScroll:!0,tbar:[{text:"Clear Room Log",cls:"x-btn-text-icon",icon:"icons/close.png",handler:function(a,b){a.ownerCt.ownerCt.getStore().removeAll()}},{text:"Print Log",icon:"icons/print.png",cls:"x-btn-text-icon",handler:function(a,b){a.ownerCt.ownerCt.getGridEl().print({isGrid:!0})}},{text:"View As HTML",handler:function(a,b){showHtmlVersion(a.ownerCt.ownerCt)},
icon:"icons/text.png",cls:"x-btn-text-icon"},{text:"Hide NWSBot",enableToggle:!0,toggleHandler:function(a,b){var d="muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::nwsbothidden",f=a.ownerCt.ownerCt.getStore();(a.ownerCt.ownerCt.nwsbotHide=b)?(Application.setPreference(d,"true"),f.filterBy(nwsbotFilter),a.setText("NWSBot Hidden")):(Application.removePreference(d),f.clearFilter(!1),a.setText("Hide NWSBot"))}},{text:"Mute Sounds",enableToggle:!0,toggleHandler:function(a,b){var d=
"muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::mute";b?(Application.setPreference(d,"true"),a.ownerCt.ownerCt.soundOn=!1,a.setText("Sounds Muted")):(Application.removePreference(d),a.ownerCt.ownerCt.soundOn=!0,a.setText("Mute Sounds"))}},{icon:"icons/font-less.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))-2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message",
"font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}},{icon:"icons/font-more.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))+2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}}],initComponent:function(){this.columns=[{header:"Author",sortable:!0,dataIndex:"author",hidden:!0},{id:"message",
header:"Message",sortable:!0,dataIndex:"ts",scope:this,renderer:function(a,d,f){return Application.msgFormatter.apply({author:f.get("author"),message:f.get("message"),ts:f.get("ts"),room:f.get("room"),jid:f.get("jid"),me:this.ownerCt.handle})}}];this.store=new Ext.data.ArrayStore({sortInfo:{field:"ts",direction:"ASC"},fields:[{name:"ts",type:"date"},"author","message","product_id","jid","room",{name:"xdelay",type:"boolean"}]});this.store.on("add",function(a,d,f){if(!this.soundOn)return!0;a=!1;f=!0;
for(var h=0;h<d.length;h++)d[h].get("xdelay")||d[h].get("author")==this.ownerCt.handle||("nwsbot"!=d[h].get("author")&&(a=!0),d[h].get("message").match(/tornado/i)&&Application.MsgBus.fireEvent("soundevent","tornado"),d[h].get("message").match(this.ownerCt.handle)&&Application.MsgBus.fireEvent("soundevent","myhandle"),f=!1);if(f)return!0;a?(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent","new_message")):this.nwsbotHide||(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent",
"nwsbot"))},this);var a={viewConfig:{onAdd:function(a,d,f){this.constructor.prototype.onAdd.apply(this,arguments);(row=this.grid.getView().getRow(f))&&row.scrollIntoView()},templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}"  tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},sm:new Ext.grid.RowSelectionModel({listeners:{rowselect:function(a,d,f){f.data.product_id&&(Application.TextWindow.show(),
Application.TextWindow.load({params:{pid:f.data.product_id,bypass:1},text:"Loading...",method:"GET",url:"../p.php"}))}}}),listeners:{render:function(a){a.getView().mainBody.on("mousedown",function(a,b){"A"==b.tagName&&(a.stopEvent(),b.target="_blank")});a.body.on({mousedown:function(a,b){b.target="_blank";Application.TextWindow.hide()},click:function(a,b){"_blank"!=String(b.target).toLowerCase()&&(a.stopEvent(),window.open(b.href));Application.TextWindow.hide()},delegate:"a"})}}};Ext.apply(this,a);
Application.ChatGridPanel.superclass.initComponent.apply(this,arguments)}});Ext.reg("chatgridpanel",Application.ChatGridPanel);Ext.ns("Application");
Application.ChatTextEntry=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},border:!1,chatstate:null,initComponent:function(){this.items=[{xtype:"textarea",flex:1,cls:"message-entry-box",autoCreate:{tag:"textarea",style:'rows:10;cols:72;wrap:"hard";',autocomplete:"off"},style:{background:"#"+Application.getPreference("bgcolor","FFFFFF"),color:"#"+Application.getPreference("fgcolor","000000")},enableKeyEvents:!0,listeners:{keyup:function(a,b){if(b.getKey()===b.ENTER&&!b.shiftKey)return this.chatstate&&
this.chatstate.cancel(),this.chatstate=null,this.ownerCt.getComponent(1).handler(),!0;"chat"==this.ownerCt.ownerCt.chatType&&(this.chatstate||(this.chatstate=new Ext.util.DelayedTask(function(){this.ownerCt&&this.ownerCt.ownerCt&&(Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("paused",{xmlns:"http://jabber.org/protocol/chatstates"})),this.chatstate=null)},this),Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}))),this.chatstate.delay(5E3))},render:{delay:500,fn:function(){this.focus()}}}},{xtype:"button",text:"Send",width:60,popup:null,handler:function(){var a=this.ownerCt.getComponent(0),b=a.getValue().trim();if(0===b.length)return a.focus(),!1;var d=Application.getPreference("bgcolor","FFFFFF"),f=Application.getPreference("fgcolor","000000");if(null==this.ownerCt.ownerCt.barejid)a.emptyText="",a.setValue(""),(new Application.AllChatMessageWindow({message:Application.replaceURLWithHTMLLinks(b)})).show();
else{for(var h=$.parseHTML(Application.replaceURLWithHTMLLinks(b)),g=$msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("active",{xmlns:"http://jabber.org/protocol/chatstates"}).up().c("body").t(b).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+f+";background:#"+d+";"}),l=0;l<h.length;l++)g=g.cnode(h[l]),l<h.length&&(g=g.up());Application.XMPPConn.send(g);a.setValue("");a.focus();
"chat"==this.ownerCt.ownerCt.chatType&&(b="<span style='color:#"+f+";background:#"+d+";'>"+b+"</span>",this.ownerCt.ownerCt.gp.getStore().addSorted(new Ext.data.Record({ts:new Date,author:Application.USERNAME,message:Application.replaceURLWithHTMLLinks(b)})))}}}];Application.ChatTextEntry.superclass.initComponent.apply(this,arguments)}});Ext.reg("chattextentry",Application.ChatTextEntry);Ext.ns("Application");
Application.ChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",iconCls:"tabno",chatType:"chat",barejid:null,handle:null,anonymous:null,initComponent:function(){this.items=[new Application.ChatGridPanel({region:"center"}),new Application.ChatTextEntry({region:"south",height:50,split:!0})];Ext.apply(this,Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.setIconCls("tabno")},deactivate:function(a){a.setIconCls("tabno")},beforedestroy:function(a){a.te.chatstate&&a.te.chatstate.cancel();
Application.XMPPConn.send($msg({to:a.barejid,type:a.chatType}).c("gone",{xmlns:"http://jabber.org/protocol/chatstates"}))}}}));Application.ChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},getJidByHandle:function(a){return this.barejid},buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3]);this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3])}});
Ext.reg("chatpanel",Application.ChatPanel);Ext.ns("Application");
Application.LiveViewport=Ext.extend(Ext.Viewport,{layout:"border",initComponent:function(){var a={xtype:"panel",region:"north",height:10,hidden:!0,title:"Google Map Disabled by URL"};this.initialConfig.enableMap&&(a={xtype:"panel",layout:"border",region:"north",collapsible:!0,title:"Google Map Panel",height:300,split:!0,items:[Application.MapPanel,Application.LayerTree]});this.items=[Application.Control,{xtype:"panel",region:"center",layout:"border",items:[a,new Application.ChatTabPanel({id:"chatpanel",region:"center",
split:!0})]}];Application.LiveViewport.superclass.initComponent.call(this)}});Ext.ns("Application");Application.MapLegend=Ext.extend(Ext.Window,{width:300,height:200,autoScroll:!0,title:"Map Legends",hidden:!0,autoScroll:!0,closeAction:"hide",initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.MapLegend.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){}});Ext.ns("Ext.ux.grid");Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(a,b,d,f,h){if("mousedown"==a){var g=d.store.getAt(f);g.set(this.dataIndex,!g.data[this.dataIndex]);return!1}return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments)},renderer:function(a,b,d){b.css+=" x-grid3-check-col-td";return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',a?"-on":"")},init:Ext.emptyFn});Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn);
Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function a(){var a=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(a);this.dataTip.initTarget(a)}function b(a,b){a.rendered?a.update(b):Ext.isString(b)?a.html=b:a.data=b}function d(a){var d=Ext.fly(a.triggerElement).findParent("div.x-tree-node-el",null,!0);if(d=d?a.host.getNodeById(d.getAttribute("tree-node-id","ext")):null)b(a,d.attributes);else return!1}function f(a){var d=this.host.getStore().getAt(this.host.getView().findRowIndex(a.triggerElement));
if(d)b(a,d.data);else return!1}function h(a){var d=this.host.getRecord(a.triggerElement);if(d)b(a,d.data);else return!1}function g(a){var d=Ext.fly(a.triggerElement).child("input,textarea");if((d=d?this.host.getForm().findField(d.id):null)&&(d.tooltip||a.tpl))b(a,d.tooltip||d);else return!1}function l(a){var d=this.host.store.getAt(this.host.selectedIndex);if(d)b(a,d.data);else return!1}return{init:function(b){b.dataTip=this;this.host=b;b instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||
"div.x-tree-node-el",this.on("beforeshow",d)):b instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||b.getView().rowSelector,this.on("beforeshow",f)):b instanceof Ext.DataView?(this.delegate=this.delegate||b.itemSelector,this.on("beforeshow",h)):b instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",g)):b instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||b.itemSelector,this.on("beforeshow",l));b.rendered?a.call(b):b.onRender=b.onRender.createSequence(a)}}}());Ext.ns("Application");
function onBuddyPresence(a){var b=a.getAttribute("from"),d=Strophe.getBareJidFromJid(b),f=Strophe.getResourceFromJid(b),h=Strophe.getNodeFromJid(b),g="Available";h==Application.USERNAME&&f!=Application.XMPPRESOURCE&&f.match(/^NWSChatLive/)&&("unavailable"==a.getAttribute("type")?Application.log("Self presence: ["+h+"] ["+f+"] unavailable"):(Application.log("Self presence: ["+h+"] ["+f+"] available"),Application.AUTOJOIN&&(Ext.Msg.alert("Warning","The chat server indicated you have another NWSChatLive session ["+f+
"] active. Disabling auto-joined chatrooms."),Application.AUTOJOIN=!1)));0<$(a).find("status").length&&(g=$(a).find("status").text());"subscribe"==a.getAttribute("type")?Ext.Msg.show({title:"New Buddy Request",msg:"NWSChat user "+h+" wishes to add you as a buddy. Is this okay?",buttons:Ext.Msg.YESNO,fn:function(a){"yes"==a?(a=$pres({to:b,type:"subscribed"}),Application.XMPPConn.send(a.tree()),Application.buildAddBuddy(h,h,"Buddies")):(a=$pres({to:b,type:"unsubscribed"}),Application.XMPPConn.send(a.tree()))},
icon:Ext.MessageBox.QUESTION}):Ext.getCmp("buddies").root.eachChild(function(b){b.eachChild(function(b){b.attributes.barejid==d&&(((res=b.attributes.resources.get(f))||b.attributes.resources.add(f,{status:g,resource:f}),a.getAttribute("type"))?"unavailable"==a.getAttribute("type")&&(1==b.attributes.resources.length&&(b.attributes.presence="offline",b.setIconCls("buddy-offline"),b.ui.hide()),b.attributes.resources.remove(f)):(0<$(a).find("show").length?b.setIconCls("buddy-away"):b.setIconCls("buddy-online"),
b.attributes.presence="online",b.ui.show(),b.attributes.resources.replace(f,{status:g,resource:f})))})})};Ext.ns("Application");
Application.AllChatMessageWindow=Ext.extend(Ext.Window,{title:"Where to send this message?",width:460,height:300,modal:!0,layout:"form",layoutConfig:{},defaults:{width:450},initComponent:function(){this.buttons=[{text:"Send Message",scope:this,handler:function(){var a=this.find("name","columns")[0];Ext.each(a.findByType("checkbox"),function(a){a.checked&&Application.XMPPConn.send($msg({to:a.name+"@"+Application.XMPPMUCHOST,type:"groupchat"}).c("body").t(this.message).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",
{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+Application.getPreference("fgcolor","000000")+";background:#"+Application.getPreference("bgcolor","FFFFFF")+";"}).t(this.message))},this);this.close()}},{text:"Cancel",handler:function(){this.ownerCt.ownerCt.close()}}];Application.AllChatMessageWindow.superclass.initComponent.apply(this,arguments);this.buildItems(this.message);this.addAvailableRooms()},addAvailableRooms:function(){Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==
a.chatType&&!a.anonymous&&(a=Strophe.getNodeFromJid(a.barejid),0==this.items.items[1].find("name",a).length)){var b=this.find("name","columns")[0];pos=b.entries%3;b.items.items[pos].add({xtype:"checkbox",hideLabel:!0,boxLabel:a,name:a});b.entries+=1}},this)},buildItems:function(a){this.add({xtype:"textarea",hideLabel:!0,html:a});this.add({xtype:"fieldset",title:"Send my message to the following room(s):",autoHeight:!0,autoScroll:!0,items:[{entries:0,name:"columns",layout:"table",items:[{layout:"form",
border:!1,colname:"col1",width:140,items:[]},{layout:"form",border:!1,colname:"col2",width:140,items:[]},{width:140,border:!1,colname:"col3",layout:"form",items:[]}]}]})}});/*
 Licensed under the terms of the Open Source <a href="http://www.gnu.org/licenses/lgpl.html">LGPL 3.0 license</a>. Commercial use is permitted to the extent that the code/component(s) do NOT become part of another Open Source or Commercially licensed development library or toolkit without explicit permission.
 @version 2.0.0 (Feb 14, 2010)
*/
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel=Ext.extend(Ext.TabPanel,{arrowOffsetX:-9,arrowOffsetY:-8,initComponent:function(){Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);this.addEvents("reorder");this.ddGroupId||(this.ddGroupId="dd-tabpanel-group-"+Ext.ux.panel.DDTabPanel.superclass.getId.call(this))},reorder:function(a){this.fireEvent("reorder",this,a)},afterRender:function(){Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);this.arrow=Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>',
!0);this.arrow.hide();this.dd=new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup:this.ddGroupId});this.move=!1},initTab:function(a,b){Ext.ux.panel.DDTabPanel.superclass.initTab.call(this,a,b);var d=this.id+"__"+a.id;Ext.fly(d).on("click",function(){a.ownerCt.setActiveTab(a.id)});Ext.applyIf(a,{allowDrag:!0});Ext.apply(a,{ds:new Ext.dd.DragSource(d,{ddGroup:this.ddGroupId,dropEl:a,dropElHeader:Ext.get(d,!0),scroll:!1,onStartDrag:function(){if(this.dropEl.iconCls){var a=this.getProxy().getGhost().select(".x-tab-strip-text");
a.addClass("x-panel-inline-icon");var b=a.elements[0].innerHTML,b=Ext.util.Format.stripTags(b);a.elements[0].innerHTML=b;a.applyStyles({paddingLeft:"20px"})}},onMouseUp:function(a){this.dropEl.ownerCt.move?(this.dropEl.disabled||null!=this.dropEl.ownerCt.activeTab||this.dropEl.ownerCt.setActiveTab(this.dropEl),this.dropEl.ownerCt.move=!1):this.dropEl.isVisible()||this.dropEl.disabled||this.dropEl.show()}}),enableTabDrag:function(){this.allowDrag=!0;return this.ds.unlock()},disableTabDrag:function(){this.allowDrag=
!1;return this.ds.lock()}});a.allowDrag?a.enableTabDrag():a.disableTabDrag()},onRemove:function(a){var b=Ext.get(a.tabEl);b&&(b.select("a").removeAllListeners(),Ext.destroy(b));Ext.TabPanel.superclass.onRemove.call(this,a);this.stack.remove(a);delete a.tabEl;a.un("disable",this.onItemDisabled,this);a.un("enable",this.onItemEnabled,this);a.un("titlechange",this.onItemTitleChanged,this);a.un("iconchange",this.onItemIconChanged,this);a.un("beforeshow",this.onBeforeShowItem,this);a==this.activeTab&&(this.move?
this.activeTab=null:(a=this.stack.next())?this.setActiveTab(a):0<this.items.getCount()?this.setActiveTab(0):this.activeTab=null);this.destroying||this.delegateUpdates()},onDestroy:function(){Ext.destroy(this.dd,this.arrow);Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)}});
Ext.ux.panel.DDTabPanel.DropTarget=Ext.extend(Ext.dd.DropTarget,{constructor:function(a,b){this.tabpanel=a;Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(this,a.stripWrap,b)},notifyOver:function(a,b,d){var f=this.tabpanel.items,h=f.length;if(!b.within(this.getEl())||a.dropEl==this.tabpanel)return"x-dd-drop-nodrop";d=this.tabpanel.arrow;var g=this.el.getY(),l,n,r;b=b.getPageX();for(var m=0;m<h;m++){n=r;r=f.itemAt(m);var w=r.ds.dropElHeader,u=w.getX();if(b<=u+w.dom.clientWidth/2){l=
u;break}}if("undefined"==typeof l){l=f.itemAt(h-1);if(l==a.dropEl)return"x-dd-drop-nodrop";a=l.ds.dropElHeader.dom;l=(new Ext.Element(a)).getX()+a.clientWidth+3}else if(r==a.dropEl||n==a.dropEl)return this.tabpanel.arrow.hide(),"x-dd-drop-nodrop";d.setTop(g+this.tabpanel.arrowOffsetY).setLeft(l+this.tabpanel.arrowOffsetX).show();return"x-dd-drop-ok"},notifyDrop:function(a,b,d){this.tabpanel.arrow.hide();if(a.dropEl==this.tabpanel)return!1;d=this.tabpanel.items;var f=b.getPageX();for(b=0;b<d.length;b++){var h=
d.itemAt(b),g=h.ds.dropElHeader,g=g.getX()+g.dom.clientWidth/2;if(f<=g)break}if(h==a.dropEl||d.itemAt(b-1)==a.dropEl)return!1;a.proxy.hide();a.dropEl.ownerCt==this.tabpanel&&b>d.indexOf(a.dropEl)&&b--;this.tabpanel.move=!0;a=a.dropEl.ownerCt.remove(a.dropEl,!1);this.tabpanel.insert(b,a);this.tabpanel.fireEvent("drop",this.tabpanel);this.tabpanel.reorder(d.itemAt(b));return!0},notifyOut:function(a,b,d){this.tabpanel.arrow.hide()}});Ext.reg("ddtabpanel",Ext.ux.panel.DDTabPanel);Ext.ns("Application");
Application.ChatTabPanel=Ext.extend(Ext.ux.panel.DDTabPanel,{activeTab:0,deferredRender:!1,split:!0,enableTabScroll:!0,initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.ChatTabPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){this.add({contentEl:"help",title:"Help",preventBodyReset:!0,style:{margin:"5px"},autoScroll:!0});this.add(new Application.MUCChatPanel({title:"All Chats",closable:!1,chatType:"allchats",barejid:"__allchats__@"+
Application.XMPPMUCHOST,id:"__allchats__"}))},addMUC:function(a,b,d){a=new Application.MUCChatPanel({title:Strophe.getNodeFromJid(a),barejid:a,handle:b,anonymous:d});return this.add(a)},getMUC:function(a){return this.find("barejid",a)[0]},removeMUC:function(a){this.remove(this.getMUC(a))},addChat:function(a){var b=Strophe.getNodeFromJid(a);Strophe.getDomainFromJid(a)==Application.XMPPMUCHOST&&(b=Strophe.getResourceFromJid(a));a=new Application.ChatPanel({title:b,handle:Application.USERNAME,barejid:a});
return this.add(a)},getChat:function(a){return this.find("barejid",a)[0]},removeChat:function(a){this.remove(this.getChat(a))}});Ext.reg("chattabpanel",Application.ChatTabPanel);Ext.ns("Application");function nwsbotFilter(a,b){return"nwsbot"==a.get("author")?!1:!0}
function grid2html(a){var b=a.getStore();a=a.ownerCt.title;t="<html><head></head><body>";t+="<table cellpadding='2' cellspacing='0' border='1'><tr><th>Roomname</th><th>Date</th><th>Author</th><th>Message</th></tr>";for(var d=0;d<b.getCount();d++)row=b.getAt(d),t+=String.format("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>\r\n",row.get("roomname")||a,row.get("ts").format("Y/m/d g:i A"),row.get("author"),row.get("message"));return t+="</table></body></html>"}
function htmlExport(a){Ext.isIE6||Ext.isIE7||Ext.isSafari||Ext.isSafari2||Ext.isSafari3?Ext.Msg.alert("Status","Sorry, this tool does not work with this browser."):(t=grid2html(a),document.location="data:plain/html;base64,"+encode64(t))}function showHtmlVersion(a){(new Ext.Window({title:"Text Version",closable:!0,width:600,height:350,plain:!0,autoScroll:!0,html:grid2html(a)})).show()}
var LinkInterceptor={render:function(a){a.body.on({mousedown:function(a,d){d.target="_blank";Application.TextWindow.hide()},click:function(a,d){"_blank"!=String(d.target).toLowerCase()&&(a.stopEvent(),window.open(d.href));Application.TextWindow.hide()},delegate:"a"})}};Ext.ns("Application");Application.saveViews=function(){for(var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}),b=1;6>b;b++)(bnds=Ext.getCmp("mfv"+b).bounds)&&a.c("view",{label:Ext.getCmp("mfv"+b).getValue(),bounds:bnds.left+","+bnds.bottom+","+bnds.right+","+bnds.top}).up();Application.XMPPConn.sendIQ(a.tree())};Ext.util.Format.comboRenderer=function(a){return function(b){return(b=a.findRecord(a.valueField,b))?b.get(a.displayField):a.valueNotFoundText}};
Application.SoundStore=new Ext.data.ArrayStore({fields:["id","label","src"],data:[["default","Default","sounds/message_new.mp3"],["bleep","Bleep","sounds/bleep.mp3"],["cow","Cow (Mooo!)","sounds/cow.mp3"],["doorbell","Door Bell","sounds/doorbell.mp3"],["eas","EAS Beep","sounds/eas.mp3"],["elevator","Elevator","sounds/elevator.mp3"]]});
var combo=new Ext.form.ComboBox({typeAhead:!1,triggerAction:"all",lazyRender:!0,mode:"local",store:Application.SoundStore,listeners:{change:function(a,b,d){Application.playSound(b)}},valueField:"id",displayField:"label"});
Application.soundPrefs=new Ext.Window({title:"Sound Preferences",width:500,height:300,closeAction:"hide",layout:"form",buttons:[{text:"Save Sound Settings",handler:function(){Ext.getCmp("soundpanel").getStore().each(function(a){eidx=a.get("id");Application.setPreference("sound::"+eidx+"::enabled",a.get("enabled")?"true":"false");Application.setPreference("sound::"+eidx+"::sound",a.get("sound"))});Application.soundPrefs.hide();Application.syncPreferences()}}],items:[{xtype:"slider",id:"volume",minValue:0,
maxValue:100,value:50,width:200,listeners:{changecomplete:function(a,b,d){Application.setPreference("volume",b);Application.MsgBus.fireEvent("soundevent","default")}},fieldLabel:"Volume"},new Ext.grid.EditorGridPanel({store:new Ext.data.ArrayStore({data:[["new_message","New Message (Non NWSBot)",!0,"default"],["new_conversation","New Conversation",!0,"doorbell"],["nwsbot","NWSBot Message",!0,"default"],["myhandle","Message with your name in it",!0,"bleep"],["tornado",'Message with "Tornado" within text',
!0,"eas"]],fields:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"enabled",type:"bool"},{name:"sound",type:"string"}],sortInfo:{field:"label",direction:"ASC"}}),cm:new Ext.grid.ColumnModel({columns:[{dataIndex:"enabled",id:"enabled",header:"Enable",xtype:"checkcolumn"},{dataIndex:"label",id:"label",sortable:!0,header:"Event Type"},{dataIndex:"sound",id:"sound",header:"Sound",renderer:Ext.util.Format.comboRenderer(combo),editor:combo}]}),id:"soundpanel",title:"Sound Events",frame:!0,
clicksToEdit:1,stripeRows:!0,autoExpandColumn:"label",height:200,autoScroll:!0})]});
Application.boundsFavorites=new Ext.Window({title:"Map View Favorites",width:500,height:300,closeAction:"hide",layout:"table",layoutConfig:{columns:4},autoScroll:!0,buttons:[{text:"Save Settings",handler:function(){for(var a=1;6>a;a++)nval=Ext.getCmp("mfv"+a).getValue(),""!=nval&&Ext.getCmp("fm"+a).setText(nval);Application.boundsFavorites.hide()}}],items:[{html:"This form allows you to modify the 5 allowed map extent favorites. The first favorite will be your default view when you log in and for the star icon above.",colspan:4},
{html:"#1"},{xtype:"textfield",id:"mfv1",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv1").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv1").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#2"},{xtype:"textfield",id:"mfv2",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv2").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv2").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#3"},{xtype:"textfield",id:"mfv3",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv3").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv3").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,
!0)}},{html:"#4"},{xtype:"textfield",id:"mfv4",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv4").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv4").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#5"},{xtype:"textfield",id:"mfv5",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv5").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv5").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}}]});
mucform=new Ext.form.FormPanel({labelWidth:200,padding:5,items:[{xtype:"textfield",allowBlank:!1,name:"roomname",fieldLabel:"Room Name"},{xtype:"textfield",allowBlank:!1,name:"roomhandle",value:Application.USERNAME,fieldLabel:"Chat Handle"},{xtype:"checkbox",name:"bookmark",fieldLabel:"Save Bookmark for Chatroom?",handler:function(a,b){b?mucform.getForm().findField("roomalias").enable():mucform.getForm().findField("roomalias").disable()}},{xtype:"textfield",name:"roomalias",fieldLabel:"Bookmark Alias (optional)",
disabled:!0},{xtype:"checkbox",name:"anonymous",fieldLabel:"Anonymously Monitor (read-only)"},{xtype:"checkbox",name:"autojoin",fieldLabel:"Auto Join Room after Login"}],listeners:{render:function(){mucform.getForm().findField("roomhandle").getValue()||mucform.getForm().findField("roomhandle").setValue(Application.USERNAME)}}});var privform=new Ext.form.FormPanel({labelWidth:100,padding:5,items:[{xtype:"textfield",fieldLabel:"User Name",emptyText:"media-joe.blow",name:"username"}]});
Application.CreatePrivateChat=new Ext.Window({width:400,title:"Chat with User",items:[privform],buttons:[{xtype:"button",text:"Start Chat",scope:privform,handler:function(){var a=this.getForm().findField("username").getValue();-1==a.indexOf("@")&&(a=a+"@"+Application.XMPPHOST);Application.CreatePrivateChat.hide();(cp=Ext.getCmp("chatpanel").getChat(a))||(cp=Ext.getCmp("chatpanel").addChat(a));Ext.getCmp("chatpanel").setActiveTab(cp)}},{xtype:"button",text:"Cancel",handler:function(){Application.CreatePrivateChat.hide()}}]});
Application.JoinChatroomDialog=new Ext.Window({width:400,title:"Join a Group Chat",items:[mucform],buttons:[{xtype:"button",text:"Join Room",scope:mucform,handler:function(){roomname=this.getForm().findField("roomname").getValue();room=roomname+"@conference."+Application.XMPPHOST;handle=this.getForm().findField("roomhandle").getValue();ibook=this.getForm().findField("bookmark").getValue();anonymous=this.getForm().findField("anonymous").getValue();autojoin=this.getForm().findField("autojoin").getValue();
ibook&&(alias=this.getForm().findField("roomalias").getValue(),""==alias&&(alias=roomname),Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+roomname+")",jid:room,alias:alias,anonymous:anonymous,autojoin:autojoin,icon:"icons/chat.png",handle:handle,leaf:!0}));Application.MsgBus.fireEvent("joinchat",room,handle,anonymous);Application.JoinChatroomDialog.hide()}},{xtype:"button",text:"Cancel",handler:function(){Application.JoinChatroomDialog.hide()}}]});Application.msgtpl=new Ext.XTemplate('<p>{date:date("g:i:s A")} :: {msg}</p>');
Application.TextWindow=new Ext.Window({width:550,height:300,title:"Product Text",closeAction:"hide",constrain:!0,hidden:!0,autoScroll:!0,html:"Loading...."});Application.log=function(a){Ext.getCmp("debug").addMessage(a)};Ext.ns("Application");function saveBookmarks(){var a=Ext.getCmp("bookmarks").root,b=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"});a.eachChild(function(a){this.c("conference",{name:a.attributes.alias,anonymous:a.attributes.anonymous?"true":"false",autojoin:a.attributes.autojoin?"true":"false",jid:a.attributes.jid}).c("nick",a.attributes.handle).up().up()},b);Application.XMPPConn.sendIQ(b.tree())}
function onPresenceCheck(a,b){"available"==a.xmpp?Application.XMPPConn.send($pres()):Application.XMPPConn.send($pres().c("show","away").up().c("status",a.xmpp));Ext.getCmp("presenceUI").setText(a.text)}
Application.Control={region:"west",title:"NWSChat Live",collapsible:!0,width:200,split:!0,layout:"accordion",layoutConfig:{autoWidth:!1},autoScroll:!0,tbar:[{text:"Actions",menu:[{checked:!1,text:"Show Offline Buddies",checkHandler:function(a,b){Ext.getCmp("buddies").root.cascade(function(a){b?a.ui.show():"offline"==a.attributes.presence&&a.ui.hide()})}},{xtype:"menuitem",text:"Chat with User",handler:function(){Application.CreatePrivateChat.show()}},{xtype:"menuitem",text:"Add Buddy...",handler:function(){Application.buildAddBuddy(null,
null,null)}},{xtype:"menuitem",text:"Join Group Chat",handler:function(){Application.JoinChatroomDialog.show()}},{text:"Msg Text Color",menu:{items:[new Ext.ColorPalette({id:"fgcolor",value:"000000",listeners:{select:function(a,b){Application.setPreference("fgcolor",b)}}})]}},{text:"Msg Background Color",menu:{items:[new Ext.ColorPalette({id:"bgcolor",value:"FFFFFF",listeners:{select:function(a,b){Application.setPreference("bgcolor",b)}}})]}},{xtype:"menuitem",text:"Show Debug Window",handler:function(){Ext.getCmp("debug").show()}},
{xtype:"menuitem",text:"Log Out",handler:function(){Application.log("Manual logout requested.");Application.RECONNECT=!1;Application.XMPPConn.disconnect()}}]},{xtype:"tbseparator"},{text:"Available",id:"presenceUI",menu:{items:[{text:"Available",xmpp:"available",checked:!0,group:"presence",checkHandler:onPresenceCheck},{text:"Be Right Back",xmpp:"Be Right Back",checked:!1,group:"presence",checkHandler:onPresenceCheck},{text:"Away",xmpp:"away",checked:!1,group:"presence",checkHandler:onPresenceCheck}]}},
{xtype:"splitbutton",id:"sound",scale:"medium",soundOn:!0,handler:function(a){a.soundOn?(a.setIcon("icons/mute.png"),soundManager.muteAll(),a.soundOn=!1):(a.setIcon("icons/volume.png"),soundManager.unmuteAll(),a.soundOn=!0,Application.MsgBus.fireEvent("soundevent","default"))},arrowHandler:function(){Application.soundPrefs.show()},icon:"icons/volume.png"}],items:[{flex:1,xtype:"treepanel",id:"buddies",title:"Buddies",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,plugins:new Ext.ux.DataTip({tpl:new Ext.XTemplate('<tpl if="typeof(resources) !== &quot;undefined&quot;">',
"<div>",'<tpl for="resources.items">',"<p><b>Resource:</b> {resource} <b>Status:</b> {status}</p>","</tpl>","</div>","</tpl>")}),listeners:{click:function(a){(cp=Ext.getCmp("chatpanel").getChat(a.attributes.barejid))||(cp=Ext.getCmp("chatpanel").addChat(a.attributes.barejid));Ext.getCmp("chatpanel").setActiveTab(cp)}},root:new Ext.tree.TreeNode},{flex:1,xtype:"treepanel",id:"bookmarks",title:"Chatroom Bookmarks",collapsed:!1,rootVisible:!1,enableDD:!0,lines:!1,containerScroll:!0,autoScroll:!0,plugins:new Ext.ux.DataTip({tpl:"<div>Anonymous: {anonymous}<br />Autojoin: {autojoin}</div>"}),
contextMenu:new Ext.menu.Menu({items:[{id:"delete-node",icon:"icons/close.png",text:"Delete Bookmark"}],listeners:{itemclick:function(a){var b=a.parentMenu.contextNode;switch(a.id){case "delete-node":b.parentNode&&(b.remove(),saveBookmarks())}}}}),listeners:{contextmenu:function(a,b){a.select();var d=a.getOwnerTree().contextMenu;d.contextNode=a;d.showAt(b.getXY())},movenode:function(a,b,d,f,h){saveBookmarks()},click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();
form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(a.attributes.handle);form.findField("bookmark").enable();form.findField("anonymous").setValue(a.attributes.anonymous);form.findField("autojoin").setValue(a.attributes.autojoin);form.findField("roomalias").setValue(a.attributes.alias)})}},root:new Ext.tree.TreeNode({initialLoad:!1,listeners:{beforeappend:function(a,b,d,f){if(a=b.findChild("jid",d.attributes.jid))Application.log("Replacing MUC bookmark: "+
d.attributes.jid),b.removeChild(a,!0);return!0},append:function(a,b,d,f){b.initialLoad&&saveBookmarks()}}})},{flex:2,xtype:"treepanel",id:"chatrooms",title:"Chatrooms",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,listeners:{click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(Application.USERNAME);form.findField("bookmark").enable();
form.findField("anonymous").setValue(!1);form.findField("autojoin").setValue(!1);form.findField("roomalias").setValue(Strophe.getNodeFromJid(a.attributes.jid))})}},root:new Ext.tree.TreeNode}]};
Application.doLogin=function(){Application.RECONNECT=!0;Application.ATTEMPTS+=1;11<Application.ATTEMPTS?Application.log("Application Login Limit Reached!"):(username=Ext.getCmp("username").getValue(),0<username.indexOf("@")&&(username=Strophe.getNodeFromJid(username)),username=username.toLowerCase(),username=username.replace(/^\s+|\s+$/g,""),password=Ext.getCmp("password").getValue(),""==username?Application.log("Invalid Username"):""==password?Application.log("Invalid Password"):(Application.USERNAME=
username,Application.login(username,password)))};
Application.buildView=function(a){if(a=Ext.getCmp("map"))a.map.events.register("changelayer",null,function(a){a={lstring:""};Application.layerstore.data.each(function(a){a=a.getLayer();a.getVisibility()&&(this.lstring+="||"+a.name)},a);Application.setPreference("layers",a.lstring)}),Ext.TaskMgr.start(Application.MapTask),a=new OpenLayers.Control.SelectFeature([lsrs,sbws]),Ext.getCmp("map").map.addControl(a),a.activate();new Application.DebugWindow({id:"debug",renderTo:Ext.getBody()});(new Application.LoginWindow({id:"loginwindow"})).show()};Ext.ns("Application");Application.ServiceGuard={skipFirst:!0,run:function(){this.skipFirst?this.skipFirst=!1:Application.XMPPConn&&Application.XMPPConn.authenticated&&0!=Application.XMPPConn.errors&&Application.log("Strophe error counter is non-zero: "+Application.XMPPConn.errors)},interval:12E4};function UTCStringToDate(a,b){var d=Date.parseDate(a,b);return void 0==d?"":d.fromUTC()}
Application.login=function(a,b){jid=a+"@"+Application.XMPPHOST+"/"+Application.XMPPRESOURCE;Application.AUTOJOIN=!0;"undefined"===typeof Application.XMPPConn&&(Application.log("Initializing XMPPConn Obj"),Application.XMPPConn=new Strophe.Connection(Application.BOSH),Application.XMPPConn.disco.addFeature("http://jabber.org/protocol/chatstates"),Application.DEBUGMODE&&(Application.XMPPConn.rawInput=rawInput,Application.XMPPConn.rawOutput=rawOutput));Application.XMPPConn.connect(jid,b,onConnect,60,1,
Application.ROUTE)};
function onConnect(a){if(a==Strophe.Status.CONNECTING)Application.log("Strophe.Status.CONNECTING...");else if(a==Strophe.Status.ERROR)Application.log("Strophe.Status.ERROR...");else if(a==Strophe.Status.AUTHFAIL)Application.log("Strophe.Status.AUTHFAIL..."),Application.RECONNECT=!1,Ext.getCmp("loginwindow").addMessage("Authentication failed, please check username and password..."),Application.XMPPConn.disconnect();else if(a==Strophe.Status.CONNFAIL)Application.log("Strophe.Status.CONNFAIL...");else if(a==
Strophe.Status.DISCONNECTED)Application.log("Strophe.Status.DISCONNECTED..."),Application.MsgBus.fireEvent("loggingout"),Application.RECONNECT?(Application.log("Relogging in after 3 seconds delay"),Application.doLogin.defer(3E3,this)):Application.MsgBus.fireEvent("loggedout");else if(a==Strophe.Status.AUTHENTICATING)Application.log("Strophe.Status.AUTHENTICATING...");else if(a==Strophe.Status.DISCONNECTING)Application.log("Strophe.Status.DISCONNECTING..."),Application.XMPPConn.flush();else if(a==
Strophe.Status.ATTACHED)Application.log("Strophe.Status.ATTACHED...");else if(a==Strophe.Status.CONNECTED){Application.log("Strophe.Status.CONNECTED...");Application.RECONNECT=!0;Application.XMPPConn.addHandler(onMessage,null,"message",null,null,null);Application.XMPPConn.addHandler(onPresence,null,"presence",null,null,null);Application.XMPPConn.addHandler(onRoster,Strophe.NS.ROSTER,"iq",null,null,null);Application.XMPPConn.addHandler(onIQ,null,"iq",null,null,null);Application.XMPPConn.send($iq({type:"get"}).c("query",
{xmlns:Strophe.NS.ROSTER}).tree());var b=0;Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==a.chatType){Application.log("Attempting to rejoin MUC: "+a.barejid);var f=$pres({to:a.barejid+"/"+a.handle});a.anonymous&&f.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");(function(){Application.XMPPConn.send(this.p)}).defer(5E3*b,{p:f});b+=1}});a=$iq({type:"get",id:"_get3"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"}).tree();
Application.XMPPConn.sendIQ(a,parsePrefs);a=$iq({type:"get",id:"_get2"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}).tree();Application.XMPPConn.sendIQ(a,parseViews);Application.MsgBus.fireEvent("loggedin")}}
function updateMap(){var a=Application.getPreference("layers");if(null!=a)for(var a=a.split("||"),b=0;b<a.length;b++)""!=a[b]&&(idx=Application.layerstore.find("title",a[b]),-1!=idx&&(Application.log("Setting Layer "+a[b]+" visable"),layer=Application.layerstore.getAt(idx).getLayer(),layer.setVisibility(!0)))}
function setSounds(){Application.prefStore.each(function(a){key=a.get("key");"volume"==key?Ext.getCmp("volume").setValue(a.get("value")):0==key.indexOf("sound::")&&(tokens=key.split("::"),3==tokens.length&&(sidx=tokens[1],opt=tokens[2],store=Ext.getCmp("soundpanel").getStore(),idx=store.find("id",sidx),-1<idx&&(lrecord=store.getAt(idx),val=a.get("value"),"true"==val&&(val=!0),"false"==val&&(val=!1),lrecord.set(opt,val))))})}
function parsePrefs(a){Application.prefStore.removeAll();a=$(a).find("pref");for(var b=0;b<a.length;b++)key=a[b].getAttribute("key"),value=a[b].getAttribute("value"),Application.setPreference(key,value);Application.prefStore.locked=!0;setSounds();try{var d=parseInt(Application.getPreference("font-size",14))+2;cssfmt=String.format("normal {0}px arial",d);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt);updateMap();Application.updateColors()}catch(f){}Application.prefStore.locked=
!1}function parseViews(a){if(Ext.getCmp("map"))for(elem=$(a).find("view"),a=0;a<elem.length;a++)label=elem[a].getAttribute("label"),bounds=elem[a].getAttribute("bounds"),""!=label&&(Ext.getCmp("mfv"+(a+1)).setValue(label),Ext.getCmp("fm"+(a+1)).setText(label)),Ext.getCmp("mfv"+(a+1)).bounds=OpenLayers.Bounds.fromArray(bounds.split(",")),0==a&&Ext.getCmp("map").map.zoomToExtent(OpenLayers.Bounds.fromArray(bounds.split(",")),!0)}
function parseBookmarks(a){elem=$(a).find("conference");for(var b=a=0;b<elem.length;b++){alias=elem[b].getAttribute("name");jid=elem[b].getAttribute("jid");nick=$(elem[b]).find("nick").text();if(null==nick||""==nick)nick=Application.USERNAME;anonymous="true"==elem[b].getAttribute("anonymous");autojoin="true"==elem[b].getAttribute("autojoin");Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+Strophe.getNodeFromJid(jid)+")",jid:jid,alias:alias,autojoin:autojoin,iconCls:"chatroom-icon",handle:nick,
anonymous:anonymous,leaf:!0});!Application.AUTOJOIN&&autojoin?Application.log("AUTOJOIN is false, not autojoining: "+jid):autojoin&&null==Ext.getCmp("chatpanel").getMUC(jid)&&(Application.log("Autojoining MUC: "+jid),function(){Application.MsgBus.fireEvent("joinchat",this.jid,this.nick,this.anonymous)}.defer(5E3*a,{jid:jid,nick:nick,anonymous:anonymous}),a+=1)}Ext.getCmp("bookmarks").root.initialLoad=!0}
function onIQ(a){try{iqParser(a)}catch(b){a="IQ Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function iqParser(a){if("fetchrooms"==a.getAttribute("id")){items=a.firstChild.getElementsByTagName("item");for(a=0;a<items.length;a++)Ext.getCmp("chatrooms").root.appendChild({text:items[a].getAttribute("name")+" ("+Strophe.getNodeFromJid(items[a].getAttribute("jid"))+")",jid:items[a].getAttribute("jid"),iconCls:"chatroom-icon",leaf:!0});myTreeSorter=new Ext.tree.TreeSorter(Ext.getCmp("chatrooms"),{folderSort:!0,dir:"asc"});myTreeSorter.doSort(Ext.getCmp("chatrooms").getRootNode())}}
function onRoster(a){try{rosterParser(a)}catch(b){a="Roster Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function rosterParser(a){var b=Ext.getCmp("buddies").root;a=$(a).find("item");for(var d=0;d<a.length;d++)for(var f=$(a[d]).find("group"),h=0;h<f.length;h++){var g=$(f[h]);child=b.findChild("group",g.text())||b.appendChild({leaf:!1,group:g.text(),text:g.text(),expanded:!0,loaded:!0});child.appendChild({text:a[d].getAttribute("name"),barejid:a[d].getAttribute("jid"),resources:new Ext.util.MixedCollection,iconCls:"buddy-offline",presence:"offline",hidden:!0,leaf:!0})}Application.XMPPConn.send($pres().tree());
var l=$iq({type:"get",id:"_get1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"}).tree();(function(){Application.XMPPConn.sendIQ(l,parseBookmarks)}).defer(3E3,this);return!0}function onPresence(a){try{presenceParser(a)}catch(b){a="Presence Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function getMUCIcon(a,b){return"owner"==a?"icons/owner.png":"admin"==a?"icons/admin.png":"icons/participant.png"}
function presenceParser(a){var b=a.getAttribute("from");if(Strophe.getDomainFromJid(b)=="conference."+Application.XMPPHOST)if(room=Strophe.getBareJidFromJid(b),mcp=Ext.getCmp("chatpanel").getMUC(room),null==mcp)Application.log("ERROR: got presence from non-existant room: "+room);else{if(0<$(a).find("status").length&&(error=$(a).find("status"),"201"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, chatroom ["+room+"] does not exist.");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<
$(a).find("error").length&&(error=$(a).find("error"),"407"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your account is not authorized to access chatroom ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("error").length&&(error=$(a).find("error"),"409"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your requested chatroom handle is already in use by room ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("status").length&&
(error=$(a).find("status"),"307"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Your account signed into this chatroom ["+room+"] with the same handle from another location. Please use unique handles.");mcp.joinedChat=!1;Ext.getCmp("chatpanel").removeMUC(room);return}child=mcp.roomusers.root.findChild("text",Strophe.getResourceFromJid(b));var d=$(a).find("item"),f=b,h,g;if(0<d.length&&(f=d[0].getAttribute("jid")||f,g=d[0].getAttribute("role"),h=d[0].getAttribute("affiliation"),d=$(d[0]).find("role"),
0<d.length))try{g=d.text()}catch(l){var d="roletest bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n"),n;for(n in l)d+="property: "+n+" value: ["+l[n]+"]\n";d+="toString():  value: ["+l.toString()+"]";Application.log(d)}null!=a.getAttribute("type")||child||"visitor"==g||(mcp.joinedChat=!0,mcp.roomusers.root.appendChild({affiliation:h,role:g,icon:getMUCIcon(h,g),text:Strophe.getResourceFromJid(b),jid:f,leaf:!0}));"unavailable"==a.getAttribute("type")&&child&&mcp.roomusers.root.removeChild(child)}else onBuddyPresence(a)}
function onMessage(a){try{messageParser(a)}catch(b){a="Message Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}Application.replaceURLWithHTMLLinks=function(a){return null==a?null:a.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,"<a href='$1'>$1</a>")};
function messageParser(a){var b=a.getAttribute("from"),d=a.getAttribute("type"),f=a.getElementsByTagName("body"),h=$(a).find("x[xmlns='jabber:x:delay']"),g=$(a).find("html"),l=f[0],n="",f=!1;0<g.length?(n=$(a).find("html").find("body"),n=navigator.userAgent.match(/msie/i)?n[0].xml:$(n[0]).html(),n=n.replace(/\<p/g,"<span").replace(/\<\/p\>/g,"</span>"),""==n&&(Application.log("Message Failure:"+a),n=Application.replaceURLWithHTMLLinks(Strophe.getText(l)))):n=Application.replaceURLWithHTMLLinks(Strophe.getText(l));
0<h.length?(g=h[0].getAttribute("stamp"),f=!0):g=(new Date).toUTC().format("Ymd\\TH:i:s");if("groupchat"==d){product_id=null;h=$(a).find("x");for(d=0;d<h.length;d++)h[d].getAttribute("product_id")&&(product_id=h[d].getAttribute("product_id"));try{geomParser(a,f)}catch(r){}sender=Strophe.getResourceFromJid(b);room=Strophe.getBareJidFromJid(b);(mpc=Ext.getCmp("chatpanel").getMUC(room))&&sender&&(mpc.gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:sender,message:n,
room:null,jid:mpc.getJidByHandle(sender),xdelay:f,product_id:product_id})),mpc.gp.getStore().isFiltered()&&mpc.gp.getStore().filterBy(nwsbotFilter),f||(Ext.getCmp("__allchats__").gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:sender,room:Strophe.getNodeFromJid(b),message:n,jid:mpc.getJidByHandle(sender),xdelay:f,product_id:product_id})),Ext.getCmp("__allchats__").gp.getStore().isFiltered()&&Ext.getCmp("__allchats__").gp.getStore().filterBy(nwsbotFilter)))}else"chat"!=
d||n||null==b?"chat"==d&&n&&null!=b?(jid=Strophe.getBareJidFromJid(b),username=Strophe.getNodeFromJid(b),Strophe.getDomainFromJid(b)!=Application.XMPPHOST&&(jid=b,username=Strophe.getResourceFromJid(b)),cp=Ext.getCmp("chatpanel").getChat(jid),cp||(cp=Ext.getCmp("chatpanel").addChat(jid),Application.MsgBus.fireEvent("soundevent","new_conversation")),cp.gp.store.addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:username,room:null,xdelay:!1,message:n}))):b==Application.XMPPHOST&&
(new Ext.Window({width:500,maxWidth:500,height:350,constrain:!0,autoScroll:!0,bodyStyle:{padding:"10",background:"#fff"},title:$(a).find("subject").text()||"NWSChat System Message",html:"<p><b>NWSChat System Message</b><p>"+$(a).find("body").text()+"</p>"})).show():(jid=Strophe.getBareJidFromJid(b),cp=Ext.getCmp("chatpanel").getChat(jid),0<$(a).find("composing").length&&cp&&cp.setIconCls("typing-tab"),0<$(a).find("paused").length&&cp&&cp.setIconCls("paused-tab"))}
function geomParser(a,b){if(Ext.getCmp("map")){var d=a.getElementsByTagName("body")[0],f=null;0<a.getElementsByTagName("html").length?(f=$(a).find("html").find("body"),f=navigator.userAgent.match(/msie/i)?f[0].xml:$(f[0]).html()):f=Strophe.getText(d);d=$(a).find("x");if(0!=d.length)for(var h=0;h<d.length;h++)if(null!=d[h].getAttribute("geometry")){var g=d[h].getAttribute("geometry");wkt=new OpenLayers.Format.WKT;if(collection=wkt.read(g)){collection.constructor!=Array&&(collection=[collection]);var l=
collection[0],g=36E5;if(!d[h].getAttribute("skip")){if(d[h].getAttribute("expire")){var n=UTCStringToDate(d[h].getAttribute("expire"),"Ymd\\Th:i:s");l.attributes.expire=n.toUTC();diff=n-new Date;if(0>=diff)continue;0<diff&&(g=diff)}d[h].getAttribute("valid")&&(n=UTCStringToDate(d[h].getAttribute("valid"),"Ymd\\Th:i:s"),l.attributes.valid=n.toUTC());l.attributes.ptype=d[h].getAttribute("ptype");l.attributes.message=f;l.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
"LSR"!=d[h].getAttribute("category")&&"PIREP"!=d[h].getAttribute("category")||!l.attributes.valid||b&&!(b&&72E5>new Date-l.attributes.valid)||(lsrs.addFeatures([l]),(new Ext.util.DelayedTask(function(){lsrs.removeFeatures([l])})).delay(g),sstate=Application.lsrStore.getSortState(),Application.lsrStore.sort(sstate.field,sstate.direction));"SBW"==d[h].getAttribute("category")&&(l.attributes.vtec=d[h].getAttribute("vtec"),n=Application.sbwStore.find("vtec",l.attributes.vtec),"CAN"==d[h].getAttribute("status")?
-1<n&&(Application.log("Removing SBW vtec ["+l.attributes.vtec+"]"),Application.sbwStore.removeAt(n)):(-1<n&&(Application.log("Old SBW vtec ["+l.attributes.vtec+"]"),Application.sbwStore.removeAt(n)),Application.log("Adding SBW vtec ["+l.attributes.vtec+"] delay ["+g+"]"),sbws.addFeatures([l]),(new Ext.util.DelayedTask(function(){sbws.removeFeatures([l])})).delay(g),sstate=Application.sbwStore.getSortState(),Application.sbwStore.sort(sstate.field,sstate.direction)))}}}}}
function rawInput(a){Application.log("RECV: "+Strophe.xmlescape(a))}function rawOutput(a){Application.log("SENT: "+Strophe.xmlescape(a))};Ext.ns("Application");Application.updateColors=function(){var a=Application.getPreference("bgcolor","FFFFFF"),b=Application.getPreference("fgcolor","000000");Application.log("Attempting style adjustment bgcolor:"+a+", fgcolor:"+b);Ext.getCmp("chatpanel").items.each(function(d){d.te&&d.te.items.get(0).getEl().applyStyles({background:"#"+a,color:"#"+b})})};
Application.syncPreferences=function(){Application.log("Saving preferences to server...");var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"});Application.prefStore.each(function(a){this.c("pref",{key:a.get("key"),value:a.get("value")}).up()},a);Application.XMPPConn.sendIQ(a.tree())};Application.removePreference=function(a){idx=Application.prefStore.find("key",a);-1<idx&&Application.prefStore.removeAt(idx)};
Application.getPreference=function(a,b){idx=Application.prefStore.find("key",a);return-1<idx?(record=Application.prefStore.getAt(idx),record.get("value")):b};Application.setPreference=function(a,b){idx=Application.prefStore.find("key",a);-1<idx?(Application.log("Setting Preference: "+a+" Value: "+b),record=Application.prefStore.getAt(idx),record.set("value",b)):(Application.log("Adding Preference: "+a+" Value: "+b),Application.prefStore.add(new Ext.data.Record({key:a,value:b})))};
Application.prefStore=new Ext.data.Store({fields:[{id:"key"},{id:"value"}],locked:!1,listeners:{remove:function(a,b,d){Application.log("prefStore remove event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences()},update:function(a,b,d){Application.log("prefStore update event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences();"fgcolor"!=b.get("key")&&"bgcolor"!=
b.get("key")||Application.updateColors()}}});Application.MsgBus=new Ext.util.Observable;Application.MsgBus.addEvents("message");Application.MsgBus.addEvents("loggedin");Application.MsgBus.addEvents("loggedout");
Application.playSound=function(a){if(soundManager&&soundManager.ok()&&1!=soundManager.playState){var b=soundManager.getSoundById(a);if(!b){idx=Application.SoundStore.find("id",a);if(-1==idx){Application.log("Could not find sound: "+a);return}record=Application.SoundStore.getAt(idx);b=soundManager.createSound({id:record.get("id"),url:record.get("src"),onplay:function(){},onfinish:function(){}})}b&&b.play({volume:Application.getPreference("volume",100)})}};
Application.MsgBus.on("soundevent",function(a){enable=Application.getPreference("sound::"+a+"::enabled","true");"false"!=enable&&(sidx=Application.getPreference("sound::"+a+"::sound","default"),Application.playSound(sidx))});
Application.MsgBus.on("loggingout",function(){Ext.getCmp("chatpanel").items.each(function(a){"groupchat"==a.chatType&&a.clearRoom()});Ext.getCmp("buddies").root.removeAll();Ext.getCmp("bookmarks").root.suspendEvents(!1);Ext.getCmp("bookmarks").root.removeAll();Ext.getCmp("bookmarks").root.resumeEvents();Ext.getCmp("bookmarks").root.initalLoad=!1;Ext.getCmp("chatrooms").root.removeAll()});Application.MsgBus.on("loggedout",function(){Ext.getCmp("loginwindow").show()});
Application.MsgBus.on("loggedin",function(){Ext.getCmp("loginwindow").hide();Application.XMPPConn.send($iq({type:"get",id:"fetchrooms",to:"conference."+Application.XMPPHOST}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}))});
Application.MsgBus.on("joinchat",function(a,b,d){if(null==b||""==b)b=Application.USERNAME;mcp=Ext.getCmp("chatpanel").getMUC(a);if(null==mcp){Application.log("Creating chatroom:"+a);mcp=Ext.getCmp("chatpanel").addMUC(a,b,d);var f=$pres({to:a+"/"+b});d&&f.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");Application.XMPPConn.send(f);mcp.on("destroy",function(){Application.XMPPConn.authenticated&&this.joinedChat&&Application.XMPPConn.send($pres({type:"unavailable",to:a+
"/"+b}))})}Ext.getCmp("chatpanel").setActiveTab(mcp)});Ext.ns("Application");
Application.buildAddBuddy=function(a,b,d){Ext.getCmp("addbuddy")||(new Ext.Window({title:"Add Buddy",layout:"form",width:300,height:150,id:"addbuddy",items:[{xtype:"textfield",fieldLabel:"NWSChat ID",value:a},{xtype:"textfield",fieldLabel:"Alias",value:b},{xtype:"textfield",fieldLabel:"Buddy Group",value:d}],buttons:[{text:"Add Buddy",handler:function(a){var b=a.ownerCt.ownerCt.items.items[0].getValue(),d=a.ownerCt.ownerCt.items.items[1].getValue();a=a.ownerCt.ownerCt.items.items[2].getValue();var l=
$pres({to:b+"@"+Application.XMPPHOST,type:"subscribe"});Application.XMPPConn.send(l.tree());l=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:b+"@"+Application.XMPPHOST,name:d}).c("group",a);Application.XMPPConn.send(l.tree());Ext.getCmp("addbuddy").close()}}]})).show()};
