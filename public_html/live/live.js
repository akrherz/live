Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),d="toString toLocaleString valueOf hasOwnProperty isPrototypeOf propertyIsEnumerable constructor".split(" "),b=d.length;return function(h){if("object"!==typeof h&&("function"!==typeof h||null===h))throw new TypeError("Object.keys called on non-object");var g=[],k;for(k in h)a.call(h,k)&&g.push(k);if(e)for(k=0;k<b;k++)a.call(h,d[k])&&g.push(d[k]);return g}}());
Array.prototype.forEach||(Array.prototype.forEach=function(a){if(void 0===this||null===this)throw new TypeError;var e=Object(this),d=e.length>>>0;if("function"!==typeof a)throw new TypeError;for(var b=2<=arguments.length?arguments[1]:void 0,h=0;h<d;h++)h in e&&a.call(b,e[h],h,e)});Ext.override(Date,{toUTC:function(){return this.add(Date.MINUTE,this.getTimezoneOffset())},fromUTC:function(){return this.add(Date.MINUTE,-this.getTimezoneOffset())}});
Ext.override(Ext.Panel,{setIconCls:function(a){Ext.fly(this.ownerCt.getTabEl(this)).child(".x-tab-strip-text").replaceClass(this.iconCls,a);this.setIconClass(a)}});
Ext.override(Ext.Element,{printCSS:null,printStyle:!1,printTitle:document.title,print:function(a){Ext.apply(this,a);a=Ext.get(this.id).dom;this.isGrid&&(a=a.parentNode);var e=document.getElementById("printcontainer"),d=document.getElementById("printframe"),b="";e&&(d&&e.removeChild(d),a.removeChild(e));for(d=0;d<a.attributes.length;d++)if(Ext.isEmpty(a.attributes[d].value)||"null"!=a.attributes[d].value.toLowerCase())if(e=Ext.isEmpty(a.attributes[d].value)?'{0}="true" ':'{0}="{1}" ',this.printStyle?
this.printStyle:"style"!=a.attributes[d].name.toLowerCase())b+=String.format(e,a.attributes[d].name,a.attributes[d].value);e="";if(this.printCSS)for(Ext.isArray(this.printCSS)||(this.printCSS=[this.printCSS]),d=0;d<this.printCSS.length;d++)e+=String.format('<link rel="stylesheet" type="text/css" href="{0}"/>',this.printCSS[d]);b=String.format('<HTML><HEAD>{0}<TITLE>{1}</TITLE></HEAD><BODY onload="{2}"><DIV {3}>{4}</DIV></BODY></HTML>',e,this.printTitle,"",b,a.innerHTML);e=document.createElement("div");
e.setAttribute("style","width:0px;height:0px;"+(Ext.isSafari?"display:none;":"visibility:hidden;"));e.setAttribute("id","printcontainer");a.appendChild(e);Ext.isIE&&(e.style.display="none");d=document.createElement("iframe");d.setAttribute("id","printframe");d.setAttribute("name","printframe");e.appendChild(d);d.contentWindow.document.open();d.contentWindow.document.write(b);d.contentWindow.document.close();this.isGrid&&(a=Ext.get(d.contentWindow.document.body),a=Ext.get(a.first().dom.parentNode),
a.child("div.x-panel-body").setStyle("height",""),a.child("div.x-grid3").setStyle("height",""),a.child("div.x-grid3-scroller").setStyle("height",""));Ext.isIE?d.contentWindow.document.execCommand("print"):d.contentWindow.print()}});(function(a){(function(a,d){"function"===typeof define&&define.amd?define("strophe-base64",function(){return d()}):a.Base64=d()})(this,function(){return{encode:function(a){var d="",b,h,g,k,l,f,q,v=0;do b=a.charCodeAt(v++),h=a.charCodeAt(v++),g=a.charCodeAt(v++),k=b>>2,l=(b&3)<<4|h>>4,f=(h&15)<<2|g>>6,q=g&63,isNaN(h)?(l=(b&3)<<4,f=q=64):isNaN(g)&&(q=64),d=d+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(k)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(q);while(v<a.length);return d},decode:function(a){var d="",b,h,g,k,l,f=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(f++)),h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(f++)),k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(f++)),
l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(f++)),b=b<<2|h>>4,h=(h&15)<<4|k>>2,g=(k&3)<<6|l,d+=String.fromCharCode(b),64!=k&&(d+=String.fromCharCode(h)),64!=l&&(d+=String.fromCharCode(g));while(f<a.length);return d}}});(function(a,d){"function"===typeof define&&define.amd?define("strophe-sha1",function(){return d()}):a.SHA1=d()})(this,function(){function a(e,d){e[d>>5]|=128<<24-d%32;e[(d+64>>9<<4)+15]=d;var q=Array(80),h=1732584193,u=-271733879,w=-1732584194,
g=271733878,m=-1009589776,k,r,x,y,p,A,z,C;for(k=0;k<e.length;k+=16){y=h;p=u;A=w;z=g;C=m;for(r=0;80>r;r++){16>r?q[r]=e[k+r]:(x=q[r-3]^q[r-8]^q[r-14]^q[r-16],q[r]=x<<1|x>>>31);x=h<<5|h>>>27;var D;D=20>r?u&w|~u&g:40>r?u^w^g:60>r?u&w|u&g|w&g:u^w^g;x=b(b(x,D),b(b(m,q[r]),20>r?1518500249:40>r?1859775393:60>r?-1894007588:-899497514));m=g;g=w;w=u<<30|u>>>2;u=h;h=x}h=b(h,y);u=b(u,p);w=b(w,A);g=b(g,z);m=b(m,C)}return[h,u,w,g,m]}function d(b,d){var q=h(b);16<q.length&&(q=a(q,8*b.length));for(var v=Array(16),
u=Array(16),w=0;16>w;w++)v[w]=q[w]^909522486,u[w]=q[w]^1549556828;q=a(v.concat(h(d)),512+8*d.length);return a(u.concat(q),672)}function b(a,e){var q=(a&65535)+(e&65535);return(a>>16)+(e>>16)+(q>>16)<<16|q&65535}function h(a){for(var e=[],q=0;q<8*a.length;q+=8)e[q>>5]|=(a.charCodeAt(q/8)&255)<<24-q%32;return e}function g(a){for(var e="",q=0;q<32*a.length;q+=8)e+=String.fromCharCode(a[q>>5]>>>24-q%32&255);return e}function k(a){for(var e="",q,b,d=0;d<4*a.length;d+=3)for(q=(a[d>>2]>>8*(3-d%4)&255)<<
16|(a[d+1>>2]>>8*(3-(d+1)%4)&255)<<8|a[d+2>>2]>>8*(3-(d+2)%4)&255,b=0;4>b;b++)e=8*d+6*b>32*a.length?e+"=":e+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>6*(3-b)&63);return e}return{b64_hmac_sha1:function(a,e){return k(d(a,e))},b64_sha1:function(b){return k(a(h(b),8*b.length))},binb2str:g,core_hmac_sha1:d,str_hmac_sha1:function(a,e){return g(d(a,e))},str_sha1:function(b){return g(a(h(b),8*b.length))}}});(function(a,d){"function"===typeof define&&define.amd?define("strophe-md5",
function(){return d()}):a.MD5=d()})(this,function(a){var d=function(a,e){var b=(a&65535)+(e&65535);return(a>>16)+(e>>16)+(b>>16)<<16|b&65535},b=function(a){for(var e=[],b=0;b<8*a.length;b+=8)e[b>>5]|=(a.charCodeAt(b/8)&255)<<b%32;return e},h=function(a,e,b,h,f,g){a=d(d(e,a),d(h,g));return d(a<<f|a>>>32-f,b)},g=function(a,e,b,d,f,g,k){return h(e&b|~e&d,a,e,f,g,k)},k=function(a,e,b,d,f,g,k){return h(e&d|b&~d,a,e,f,g,k)},l=function(a,e,b,d,f,g,k){return h(b^(e|~d),a,e,f,g,k)},f=function(a,e){a[e>>5]|=
128<<e%32;a[(e+64>>>9<<4)+14]=e;for(var b=1732584193,f=-271733879,n=-1732584194,m=271733878,B,r,x,y,p=0;p<a.length;p+=16)B=b,r=f,x=n,y=m,b=g(b,f,n,m,a[p+0],7,-680876936),m=g(m,b,f,n,a[p+1],12,-389564586),n=g(n,m,b,f,a[p+2],17,606105819),f=g(f,n,m,b,a[p+3],22,-1044525330),b=g(b,f,n,m,a[p+4],7,-176418897),m=g(m,b,f,n,a[p+5],12,1200080426),n=g(n,m,b,f,a[p+6],17,-1473231341),f=g(f,n,m,b,a[p+7],22,-45705983),b=g(b,f,n,m,a[p+8],7,1770035416),m=g(m,b,f,n,a[p+9],12,-1958414417),n=g(n,m,b,f,a[p+10],17,-42063),
f=g(f,n,m,b,a[p+11],22,-1990404162),b=g(b,f,n,m,a[p+12],7,1804603682),m=g(m,b,f,n,a[p+13],12,-40341101),n=g(n,m,b,f,a[p+14],17,-1502002290),f=g(f,n,m,b,a[p+15],22,1236535329),b=k(b,f,n,m,a[p+1],5,-165796510),m=k(m,b,f,n,a[p+6],9,-1069501632),n=k(n,m,b,f,a[p+11],14,643717713),f=k(f,n,m,b,a[p+0],20,-373897302),b=k(b,f,n,m,a[p+5],5,-701558691),m=k(m,b,f,n,a[p+10],9,38016083),n=k(n,m,b,f,a[p+15],14,-660478335),f=k(f,n,m,b,a[p+4],20,-405537848),b=k(b,f,n,m,a[p+9],5,568446438),m=k(m,b,f,n,a[p+14],9,-1019803690),
n=k(n,m,b,f,a[p+3],14,-187363961),f=k(f,n,m,b,a[p+8],20,1163531501),b=k(b,f,n,m,a[p+13],5,-1444681467),m=k(m,b,f,n,a[p+2],9,-51403784),n=k(n,m,b,f,a[p+7],14,1735328473),f=k(f,n,m,b,a[p+12],20,-1926607734),b=h(f^n^m,b,f,a[p+5],4,-378558),m=h(b^f^n,m,b,a[p+8],11,-2022574463),n=h(m^b^f,n,m,a[p+11],16,1839030562),f=h(n^m^b,f,n,a[p+14],23,-35309556),b=h(f^n^m,b,f,a[p+1],4,-1530992060),m=h(b^f^n,m,b,a[p+4],11,1272893353),n=h(m^b^f,n,m,a[p+7],16,-155497632),f=h(n^m^b,f,n,a[p+10],23,-1094730640),b=h(f^n^
m,b,f,a[p+13],4,681279174),m=h(b^f^n,m,b,a[p+0],11,-358537222),n=h(m^b^f,n,m,a[p+3],16,-722521979),f=h(n^m^b,f,n,a[p+6],23,76029189),b=h(f^n^m,b,f,a[p+9],4,-640364487),m=h(b^f^n,m,b,a[p+12],11,-421815835),n=h(m^b^f,n,m,a[p+15],16,530742520),f=h(n^m^b,f,n,a[p+2],23,-995338651),b=l(b,f,n,m,a[p+0],6,-198630844),m=l(m,b,f,n,a[p+7],10,1126891415),n=l(n,m,b,f,a[p+14],15,-1416354905),f=l(f,n,m,b,a[p+5],21,-57434055),b=l(b,f,n,m,a[p+12],6,1700485571),m=l(m,b,f,n,a[p+3],10,-1894986606),n=l(n,m,b,f,a[p+10],
15,-1051523),f=l(f,n,m,b,a[p+1],21,-2054922799),b=l(b,f,n,m,a[p+8],6,1873313359),m=l(m,b,f,n,a[p+15],10,-30611744),n=l(n,m,b,f,a[p+6],15,-1560198380),f=l(f,n,m,b,a[p+13],21,1309151649),b=l(b,f,n,m,a[p+4],6,-145523070),m=l(m,b,f,n,a[p+11],10,-1120210379),n=l(n,m,b,f,a[p+2],15,718787259),f=l(f,n,m,b,a[p+9],21,-343485551),b=d(b,B),f=d(f,r),n=d(n,x),m=d(m,y);return[b,f,n,m]};return{hexdigest:function(a){a=f(b(a),8*a.length);for(var e="",d=0;d<4*a.length;d++)e+="0123456789abcdef".charAt(a[d>>2]>>d%4*8+
4&15)+"0123456789abcdef".charAt(a[d>>2]>>d%4*8&15);return e},hash:function(a){a=f(b(a),8*a.length);for(var e="",d=0;d<32*a.length;d+=8)e+=String.fromCharCode(a[d>>5]>>>d%32&255);return e}}});(function(a,d){"function"===typeof define&&define.amd?define("strophe-utils",function(){return d()}):a.stropheUtils=d()})(this,function(){return{utf16to8:function(a){var d,b,h="",g=a.length;for(d=0;d<g;d++)b=a.charCodeAt(d),0<=b&&127>=b?h+=a.charAt(d):(2047<b?(h+=String.fromCharCode(224|b>>12&15),h+=String.fromCharCode(128|
b>>6&63)):h+=String.fromCharCode(192|b>>6&31),h+=String.fromCharCode(128|b>>0&63));return h},addCookies:function(a){var d,b,h,g,k,l,f;for(d in a||{})f=l=k="",b=a[d],h="object"==typeof b,g=escape(unescape(h?b.value:b)),h&&(k=b.expires?";expires="+b.expires:"",l=b.domain?";domain="+b.domain:"",f=b.path?";path="+b.path:""),document.cookie=d+"="+g+k+l+f}}});(function(a,d){if("function"===typeof define&&define.amd)define("strophe-polyfill",[],function(){return d()});else return d()})(this,function(){Function.prototype.bind||
(Function.prototype.bind=function(a){var d=this,b=Array.prototype.slice,h=Array.prototype.concat,g=b.call(arguments,1);return function(){return d.apply(a?a:this,h.call(g,b.call(arguments,0)))}});Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,d){var b=this.length,h=Number(d)||0,h=0>h?Math.ceil(h):Math.floor(h);for(0>h&&(h+=b);h<b;h++)if(h in this&&this[h]===a)return h;return-1})});(function(a,
d){if("function"===typeof define&&define.amd)define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils","strophe-polyfill"],function(){return d.apply(this,arguments)});else{var b=d(a.SHA1,a.Base64,a.MD5,a.stropheUtils);window.Strophe=b.Strophe;window.$build=b.$build;window.$iq=b.$iq;window.$msg=b.$msg;window.$pres=b.$pres;window.SHA1=b.SHA1;window.Base64=b.Base64;window.MD5=b.MD5;window.b64_hmac_sha1=b.SHA1.b64_hmac_sha1;window.b64_sha1=b.SHA1.b64_sha1;window.str_hmac_sha1=
b.SHA1.str_hmac_sha1;window.str_sha1=b.SHA1.str_sha1}})(this,function(a,d,b,h){function g(a,b){return new f.Builder(a,b)}function k(a){return new f.Builder("iq",a)}function l(a){return new f.Builder("presence",a)}var f;f={VERSION:"1.2.5",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",
MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],
blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(a){for(var b=0;b<f.XHTML.tags.length;b++)if(a==f.XHTML.tags[b])return!0;return!1},validAttribute:function(a,b){if("undefined"!==typeof f.XHTML.attributes[a]&&0<f.XHTML.attributes[a].length)for(var e=
0;e<f.XHTML.attributes[a].length;e++)if(b==f.XHTML.attributes[a][e])return!0;return!1},validCSS:function(a){for(var b=0;b<f.XHTML.css.length;b++)if(a==f.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(a,b){f.NS[a]=b},forEachChild:function(a,
b,e){var d,h;for(d=0;d<a.childNodes.length;d++)h=a.childNodes[d],h.nodeType!=f.ElementType.NORMAL||b&&!this.isTagEqual(h,b)||e(h)},isTagEqual:function(a,b){return a.tagName==b},_xmlGenerator:null,_makeGenerator:function(){var a;void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);
return a},xmlGenerator:function(){f._xmlGenerator||(f._xmlGenerator=f._makeGenerator());return f._xmlGenerator},_getIEXmlDom:function(){for(var a=null,b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),e=0;e<b.length;e++)if(null===a)try{a=new ActiveXObject(b[e])}catch(d){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=f.xmlGenerator().createElement(a),e,d,h;for(e=
1;e<arguments.length;e++){var g=arguments[e];if(g)if("string"==typeof g||"number"==typeof g)b.appendChild(f.xmlTextNode(g));else if("object"==typeof g&&"function"==typeof g.sort)for(d=0;d<g.length;d++){var k=g[d];"object"==typeof k&&"function"==typeof k.sort&&void 0!==k[1]&&null!==k[1]&&b.setAttribute(k[0],k[1])}else if("object"==typeof g)for(h in g)g.hasOwnProperty(h)&&void 0!==g[h]&&null!==g[h]&&b.setAttribute(h,g[h])}return b},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");
a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlunescape:function(a){a=a.replace(/\&amp;/g,"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&apos;/g,"'");return a=a.replace(/&quot;/g,'"')},xmlTextNode:function(a){return f.xmlGenerator().createTextNode(a)},xmlHtmlNode:function(a){var b;window.DOMParser?b=(new DOMParser).parseFromString(a,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));return b},getText:function(a){if(!a)return null;
var b="";0===a.childNodes.length&&a.nodeType==f.ElementType.TEXT&&(b+=a.nodeValue);for(var e=0;e<a.childNodes.length;e++)a.childNodes[e].nodeType==f.ElementType.TEXT&&(b+=a.childNodes[e].nodeValue);return f.xmlescape(b)},copyElement:function(a){var b,e;if(a.nodeType==f.ElementType.NORMAL){e=f.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)e.setAttribute(a.attributes[b].nodeName,a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)e.appendChild(f.copyElement(a.childNodes[b]))}else a.nodeType==
f.ElementType.TEXT&&(e=f.xmlGenerator().createTextNode(a.nodeValue));return e},createHtml:function(a){var b,e,d,h,g,k,l,x,y,p,A;if(a.nodeType==f.ElementType.NORMAL)if(h=a.nodeName.toLowerCase(),f.XHTML.validTag(h))try{e=f.xmlElement(h);for(b=0;b<f.XHTML.attributes[h].length;b++)if(g=f.XHTML.attributes[h][b],k=a.getAttribute(g),"undefined"!=typeof k&&null!==k&&""!==k&&!1!==k&&0!==k)if("style"==g&&"object"==typeof k&&"undefined"!=typeof k.cssText&&(k=k.cssText),"style"==g){l=[];x=k.split(";");for(d=
0;d<x.length;d++)y=x[d].split(":"),p=y[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),f.XHTML.validCSS(p)&&(A=y[1].replace(/^\s*/,"").replace(/\s*$/,""),l.push(p+": "+A));0<l.length&&(k=l.join("; "),e.setAttribute(g,k))}else e.setAttribute(g,k);for(b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]))}catch(z){e=f.xmlTextNode("")}else for(e=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]));else if(a.nodeType==
f.ElementType.FRAGMENT)for(e=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]));else a.nodeType==f.ElementType.TEXT&&(e=f.xmlTextNode(a.nodeValue));return e},escapeNode:function(a){return"string"!==typeof a?a:a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,
"\\40")},unescapeNode:function(a){return"string"!==typeof a?a:a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=f.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=
a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var b;if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var e=a.nodeName,
d,h;a.getAttribute("_realname")&&(e=a.getAttribute("_realname"));b="<"+e;for(d=0;d<a.attributes.length;d++)"_realname"!=a.attributes[d].nodeName&&(b+=" "+a.attributes[d].nodeName+"='"+a.attributes[d].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'");if(0<a.childNodes.length){b+=">";for(d=0;d<a.childNodes.length;d++)switch(h=a.childNodes[d],h.nodeType){case f.ElementType.NORMAL:b+=f.serialize(h);break;case f.ElementType.TEXT:b+=f.xmlescape(h.nodeValue);
break;case f.ElementType.CDATA:b+="<![CDATA["+h.nodeValue+"]]\x3e"}b+="</"+e+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){f._connectionPlugins[a]=b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=f.NS.CLIENT:b||(b={xmlns:f.NS.CLIENT});this.node=this.nodeTree=f.xmlElement(a,b)}};f.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return f.serialize(this.nodeTree)},up:function(){this.node=
this.node.parentNode;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&(void 0===a[b]?this.node.removeAttribute(b):this.node.setAttribute(b,a[b]));return this},c:function(a,b,e){a=f.xmlElement(a,b,e);this.node.appendChild(a);"string"!==typeof e&&(this.node=a);return this},cnode:function(a){var b,e=f.xmlGenerator();try{b=void 0!==e.importNode}catch(d){b=!1}a=b?e.importNode(a,!0):f.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){a=f.xmlTextNode(a);this.node.appendChild(a);
return this},h:function(a){var b=document.createElement("body");b.innerHTML=a;for(a=f.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}};f.Handler=function(a,b,e,d,h,g,k){this.handler=a;this.ns=b;this.name=e;this.type=d;this.id=h;this.options=k||{matchBare:!1};this.options.matchBare||(this.options.matchBare=!1);this.from=this.options.matchBare?g?f.getBareJidFromJid(g):null:g;this.user=!0};f.Handler.prototype={isMatch:function(a){var b,e=null,e=this.options.matchBare?
f.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");b=!1;if(this.ns){var d=this;f.forEachChild(a,null,function(a){a.getAttribute("xmlns")==d.ns&&(b=!0)});b=b||a.getAttribute("xmlns")==this.ns}else b=!0;var h=a.getAttribute("type");return!b||this.name&&!f.isTagEqual(a,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(h):h!=this.type)||this.id&&a.getAttribute("id")!=this.id||this.from&&e!=this.from?!1:!0},run:function(a){var b=null;try{b=this.handler(a)}catch(e){throw e.sourceURL?
f.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",e,e.message)),f.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message)):f.fatal("error: "+e.message+"\n"+e.stack),e;}return b},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};f.TimedHandler=function(a,b){this.period=a;this.handler=
b;this.lastCalled=(new Date).getTime();this.user=!0};f.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};f.Connection=function(a,b){this.service=a;this.options=b||{};var e=this.options.protocol||"";0===a.indexOf("ws:")||0===a.indexOf("wss:")||0===e.indexOf("ws")?this._proto=new f.Websocket(this):this._proto=new f.Bosh(this);
this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._disconnectTimeout=this._idleTimeout=null;this.disconnecting=this.connected=this.authenticated=!1;this.do_authentication=!0;this.restored=this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=
null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);h.addCookies(this.options.cookies);for(var d in f._connectionPlugins)f._connectionPlugins.hasOwnProperty(d)&&(e=function(){},e.prototype=f._connectionPlugins[d],this[d]=new e,this[d].init(this))};f.Connection.prototype={reset:function(){this._proto._reset();this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication=
{};this.restored=this.disconnecting=this.connected=this.authenticated=!1;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)});return"string"==typeof a||"number"==typeof a?b+":"+a:b+""},connect:function(a,b,e,d,h,g,k){this.jid=a;this.authzid=f.getBareJidFromJid(this.jid);this.authcid=
k||f.getNodeFromJid(this.jid);this.pass=b;this.servtype="xmpp";this.connect_callback=e;this.restored=this.authenticated=this.connected=this.disconnecting=!1;this.domain=f.getDomainFromJid(this.jid);this._changeConnectStatus(f.Status.CONNECTING,null);this._proto._connect(d,h,g)},attach:function(a,b,e,d,h,g,k){if(this._proto instanceof f.Bosh)this._proto._attach(a,b,e,d,h,g,k);else throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};},restore:function(a,
b,e,d,f){if(this._sessionCachingSupported())this._proto._restore(a,b,e,d,f);else throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};},_sessionCachingSupported:function(){if(this._proto instanceof f.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(a){return!1}return!0}return!1},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},
nextValidRid:function(a){},send:function(a){if(null!==a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,b,e,d){var h=null,g=this;"function"===typeof a.tree&&(a=a.tree());var k=a.getAttribute("id");k||(k=this.getUniqueId("sendIQ"),a.setAttribute("id",k));var l=a.getAttribute("to"),x=this.jid,
y=this.addHandler(function(a){h&&g.deleteTimedHandler(h);var d=!1,q=a.getAttribute("from");q!==l&&(l||q!==f.getBareJidFromJid(x)&&q!==f.getDomainFromJid(x)&&q!==x)||(d=!0);if(!d)throw{name:"StropheError",message:"Got answer to IQ from wrong jid:"+q+"\nExpected jid: "+l};d=a.getAttribute("type");if("result"==d)b&&b(a);else if("error"==d)e&&e(a);else throw{name:"StropheError",message:"Got bad IQ type of "+d};},null,"iq",["error","result"],k);d&&(h=this.addTimedHandler(d,function(){g.deleteHandler(y);
e&&e(null);return!1}));this.send(a);return k},_queueData:function(a){if(null===a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,b){var e=new f.TimedHandler(a,b);this.addTimeds.push(e);return e},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,
b,e,d,h,g,k){a=new f.Handler(a,b,e,d,h,g,k);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a);a=this.addHandlers.indexOf(a);0<=a&&this.addHandlers.splice(a,1)},disconnect:function(a){this._changeConnectStatus(f.Status.DISCONNECTING,a);f.info("Disconnect was called because: "+a);this.connected?(a=!1,this.disconnecting=!0,this.authenticated&&(a=l({xmlns:f.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),
this._proto._disconnect(a)):(f.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests())},_changeConnectStatus:function(a,b){for(var e in f._connectionPlugins)if(f._connectionPlugins.hasOwnProperty(e)){var d=this[e];if(d.statusChanged)try{d.statusChanged(a,b)}catch(h){f.error(""+e+" plugin caused an exception changing status: "+h)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(h){f.error("User connection callback caused an exception: "+h)}},
_doDisconnect:function(a){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout);null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);f.info("_doDisconnect was called");this._proto._doDisconnect();this.restored=this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(f.Status.DISCONNECTED,a);this.connected=
!1},_dataRecv:function(a,b){f.info("_dataRecv called");var e=this._proto._reqToData(a);if(null!==e){this.xmlInput!==f.Connection.prototype.xmlInput&&(e.nodeName===this._proto.strip&&e.childNodes.length?this.xmlInput(e.childNodes[0]):this.xmlInput(e));this.rawInput!==f.Connection.prototype.rawInput&&(b?this.rawInput(b):this.rawInput(f.serialize(e)));for(var d;0<this.removeHandlers.length;)d=this.removeHandlers.pop(),d=this.handlers.indexOf(d),0<=d&&this.handlers.splice(d,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());
if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else if(d=e.getAttribute("type"),null!==d&&"terminate"==d)this.disconnecting||(d=e.getAttribute("condition"),e=e.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==d&&0<e.length&&(d="conflict"),this._changeConnectStatus(f.Status.CONNFAIL,d)):this._changeConnectStatus(f.Status.CONNFAIL,"unknown"),this._doDisconnect(d));else{var h=this;f.forEachChild(e,null,function(a){var b,e;e=h.handlers;h.handlers=[];for(b=0;b<e.length;b++){var d=
e[b];try{!d.isMatch(a)||!h.authenticated&&d.user?h.handlers.push(d):d.run(a)&&h.handlers.push(d)}catch(g){f.warn("Removing Strophe handlers due to uncaught exception: "+g.message)}}})}}},mechanisms:{},_connect_cb:function(a,b,e){f.info("_connect_cb was called");this.connected=!0;var d;try{d=this._proto._reqToData(a)}catch(h){if("badformat"!=h)throw h;this._changeConnectStatus(f.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(d&&(this.xmlInput!==f.Connection.prototype.xmlInput&&(d.nodeName===
this._proto.strip&&d.childNodes.length?this.xmlInput(d.childNodes[0]):this.xmlInput(d)),this.rawInput!==f.Connection.prototype.rawInput&&(e?this.rawInput(e):this.rawInput(f.serialize(d))),this._proto._connect_cb(d)!==f.Status.CONNFAIL)){this._authentication.sasl_scram_sha1=!1;this._authentication.sasl_plain=!1;this._authentication.sasl_digest_md5=!1;this._authentication.sasl_anonymous=!1;this._authentication.legacy_auth=!1;var g;g=d.getElementsByTagNameNS?0<d.getElementsByTagNameNS(f.NS.STREAM,"features").length:
0<d.getElementsByTagName("stream:features").length||0<d.getElementsByTagName("features").length;a=d.getElementsByTagName("mechanism");e=[];var k;k=!1;if(g){if(0<a.length)for(g=0;g<a.length;g++)k=f.getText(a[g]),this.mechanisms[k]&&e.push(this.mechanisms[k]);this._authentication.legacy_auth=0<d.getElementsByTagName("auth").length;(k=this._authentication.legacy_auth||0<e.length)?!1!==this.do_authentication&&this.authenticate(e):this._proto._no_auth_received(b)}else this._proto._no_auth_received(b)}},
authenticate:function(a){var b;for(b=0;b<a.length-1;++b){for(var e=b,h=b+1;h<a.length;++h)a[h].prototype.priority>a[e].prototype.priority&&(e=h);e!=b&&(h=a[b],a[b]=a[e],a[e]=h)}e=!1;for(b=0;b<a.length;++b)if(a[b].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),
null,"challenge",null,null);this._sasl_mechanism=new a[b];this._sasl_mechanism.onStart(this);a=g("auth",{xmlns:f.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(b=this._sasl_mechanism.onChallenge(this,null),a.t(d.encode(b)));this.send(a.tree());e=!0;break}e||(null===f.getNodeFromJid(this.jid)?(this._changeConnectStatus(f.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(f.Status.AUTHENTICATING,
null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(k({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).tree())))},_sasl_challenge_cb:function(a){a=d.decode(f.getText(a));a=this._sasl_mechanism.onChallenge(this,a);var b=g("response",{xmlns:f.NS.SASL});""!==a&&b.t(d.encode(a));this.send(b.tree());return!0},_auth1_cb:function(a){a=k({type:"set",id:"_auth_2"}).c("query",{xmlns:f.NS.AUTH}).c("username",
{}).t(f.getNodeFromJid(this.jid)).up().c("password").t(this.pass);f.getResourceFromJid(this.jid)||(this.jid=f.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(f.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){if(this._sasl_data["server-signature"]){var b;a=d.decode(f.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"==a[1]&&(b=a[2]);if(b!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),
this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}f.info("SASL authentication succeeded.");if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var e=[],h=function(a,
b){for(;a.length;)this.deleteHandler(a.pop());this._sasl_auth1_cb.bind(this)(b);return!1};e.push(this._addSysHandler(function(a){h.bind(this)(e,a)}.bind(this),null,"stream:features",null,null));e.push(this._addSysHandler(function(a){h.bind(this)(e,a)}.bind(this),f.NS.STREAM,"features",null,null));this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var b,e;for(b=0;b<a.childNodes.length;b++)e=a.childNodes[b],"bind"==e.nodeName&&(this.do_bind=!0),"session"==e.nodeName&&(this.do_session=
!0);this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=f.getResourceFromJid(this.jid))?this.send(k({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).c("resource",{}).t(a).tree()):this.send(k({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).tree())):this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type")){f.info("SASL binding failed.");var b;0<a.getElementsByTagName("conflict").length&&
(b="conflict");this._changeConnectStatus(f.Status.AUTHFAIL,b);return!1}a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=f.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(k({type:"set",id:"_session_auth_2"}).c("session",{xmlns:f.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)));else return f.info("SASL binding failed."),
this._changeConnectStatus(f.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(f.info("Session creation failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),
this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(f.Status.AUTHFAIL,null),this.disconnect("authentication failed"));return!1},_addSysTimedHandler:function(a,b){var e=new f.TimedHandler(a,b);e.user=!1;this.addTimeds.push(e);
return e},_addSysHandler:function(a,b,e,d,h){a=new f.Handler(a,b,e,d,h);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){f.info("_onDisconnectTimeout was called");this._proto._onDisconnectTimeout();this._doDisconnect();return!1},_onIdle:function(){for(var a,b,e,d;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var h=(new Date).getTime();
d=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)e=b.lastCalled+b.period,0>=e-h?b.run()&&d.push(b):d.push(b);this.timedHandlers=d;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}};f.SASLMechanism=function(a,b,e){this.name=a;this.isClientFirst=b;this.priority=e};f.SASLMechanism.prototype={test:function(a){return!0},onStart:function(a){this._connection=a},onChallenge:function(a,
b){throw Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};f.SASLAnonymous=function(){};f.SASLAnonymous.prototype=new f.SASLMechanism("ANONYMOUS",!1,10);f.SASLAnonymous.test=function(a){return null===a.authcid};f.Connection.prototype.mechanisms[f.SASLAnonymous.prototype.name]=f.SASLAnonymous;f.SASLPlain=function(){};f.SASLPlain.prototype=new f.SASLMechanism("PLAIN",!0,20);f.SASLPlain.test=function(a){return null!==
a.authcid};f.SASLPlain.prototype.onChallenge=function(a){var b=a.authzid,b=b+"\x00"+a.authcid,b=b+"\x00"+a.pass;return h.utf16to8(b)};f.Connection.prototype.mechanisms[f.SASLPlain.prototype.name]=f.SASLPlain;f.SASLSHA1=function(){};f.SASLSHA1.prototype=new f.SASLMechanism("SCRAM-SHA-1",!0,40);f.SASLSHA1.test=function(a){return null!==a.authcid};f.SASLSHA1.prototype.onChallenge=function(f,g,k){g=k||b.hexdigest(1234567890*Math.random());k="n="+h.utf16to8(f.authcid);k=k+",r="+g;f._sasl_data.cnonce=g;
f._sasl_data["client-first-message-bare"]=k;k="n,,"+k;this.onChallenge=function(b,f){var g,k,l,q,v,p,u="c=biws,",z=b._sasl_data["client-first-message-bare"]+","+f+",";p=b._sasl_data.cnonce;for(v=/([a-z]+)=([^,]+)(,|$)/;f.match(v);)switch(q=f.match(v),f=f.replace(q[0],""),q[1]){case "r":g=q[2];break;case "s":k=q[2];break;case "i":l=q[2]}if(g.substr(0,p.length)!==p)return b._sasl_data={},b._sasl_failure_cb();u+="r="+g;z+=u;k=d.decode(k);k+="\x00\x00\x00\u0001";p=h.utf16to8(b.pass);k=g=a.core_hmac_sha1(p,
k);for(v=1;v<l;v++){q=a.core_hmac_sha1(p,a.binb2str(g));for(g=0;5>g;g++)k[g]^=q[g];g=q}k=a.binb2str(k);l=a.core_hmac_sha1(k,"Client Key");g=a.str_hmac_sha1(k,"Server Key");k=a.core_hmac_sha1(a.str_sha1(a.binb2str(l)),z);b._sasl_data["server-signature"]=a.b64_hmac_sha1(g,z);for(g=0;5>g;g++)l[g]^=k[g];return u+=",p="+d.encode(a.binb2str(l))}.bind(this);return k};f.Connection.prototype.mechanisms[f.SASLSHA1.prototype.name]=f.SASLSHA1;f.SASLMD5=function(){};f.SASLMD5.prototype=new f.SASLMechanism("DIGEST-MD5",
!1,30);f.SASLMD5.test=function(a){return null!==a.authcid};f.SASLMD5.prototype._quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};f.SASLMD5.prototype.onChallenge=function(a,e,d){var f=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;d=d||b.hexdigest(""+1234567890*Math.random());for(var g="",k=null,l="",r;e.match(f);)switch(r=e.match(f),e=e.replace(r[0],""),r[2]=r[2].replace(/^"(.+)"$/,"$1"),r[1]){case "realm":g=r[2];break;case "nonce":l=r[2];break;case "host":k=r[2]}e=a.servtype+"/"+
a.domain;null!==k&&(e=e+"/"+k);f=h.utf16to8(a.authcid+":"+g+":"+this._connection.pass);f=b.hash(f)+":"+l+":"+d;k="AUTHENTICATE:"+e;a="charset=utf-8,"+("username="+this._quote(h.utf16to8(a.authcid))+",");a+="realm="+this._quote(g)+",";a+="nonce="+this._quote(l)+",";a+="nc=00000001,";a+="cnonce="+this._quote(d)+",";a+="digest-uri="+this._quote(e)+",";a+="response="+b.hexdigest(b.hexdigest(f)+":"+l+":00000001:"+d+":auth:"+b.hexdigest(k))+",";a+="qop=auth";this.onChallenge=function(){return""}.bind(this);
return a};f.Connection.prototype.mechanisms[f.SASLMD5.prototype.name]=f.SASLMD5;return{Strophe:f,$build:g,$msg:function(a){return new f.Builder("message",a)},$iq:k,$pres:l,SHA1:a,Base64:d,MD5:b}});(function(a,d){if("function"===typeof define&&define.amd)define("strophe-bosh",["strophe-core"],function(a){return d(a.Strophe,a.$build)});else return d(Strophe,$build)})(this,function(a,d){a.Request=function(b,d,g,k){this.id=++a._requestId;this.xmlData=b;this.data=a.serialize(b);this.func=this.origFunc=
d;this.rid=g;this.date=NaN;this.sends=k||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?(new Date-this.dead)/1E3:0};this.xhr=this._newXHR()};a.Request.prototype={getResponse:function(){var b=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(b=this.xhr.responseXML.documentElement,"parsererror"==b.tagName)throw a.error("invalid response received"),a.error("responseText: "+this.xhr.responseText),
a.error("responseXML: "+a.serialize(this.xhr.responseXML)),"parsererror";}else if(this.xhr.responseText)throw a.error("invalid response received"),a.error("responseText: "+this.xhr.responseText),"badformat";return b},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};a.Bosh=function(a){this._conn=
a;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]};a.Bosh.prototype={strip:null,_buildBody:function(){var b=d("body",{rid:this.rid++,xmlns:a.NS.HTTPBIND});null!==this.sid&&b.attrs({sid:this.sid});this._conn.options.keepalive&&this._cacheSession();return b},_reset:function(){this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.errors=0;window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},
_connect:function(b,d,g){this.wait=b||this.wait;this.hold=d||this.hold;this.errors=0;b=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":a.NS.BOSH});g&&b.attrs({route:g});g=this._conn._connect_cb;this._requests.push(new a.Request(b.tree(),this._onRequestStateChange.bind(this,g.bind(this._conn)),b.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(b,d,
g,k,l,f,q){this._conn.jid=b;this.sid=d;this.rid=g;this._conn.connect_callback=k;this._conn.domain=a.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=l||this.wait;this.hold=f||this.hold;this.window=q||this.window;this._conn._changeConnectStatus(a.Status.ATTACHED,null)},_restore:function(b,d,g,k,l){var f=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if("undefined"!==typeof f&&null!==f&&f.rid&&f.sid&&f.jid&&("undefined"===typeof b||"null"===
b||a.getBareJidFromJid(f.jid)==a.getBareJidFromJid(b)))this._conn.restored=!0,this._attach(f.jid,f.sid,f.rid,d,g,k,l);else throw{name:"StropheSessionError",message:"_restore: no restoreable session."};},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(b){var d=b.getAttribute("type");
if(null!==d&&"terminate"==d)return d=b.getAttribute("condition"),a.error("BOSH-Connection failed: "+d),b=b.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==d&&0<b.length&&(d="conflict"),this._conn._changeConnectStatus(a.Status.CONNFAIL,d)):this._conn._changeConnectStatus(a.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(d),a.Status.CONNFAIL;this.sid||(this.sid=b.getAttribute("sid"));if(d=b.getAttribute("requests"))this.window=parseInt(d,10);if(d=b.getAttribute("hold"))this.hold=
parseInt(d,10);if(b=b.getAttribute("wait"))this.wait=parseInt(b,10)},_disconnect:function(a){this._sendTerminate(a)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(4294967295*Math.random());window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_hitError:function(b){this.errors++;a.warn("request errored, status: "+b+", number of errors: "+this.errors);4<this.errors&&this._conn._onDisconnectTimeout()},
_no_auth_received:function(b){b=b?b.bind(this._conn):this._conn._connect_cb.bind(this._conn);var d=this._buildBody();this._requests.push(new a.Request(d.tree(),this._onRequestStateChange.bind(this,b.bind(this._conn)),d.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){}},_onIdle:function(){var b=
this._conn._data;this._conn.authenticated&&0===this._requests.length&&0===b.length&&!this._conn.disconnecting&&(a.info("no requests during idle cycle, sending blank request"),b.push(null));if(!this._conn.paused){if(2>this._requests.length&&0<b.length){for(var d=this._buildBody(),g=0;g<b.length;g++)null!==b[g]&&("restart"===b[g]?d.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":a.NS.BOSH}):d.cnode(b[g]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new a.Request(d.tree(),
this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),d.tree().getAttribute("rid")));this._throttledRequestHandler()}0<this._requests.length&&(b=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(a.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),b>Math.floor(a.TIMEOUT*this.wait)&&(a.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(a.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},
_onRequestStateChange:function(b,d){a.debug("request id "+d.id+"."+d.sends+" state changed to "+d.xhr.readyState);if(d.abort)d.abort=!1;else{var g;if(4==d.xhr.readyState){g=0;try{g=d.xhr.status}catch(f){}"undefined"==typeof g&&(g=0);if(this.disconnecting&&400<=g)this._hitError(g);else{var k=this._requests[0]==d,l=this._requests[1]==d;if(0<g&&500>g||5<d.sends)this._removeRequest(d),a.debug("request id "+d.id+" should now be removed");if(200==g)(l||k&&0<this._requests.length&&this._requests[0].age()>
Math.floor(a.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(d.rid)+1),a.debug("request id "+d.id+"."+d.sends+" got 200"),b(d),this.errors=0;else if(a.error("request id "+d.id+"."+d.sends+" error "+g+" happened"),0===g||400<=g&&600>g||12E3<=g)this._hitError(g),400<=g&&500>g&&(this._conn._changeConnectStatus(a.Status.DISCONNECTING,null),this._conn._doDisconnect());0<g&&500>g||5<d.sends||this._throttledRequestHandler()}}}},_processRequest:function(b){var d=this,
g=this._requests[b],k=-1;try{4==g.xhr.readyState&&(k=g.xhr.status)}catch(q){a.error("caught an error in _requests["+b+"], reqStatus: "+k)}"undefined"==typeof k&&(k=-1);if(g.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var l=g.age(),l=!isNaN(l)&&l>Math.floor(a.TIMEOUT*this.wait),f=null!==g.dead&&g.timeDead()>Math.floor(a.SECONDARY_TIMEOUT*this.wait),k=4==g.xhr.readyState&&(1>k||500<=k);if(l||f||k)f&&a.error("Request "+this._requests[b].id+" timed out (secondary), restarting"),
g.abort=!0,g.xhr.abort(),g.xhr.onreadystatechange=function(){},this._requests[b]=new a.Request(g.xmlData,g.origFunc,g.rid,g.sends),g=this._requests[b];if(0===g.xhr.readyState){a.debug("request id "+g.id+"."+g.sends+" posting");try{g.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0),g.xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8"),this._conn.options.withCredentials&&(g.xhr.withCredentials=!0)}catch(q){a.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(a.Status.CONNFAIL,
"bad-service");this._conn.disconnect();return}b=function(){g.date=new Date;if(d._conn.options.customHeaders){var a=d._conn.options.customHeaders,b;for(b in a)a.hasOwnProperty(b)&&g.xhr.setRequestHeader(b,a[b])}g.xhr.send(g.data)};1<g.sends?setTimeout(b,1E3*Math.min(Math.floor(a.TIMEOUT*this.wait),Math.pow(g.sends,3))):b();g.sends++;this._conn.xmlOutput!==a.Connection.prototype.xmlOutput&&(g.xmlData.nodeName===this.strip&&g.xmlData.childNodes.length?this._conn.xmlOutput(g.xmlData.childNodes[0]):this._conn.xmlOutput(g.xmlData));
this._conn.rawOutput!==a.Connection.prototype.rawOutput&&this._conn.rawOutput(g.data)}else a.debug("_processRequest: "+(0===b?"first":"second")+" request has readyState of "+g.xhr.readyState)}},_removeRequest:function(b){a.debug("removing request");var d;for(d=this._requests.length-1;0<=d;d--)b==this._requests[d]&&this._requests.splice(d,1);b.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var e=this._requests[a];null===e.dead&&(e.dead=new Date);this._processRequest(a)},
_reqToData:function(a){try{return a.getResponse()}catch(e){if("parsererror"!=e)throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(b){a.info("_sendTerminate was called");var d=this._buildBody().attrs({type:"terminate"});b&&d.cnode(b.tree());b=new a.Request(d.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),d.tree().getAttribute("rid"));this._requests.push(b);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);
this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(this._conn._onIdle.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?a.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):a.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&
Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};return a});(function(a,d){if("function"===typeof define&&define.amd)define("strophe-websocket",["strophe-core"],function(a){return d(a.Strophe,a.$build)});else return d(Strophe,$build)})(this,function(a,d){a.Websocket=function(a){this._conn=a;this.strip="wrapper";var e=a.service;if(0!==e.indexOf("ws:")&&0!==e.indexOf("wss:")){var d="",d="ws"===a.options.protocol&&"https:"!==window.location.protocol?d+"ws":
d+"wss",d=d+("://"+window.location.host),d=0!==e.indexOf("/")?d+(window.location.pathname+e):d+e;a.service=d}};a.Websocket.prototype={_buildStream:function(){return d("open",{xmlns:a.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(b,d){var g;g=b.getElementsByTagNameNS?b.getElementsByTagNameNS(a.NS.STREAM,"error"):b.getElementsByTagName("stream:error");if(0===g.length)return!1;for(var k=g[0],l=g="",f=0;f<k.childNodes.length;f++){var q=k.childNodes[f];if("urn:ietf:params:xml:ns:xmpp-streams"!==
q.getAttribute("xmlns"))break;"text"===q.nodeName?l=q.textContent:g=q.nodeName}k="WebSocket stream error: ";k=g?k+g:k+"unknown";l&&(k+=" - "+g);a.error(k);this._conn._changeConnectStatus(d,g);this._conn._doDisconnect();return!0},_reset:function(){},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},
_connect_cb:function(b){if(this._check_streamerror(b,a.Status.CONNFAIL))return a.Status.CONNFAIL},_handleStreamStart:function(b){var d=!1,g=b.getAttribute("xmlns");"string"!==typeof g?d="Missing xmlns in <open />":g!==a.NS.FRAMING&&(d="Wrong xmlns in <open />: "+g);b=b.getAttribute("version");"string"!==typeof b?d="Missing version in <open />":"1.0"!==b&&(d="Wrong version in <open />: "+b);return d?(this._conn._changeConnectStatus(a.Status.CONNFAIL,d),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(b){if(0===
b.data.indexOf("<open ")||0===b.data.indexOf("<?xml")){var d=b.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==d&&(d=(new DOMParser).parseFromString(d,"text/xml").documentElement,this._conn.xmlInput(d),this._conn.rawInput(b.data),this._handleStreamStart(d)&&this._connect_cb(d))}else 0===b.data.indexOf("<close ")?(this._conn.rawInput(b.data),this._conn.xmlInput(b),(b=b.getAttribute("see-other-uri"))?(this._conn._changeConnectStatus(a.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),
this._conn.service=b,this._connect()):(this._conn._changeConnectStatus(a.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(d=this._streamWrap(b.data),d=(new DOMParser).parseFromString(d,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(d,null,b.data))},_disconnect:function(b){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){b&&this._conn.send(b);b=d("close",{xmlns:a.NS.FRAMING});this._conn.xmlOutput(b);b=a.serialize(b);
this._conn.rawOutput(b);try{this.socket.send(b)}catch(h){a.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){a.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(a){return"<wrapper>"+a+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(a){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(a.error("Websocket closed unexcectedly"),
this._conn._doDisconnect()):a.info("Websocket closed")},_no_auth_received:function(b){a.error("Server did not send any auth methods");this._conn._changeConnectStatus(a.Status.CONNFAIL,"Server did not send any auth methods");b&&(b=b.bind(this._conn),b());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(b){a.error("Websocket error "+b);this._conn._changeConnectStatus(a.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");
this._disconnect()},_onIdle:function(){var b=this._conn._data;if(0<b.length&&!this._conn.paused){for(var d=0;d<b.length;d++)if(null!==b[d]){var g,k;g="restart"===b[d]?this._buildStream().tree():b[d];k=a.serialize(g);this._conn.xmlOutput(g);this._conn.rawOutput(k);this.socket.send(k)}this._conn._data=[]}},_onMessage:function(b){var d;if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===b.data)this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),this._conn.xmlInput(b),
this._conn.disconnecting||this._conn._doDisconnect();else{if(0===b.data.search("<open ")){if(d=(new DOMParser).parseFromString(b.data,"text/xml").documentElement,!this._handleStreamStart(d))return}else d=this._streamWrap(b.data),d=(new DOMParser).parseFromString(d,"text/xml").documentElement;this._check_streamerror(d,a.Status.ERROR)||(this._conn.disconnecting&&"presence"===d.firstChild.nodeName&&"unavailable"===d.firstChild.getAttribute("type")?(this._conn.xmlInput(d),this._conn.rawInput(a.serialize(d))):
this._conn._dataRecv(d,b.data))}},_onOpen:function(){a.info("Websocket open");var b=this._buildStream();this._conn.xmlOutput(b.tree());b=a.serialize(b);this._conn.rawOutput(b);this.socket.send(b)},_reqToData:function(a){return a},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};return a});(function(a){"function"===typeof define&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],
function(a){return a})})(this);if(a)if("function"===typeof define&&define.amd)require(["strophe"],function(e){a(e.Strophe,e.$build,e.$msg,e.$iq,e.$pres)});else return a(Strophe,$build,$msg,$iq,$pres)})(function(a,e,d,b,h){window.Strophe=a;window.$build=e;window.$msg=d;window.$iq=b;window.$pres=h});Strophe.addConnectionPlugin("register",{_connection:null,init:function(a){this._connection=a;var e=0;Object.keys(Strophe.Status).forEach(function(a){e=Math.max(e,Strophe.Status[a])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGIFAIL=e+1;Strophe.Status.REGISTER=e+2;Strophe.Status.REGISTERED=e+3;Strophe.Status.CONFLICT=e+4;Strophe.Status.NOTACCEPTABLE=e+5;a.disco&&(a.disco.addFeature&&a.disco.addFeature(Strophe.NS.REGISTER),a.disco.addNode&&a.disco.addNode(Strophe.NS.REGISTER,
{items:[]}));var d=this,b=a.reset.bind(a);a.reset=function(){b();d.instructions="";d.fields={};d.registered=!1};var h=a._connect_cb.bind(a);a._connect_cb=function(b,e,f){if(d._registering)d._connect_cb_data={req:b,raw:f},d._register_cb(b,e,f)&&(d.processed_features=!0,delete d._registering);else if(d.processed_features){var g=a.xmlInput;a.xmlInput=Strophe.Connection.prototype.xmlInput;var v=a.rawInput;a.rawInput=Strophe.Connection.prototype.rawInput;h(b,e,f);a.xmlInput=g;a.rawInput=v;delete d.processed_features}else h(b,
e,f)};var g=a.authenticate.bind(a);a.authenticate=function(a){"undefined"===typeof a?(a=this._connection,this.fields.username&&this.domain&&this.fields.password?(a.jid=this.fields.username+"@"+this.domain,a.authzid=Strophe.getBareJidFromJid(a.jid),a.authcid=Strophe.getNodeFromJid(a.jid),a.pass=this.fields.password,a._connect_cb(this._connect_cb_data.req,a.connect_callback,this._connect_cb_data.raw)):Strophe.info("Register a JID first!")):g(a)}.bind(this)},connect:function(a,e,d,b,h){var g=this._connection;
this.domain=Strophe.getDomainFromJid(a);this.instructions="";this.fields={};this.registered=!1;this._registering=!0;g.connect(this.domain,"",e,d,b,h)},_register_cb:function(a,e,d){var b=this._connection;Strophe.info("_register_cb was called");b.connected=!0;if(a=b._proto._reqToData(a)){b.xmlInput!==Strophe.Connection.prototype.xmlInput&&(a.nodeName===b._proto.strip&&a.childNodes.length?b.xmlInput(a.childNodes[0]):b.xmlInput(a));b.rawInput!==Strophe.Connection.prototype.rawInput&&(d?b.rawInput(d):
b.rawInput(Strophe.serialize(a)));if(b._proto._connect_cb(a)===Strophe.Status.CONNFAIL)return!1;d=a.getElementsByTagName("register");a=a.getElementsByTagName("mechanism");if(0===d.length&&0===a.length)return b._proto._no_auth_received(e),!1;if(0===d.length)return b._changeConnectStatus(Strophe.Status.REGIFAIL,null),!0;b._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null);b.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree());return!0}},_get_register_cb:function(a){var e,
d,b=this._connection;e=a.getElementsByTagName("query");if(1!==e.length)return b._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;e=e[0];for(a=0;a<e.childNodes.length;a++)d=e.childNodes[a],"instructions"===d.tagName.toLowerCase()?b.register.instructions=Strophe.getText(d):"x"!==d.tagName.toLowerCase()&&(b.register.fields[d.tagName.toLowerCase()]=Strophe.getText(d));b._changeConnectStatus(Strophe.Status.REGISTER,null);return!1},submit:function(){var a,e,d,b,h=this._connection;d=$iq({type:"set"}).c("query",
{xmlns:Strophe.NS.REGISTER});b=Object.keys(this.fields);for(a=0;a<b.length;a++)e=b[a],d.c(e).t(this.fields[e]).up();h._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);h.send(d)},_submit_cb:function(a){var e,d,b;e=null;var h=this._connection;d=a.getElementsByTagName("query");if(0<d.length)for(d=d[0],e=0;e<d.childNodes.length;e++)b=d.childNodes[e],"instructions"===b.tagName.toLowerCase()?this.instructions=Strophe.getText(b):this.fields[b.tagName.toLowerCase()]=Strophe.getText(b);if("error"===
a.getAttribute("type")){e=a.getElementsByTagName("error");if(1!==e.length)return h._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;Strophe.info("Registration failed.");e=e[0].firstChild.tagName.toLowerCase();"conflict"===e?h._changeConnectStatus(Strophe.Status.CONFLICT,e):"not-acceptable"===e?h._changeConnectStatus(Strophe.Status.NOTACCEPTABLE,e):h._changeConnectStatus(Strophe.Status.REGIFAIL,e)}else Strophe.info("Registration successful."),h._changeConnectStatus(Strophe.Status.REGISTERED,
null);return!1}});Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(a){this._connection=a;this._identities=[];this._features=[];this._items=[];a.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);a.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(a,e,d,b){for(var h=0;h<this._identities.length;h++)if(this._identities[h].category==a&&this._identities[h].type==e&&this._identities[h].name==
d&&this._identities[h].lang==b)return!1;this._identities.push({category:a,type:e,name:d,lang:b});return!0},addFeature:function(a){for(var e=0;e<this._features.length;e++)if(this._features[e]==a)return!1;this._features.push(a);return!0},addItem:function(a,e,d,b){if(d&&!b)return!1;this._items.push({jid:a,name:e,node:d,call_back:b});return!0},info:function(a,e,d,b){var h={xmlns:Strophe.NS.DISCO_INFO};e&&(h.node=e);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",h);this._connection.sendIQ(a,
d,b)},items:function(a,e,d,b){var h={xmlns:Strophe.NS.DISCO_ITEMS};e&&(h.node=e);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",h);this._connection.sendIQ(a,d,b)},_onDiscoInfo:function(a){var e=a.getAttribute("id"),d=a.getAttribute("from"),b=a.getElementsByTagName("query")[0].getAttribute("node");a={xmlns:Strophe.NS.DISCO_INFO};b&&(a.node=b);e=$iq({type:"result",id:e,to:d}).c("query",a);for(d=0;d<this._identities.length;d++)a={category:this._identities[d].category,type:this._identities[d].type},
this._identities[d].name&&(a.name=this._identities[d].name),this._identities[d].lang&&(a["xml:lang"]=this._identities[d].lang),e.c("identity",a).up();for(d=0;d<this._features.length;d++)e.c("feature",{"var":this._features[d]}).up();this._connection.send(e.tree())},_onDiscoItems:function(a){var e=a.getAttribute("id"),d=a.getAttribute("from"),b={xmlns:Strophe.NS.DISCO_ITEMS},h=a.getElementsByTagName("query")[0].getAttribute("node");if(h){b.node=h;for(var g=null,k=0;k<this._items.length;k++)if(this._items[k].node==
h){g=this._items[k].call_back(a);break}}else g=this._items;a=$iq({type:"result",id:e,to:d}).c("query",b);for(k=0;k<g.length;k++)e={jid:g[k].jid},g[k].name&&(e.name=g[k].name),g[k].node&&(e.node=g[k].node),a.c("item",e).up();this._connection.send(a.tree())}});Ext.ns("Application");
Application.LoginPanel=Ext.extend(Ext.Panel,{initComponent:function(){this.items=[{html:'<img src="../images/nws.png" width="100"/>',height:105,width:105},{xtype:"panel",autoShow:!0,el:"myloginform",layout:"form",id:"myform",width:276,labelWidth:76,defaultType:"textfield",defaults:{allowBlank:!1},items:[{anchor:"100%",el:"username",id:"username",autoShow:!0,fieldLabel:"Username"},{anchor:"100%",el:"password",id:"password",autoShow:!0,fieldLabel:"Password",listeners:{specialkey:function(a,e){e.getKey()===
e.ENTER&&(Application.doLogin(),e.stopEvent())}}}],buttons:[{text:"Show Debug",handler:function(){Ext.getCmp("debug").show()}},{text:"Browser Save Login",handler:function(a,e){Ext.get("submit").dom.click()}},{text:"Login",handler:Application.doLogin}]},{xtype:"panel",colspan:2,contentEl:"loginmessage",preventBodyReset:!0}];Ext.apply(this,Ext.apply(this.initialConfig,{autoScroll:!0,title:"Login with Account",layout:"table",layoutConfig:{columns:2}}));Application.LoginPanel.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.insertFirst(this.items.items[2].body,{msg:a,date:new Date})}});Ext.namespace("Application");
Application.TabLoginPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{width:420,height:250,autoScroll:!0}));Application.TabLoginPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){Application.LOGIN_OPT_USER&&this.add(new Application.LoginPanel({id:"loginpanel"}));Application.LOGIN_OPT_ANONYMOUS&&this.add({xtype:"panel",contentEl:"anonymous_div",preventBodyReset:!0,title:"Anonymous Login"});Application.LOGIN_OPT_REGISTER&&
this.add({xtype:"panel",contentEl:"register_div",preventBodyReset:!0,title:"Register Account"});this.activate(0)}});Ext.reg("tabloginpanel",Application.TabLoginPanel);Ext.ns("Application");
Application.DebugWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{xtype:"panel",title:"Debug Log",html:"<p>Browser CodeName: "+navigator.appCodeName+"</p><p>Browser Name: "+navigator.appName+"</p><p>Browser Version: "+navigator.appVersion+"</p><p>Cookies Enabled: "+navigator.cookieEnabled+"</p><p>Platform: "+navigator.platform+"</p><p>User-agent header: "+navigator.userAgent+"</p>",autoScroll:!0}];this.tbar=[{text:"Click to send this log to developer!",icon:"icons/print.png",scope:this,
handler:function(){Ext.Ajax.request({url:"bug.php",method:"POST",success:function(a){alert(a.responseText)},failure:function(){},headers:{"my-header":"foo"},params:{data:this.items.items[0].body.dom.innerHTML,user:Application.USERNAME}})}},{text:"Clear Log",icon:"icons/close.png",handler:function(){this.items.items[0].update("")},scope:this}];Ext.apply(this,Ext.apply(this.initialConfig,{width:600,height:300,title:"Debug Window",closeAction:"hide",hidden:!0,autoScroll:!0,layout:"fit"}));Application.DebugWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.append(this.items.items[0].body,{msg:a,date:new Date})}});Ext.ns("Application");
Application.MUCChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",chatType:"groupchat",barejid:null,handle:null,anonymous:null,joinedChat:!1,initComponent:function(){this.items=[{xtype:"chatgridpanel",region:"center"},{xtype:"chattextentry",region:"south",height:50,split:!0}];"allchats"!=this.initialConfig.chatType?(this.items.push({xtype:"mucroomusers",region:"east",width:175,collapsible:!0,split:!0}),this.iconCls="tabno"):this.items[1].emptyText="Type message here";Ext.apply(this,
Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.iconCls&&a.setIconCls("tabno")},deactivate:function(a){a.iconCls&&a.setIconCls("tabno")}}}));Application.MUCChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},clearRoom:function(){this.gp.getStore().removeAll();this.roomusers.root.removeAll()},getJidByHandle:function(a){a=this.roomusers.root.findChild("text",a);return null==a||Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPMUCHOST?null:a.attributes.jid},
buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];if("allchats"==this.chatType)this.gp.toolbars[0].items.items[4].disable(),this.gp.soundOn=!1,this.te.items.items[1].setText("To Room?");else{this.roomusers=this.items.items[2];new Ext.tree.TreeSorter(this.roomusers,{folderSort:!0,dir:"asc",property:"text"});this.anonymous&&this.te.disable();var a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::mute";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[4].toggle(!0,
!0),this.gp.toolbars[0].items.items[4].setText("Sounds Muted"),this.gp.soundOn=!1);a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::nwsbothidden";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[3].toggle(!0,!0),this.gp.toolbars[0].items.items[3].setText("NWSBot Hidden"),this.gp.store.filterBy(nwsbotFilter))}}});Ext.reg("mucchatpanel",Application.MUCChatPanel);Ext.ns("Application");
Application.MUCRoomUsers=Ext.extend(Ext.tree.TreePanel,{bodyStyle:{"margin-left":"-15px"},title:"0 people in room",rootVisible:!1,lines:!1,autoScroll:!0,initComponent:function(){this.root={text:"test",listeners:{append:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")},remove:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")}}};var a={plugins:new Ext.ux.DataTip({tpl:"<div>JID: {jid}<br />Affiliation: {affiliation}<br />Role: {role}</div>",constrainPosition:!0}),
listeners:{click:function(a){if(a.attributes.jid&&(username=Strophe.getNodeFromJid(a.attributes.jid),username!=Application.USERNAME)){var d=a.attributes.jid;Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPHOST&&(d=Strophe.getBareJidFromJid(a.attributes.jid));Application.log("Wish to start chat with:"+d);(cp=Ext.getCmp("chatpanel").getChat(d))||(cp=Ext.getCmp("chatpanel").addChat(d));Ext.getCmp("chatpanel").setActiveTab(cp)}}}};Ext.apply(this,Ext.apply(this.initialConfig,a));Application.MUCRoomUsers.superclass.initComponent.apply(this,
arguments);this.buildItems()},buildItems:function(){}});Ext.reg("mucroomusers",Application.MUCRoomUsers);Ext.ns("Application");Application.colors="000000 666666 D51460 FF0000 993333 FF9900 005500 009900 00DD00 0066CC 3399FF 0000FF 6666FF".split(" ");Application.colorpointer=0;Application.UserColorStore=new Ext.data.Store({fields:["user","color"]});
Application.getUserColor=function(a){idx=Application.UserColorStore.find("user",a);-1==idx?(c=Application.colors[Application.colorpointer],Application.UserColorStore.add(new Ext.data.Record({user:a,color:c})),Application.colorpointer++,12<Application.colorpointer&&(Application.colorpointer=0)):c=Application.UserColorStore.getAt(idx).get("color");return c};Ext.ns("Application");
Application.msgFormatter=new Ext.XTemplate('<p class="mymessage">',"<span ",'<tpl if="values.me == values.author">','class="author-me"',"</tpl>",'<tpl if="values.me != values.author">','class="{[this.getAuthorClass(values.jid)]}" style="color: #{[Application.getUserColor(values.author)]};"',"</tpl>",">(",'<tpl if="this.isNotToday(ts)">','{ts:date("d M")} ',"</tpl>",'{ts:date("g:i A")}) ','<tpl if="values.room != null">',"[{room}] ","</tpl>","{author}:</span> ","{message}</p>",{isNotToday:function(a){return(new Date).format("md")!=
a.format("md")},getAuthorClass:function(a){return null==a?"author-default":"nwsbot"==Strophe.getNodeFromJid(a)?"author-nwsbot":Strophe.getNodeFromJid(a).match(/^nws/)?"author-nws":"author-chatpartner"}});
Application.ChatGridPanel=Ext.extend(Ext.grid.GridPanel,{region:"center",soundOn:!0,nwsbotHide:!1,stripeRows:!0,autoExpandColumn:"message",autoScroll:!0,tbar:[{text:"Clear Room Log",cls:"x-btn-text-icon",icon:"icons/close.png",handler:function(a,e){a.ownerCt.ownerCt.getStore().removeAll()}},{text:"Print Log",icon:"icons/print.png",cls:"x-btn-text-icon",handler:function(a,e){a.ownerCt.ownerCt.getGridEl().print({isGrid:!0})}},{text:"View As HTML",handler:function(a,e){showHtmlVersion(a.ownerCt.ownerCt)},
icon:"icons/text.png",cls:"x-btn-text-icon"},{text:"Hide NWSBot",enableToggle:!0,toggleHandler:function(a,e){var d="muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::nwsbothidden",b=a.ownerCt.ownerCt.getStore();(a.ownerCt.ownerCt.nwsbotHide=e)?(Application.setPreference(d,"true"),b.filterBy(nwsbotFilter),a.setText("NWSBot Hidden")):(Application.removePreference(d),b.clearFilter(!1),a.setText("Hide NWSBot"))}},{text:"Mute Sounds",enableToggle:!0,toggleHandler:function(a,e){var d=
"muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::mute";e?(Application.setPreference(d,"true"),a.ownerCt.ownerCt.soundOn=!1,a.setText("Sounds Muted")):(Application.removePreference(d),a.ownerCt.ownerCt.soundOn=!0,a.setText("Mute Sounds"))}},{icon:"icons/font-less.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))-2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message",
"font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}},{icon:"icons/font-more.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))+2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}}],initComponent:function(){this.columns=[{header:"Author",sortable:!0,dataIndex:"author",hidden:!0},{id:"message",
header:"Message",sortable:!0,dataIndex:"ts",scope:this,renderer:function(a,d,b){return Application.msgFormatter.apply({author:b.get("author"),message:b.get("message"),ts:b.get("ts"),room:b.get("room"),jid:b.get("jid"),me:this.ownerCt.handle})}}];this.store=new Ext.data.ArrayStore({sortInfo:{field:"ts",direction:"ASC"},fields:[{name:"ts",type:"date"},"author","message","product_id","jid","room",{name:"xdelay",type:"boolean"}]});this.store.on("add",function(a,d,b){if(!this.soundOn)return!0;a=!1;b=!0;
for(var h=0;h<d.length;h++)d[h].get("xdelay")||d[h].get("author")==this.ownerCt.handle||("nwsbot"!=d[h].get("author")&&(a=!0),d[h].get("message").match(/tornado/i)&&Application.MsgBus.fireEvent("soundevent","tornado"),d[h].get("message").match(this.ownerCt.handle)&&Application.MsgBus.fireEvent("soundevent","myhandle"),b=!1);if(b)return!0;a?(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent","new_message")):this.nwsbotHide||(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent",
"nwsbot"))},this);var a={viewConfig:{onAdd:function(a,d,b){this.constructor.prototype.onAdd.apply(this,arguments);(row=this.grid.getView().getRow(b))&&row.scrollIntoView()},templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}"  tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},sm:new Ext.grid.RowSelectionModel({listeners:{rowselect:function(a,d,b){b.data.product_id&&(Application.TextWindow.show(),
Application.TextWindow.load({params:{pid:b.data.product_id,bypass:1},text:"Loading...",method:"GET",url:"../p.php"}))}}}),listeners:{render:function(a){a.getView().mainBody.on("mousedown",function(a,b){"A"==b.tagName&&(a.stopEvent(),b.target="_blank")});a.body.on({mousedown:function(a,b){b.target="_blank";Application.TextWindow.hide()},click:function(a,b){"_blank"!=String(b.target).toLowerCase()&&(a.stopEvent(),window.open(b.href));Application.TextWindow.hide()},delegate:"a"})}}};Ext.apply(this,a);
Application.ChatGridPanel.superclass.initComponent.apply(this,arguments)}});Ext.reg("chatgridpanel",Application.ChatGridPanel);Ext.ns("Application");
Application.ChatTextEntry=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},border:!1,chatstate:null,initComponent:function(){this.items=[{xtype:"textarea",flex:1,cls:"message-entry-box",autoCreate:{tag:"textarea",style:'rows:10;cols:72;wrap:"hard";',autocomplete:"off"},style:{background:"#"+Application.getPreference("bgcolor","FFFFFF"),color:"#"+Application.getPreference("fgcolor","000000")},enableKeyEvents:!0,listeners:{keyup:function(a,e){if(e.getKey()===e.ENTER&&!e.shiftKey)return this.chatstate&&
this.chatstate.cancel(),this.chatstate=null,this.ownerCt.getComponent(1).handler(),!0;"chat"==this.ownerCt.ownerCt.chatType&&(this.chatstate||(this.chatstate=new Ext.util.DelayedTask(function(){this.ownerCt&&this.ownerCt.ownerCt&&(Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("paused",{xmlns:"http://jabber.org/protocol/chatstates"})),this.chatstate=null)},this),Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}))),this.chatstate.delay(5E3))},render:{delay:500,fn:function(){this.focus()}}}},{xtype:"button",text:"Send",width:60,popup:null,handler:function(){var a=this.ownerCt.getComponent(0),e=a.getValue().trim();if(0===e.length)return a.focus(),!1;var d=Application.getPreference("bgcolor","FFFFFF"),b=Application.getPreference("fgcolor","000000");if("allchats"==this.ownerCt.ownerCt.chatType)a.emptyText="",a.setValue(""),(new Application.AllChatMessageWindow({message:Application.replaceURLWithHTMLLinks(e)})).show();
else{for(var h=$.parseHTML(Application.replaceURLWithHTMLLinks(e)),g=$msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("active",{xmlns:"http://jabber.org/protocol/chatstates"}).up().c("body").t(e).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+b+";background:#"+d+";"}),k=0;k<h.length;k++)g=g.cnode(h[k]),k<h.length&&(g=g.up());Application.XMPPConn.send(g);a.setValue("");a.focus();
"chat"==this.ownerCt.ownerCt.chatType&&(e="<span style='color:#"+b+";background:#"+d+";'>"+e+"</span>",this.ownerCt.ownerCt.gp.getStore().addSorted(new Ext.data.Record({ts:new Date,author:Application.USERNAME,message:Application.replaceURLWithHTMLLinks(e)})))}}}];Application.ChatTextEntry.superclass.initComponent.apply(this,arguments)}});Ext.reg("chattextentry",Application.ChatTextEntry);Ext.ns("Application");
Application.ChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",iconCls:"tabno",chatType:"chat",barejid:null,handle:null,anonymous:null,initComponent:function(){this.items=[new Application.ChatGridPanel({region:"center"}),new Application.ChatTextEntry({region:"south",height:50,split:!0})];Ext.apply(this,Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.setIconCls("tabno")},deactivate:function(a){a.setIconCls("tabno")},beforedestroy:function(a){a.te.chatstate&&a.te.chatstate.cancel();
Application.XMPPConn.send($msg({to:a.barejid,type:a.chatType}).c("gone",{xmlns:"http://jabber.org/protocol/chatstates"}))}}}));Application.ChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},getJidByHandle:function(a){return this.barejid},buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3]);this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3])}});
Ext.reg("chatpanel",Application.ChatPanel);Ext.ns("Application");
Application.LiveViewport=Ext.extend(Ext.Viewport,{initComponent:function(){var a={xtype:"panel",region:"north",height:10,hidden:!0,title:"Map Disabled by URL"};this.initialConfig.enableMap&&(a={xtype:"panel",layout:"border",region:"north",collapsible:!0,title:"Map Panel",height:300,split:!0,items:[Application.MapPanel,Application.LayerTree]});this.items=[Application.Control,{xtype:"panel",region:"center",layout:"border",items:[a,new Application.ChatTabPanel({id:"chatpanel",region:"center",split:!0})]}];
Ext.apply(this,Ext.apply(this.initialConfig,{layout:"border"}));Application.LiveViewport.superclass.initComponent.call(this);this.doStuff()},doStuff:function(){var a=Ext.getCmp("map");a&&(a.map.events.register("changelayer",null,function(a){a={lstring:""};Application.layerstore.data.each(function(a){a=a.getLayer();a.getVisibility()&&(this.lstring+="||"+a.name)},a);Application.setPreference("layers",a.lstring)}),Ext.TaskMgr.start(Application.MapTask));new Application.DebugWindow({id:"debug",renderTo:Ext.getBody()});
(new Ext.Window({id:"loginwindow",modal:!0,closable:!1,title:"NWSChat Live Login Options",items:[new Application.TabLoginPanel]})).show()}});Ext.ns("Application");Application.MapLegend=Ext.extend(Ext.Window,{width:300,height:200,autoScroll:!0,title:"Map Legends",hidden:!0,autoScroll:!0,closeAction:"hide",initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.MapLegend.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){}});Ext.ns("Ext.ux.grid");Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(a,e,d,b,h){if("mousedown"==a){var g=d.store.getAt(b);g.set(this.dataIndex,!g.data[this.dataIndex]);return!1}return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments)},renderer:function(a,e,d){e.css+=" x-grid3-check-col-td";return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',a?"-on":"")},init:Ext.emptyFn});Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn);
Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function a(){var a=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(a);this.dataTip.initTarget(a)}function e(a,b){a.rendered?a.update(b):Ext.isString(b)?a.html=b:a.data=b}function d(a){var b=Ext.fly(a.triggerElement).findParent("div.x-tree-node-el",null,!0);if(b=b?a.host.getNodeById(b.getAttribute("tree-node-id","ext")):null)e(a,b.attributes);else return!1}function b(a){var b=this.host.getStore().getAt(this.host.getView().findRowIndex(a.triggerElement));
if(b)e(a,b.data);else return!1}function h(a){var b=this.host.getRecord(a.triggerElement);if(b)e(a,b.data);else return!1}function g(a){var b=Ext.fly(a.triggerElement).child("input,textarea");if((b=b?this.host.getForm().findField(b.id):null)&&(b.tooltip||a.tpl))e(a,b.tooltip||b);else return!1}function k(a){var b=this.host.store.getAt(this.host.selectedIndex);if(b)e(a,b.data);else return!1}return{init:function(e){e.dataTip=this;this.host=e;e instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||
"div.x-tree-node-el",this.on("beforeshow",d)):e instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||e.getView().rowSelector,this.on("beforeshow",b)):e instanceof Ext.DataView?(this.delegate=this.delegate||e.itemSelector,this.on("beforeshow",h)):e instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",g)):e instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||e.itemSelector,this.on("beforeshow",k));e.rendered?a.call(e):e.onRender=e.onRender.createSequence(a)}}}());Ext.ns("Application");
function onBuddyPresence(a){var e=a.getAttribute("from"),d=Strophe.getBareJidFromJid(e),b=Strophe.getResourceFromJid(e),h=Strophe.getNodeFromJid(e),g="Available";h==Application.USERNAME&&b!=Application.XMPPRESOURCE&&b.match(/^NWSChatLive/)&&("unavailable"==a.getAttribute("type")?Application.log("Self presence: ["+h+"] ["+b+"] unavailable"):Application.log("Self presence: ["+h+"] ["+b+"] available"));0<$(a).find("status").length&&(g=$(a).find("status").text());"subscribe"==a.getAttribute("type")?Ext.Msg.show({title:"New Buddy Request",
msg:"User "+h+" wishes to add you as a buddy. Is this okay?",buttons:Ext.Msg.YESNO,fn:function(a){"yes"==a?(a=$pres({to:e,type:"subscribed"}),Application.XMPPConn.send(a.tree()),Application.buildAddBuddy(h,h,"Buddies")):(a=$pres({to:e,type:"unsubscribed"}),Application.XMPPConn.send(a.tree()))},icon:Ext.MessageBox.QUESTION}):Ext.getCmp("buddies").root.eachChild(function(e){e.eachChild(function(e){e.attributes.barejid==d&&(((res=e.attributes.resources.get(b))||e.attributes.resources.add(b,{status:g,
resource:b}),a.getAttribute("type"))?"unavailable"==a.getAttribute("type")&&(1==e.attributes.resources.length&&(e.attributes.presence="offline",e.setIconCls("buddy-offline"),e.ui.hide()),e.attributes.resources.remove(b)):(0<$(a).find("show").length?e.setIconCls("buddy-away"):e.setIconCls("buddy-online"),e.attributes.presence="online",e.ui.show(),e.attributes.resources.replace(b,{status:g,resource:b})))})})};Ext.ns("Application");
Application.AllChatMessageWindow=Ext.extend(Ext.Window,{title:"Where to send this message?",width:460,height:300,modal:!0,layout:"form",layoutConfig:{},defaults:{width:450},initComponent:function(){this.buttons=[{text:"Send Message",scope:this,handler:function(){var a=this.find("name","columns")[0];Ext.each(a.findByType("checkbox"),function(a){a.checked&&Application.XMPPConn.send($msg({to:a.name+"@"+Application.XMPPMUCHOST,type:"groupchat"}).c("body").t(this.message).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",
{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+Application.getPreference("fgcolor","000000")+";background:#"+Application.getPreference("bgcolor","FFFFFF")+";"}).t(this.message))},this);this.close()}},{text:"Cancel",handler:function(){this.ownerCt.ownerCt.close()}}];Application.AllChatMessageWindow.superclass.initComponent.apply(this,arguments);this.buildItems(this.message);this.addAvailableRooms()},addAvailableRooms:function(){Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==
a.chatType&&!a.anonymous&&(a=Strophe.getNodeFromJid(a.barejid),0==this.items.items[1].find("name",a).length)){var e=this.find("name","columns")[0];pos=e.entries%3;e.items.items[pos].add({xtype:"checkbox",hideLabel:!0,boxLabel:a,name:a});e.entries+=1}},this)},buildItems:function(a){this.add({xtype:"textarea",hideLabel:!0,html:a});this.add({xtype:"fieldset",title:"Send my message to the following room(s):",autoHeight:!0,autoScroll:!0,items:[{entries:0,name:"columns",layout:"table",items:[{layout:"form",
border:!1,colname:"col1",width:140,items:[]},{layout:"form",border:!1,colname:"col2",width:140,items:[]},{width:140,border:!1,colname:"col3",layout:"form",items:[]}]}]})}});/*
 Licensed under the terms of the Open Source <a href="http://www.gnu.org/licenses/lgpl.html">LGPL 3.0 license</a>. Commercial use is permitted to the extent that the code/component(s) do NOT become part of another Open Source or Commercially licensed development library or toolkit without explicit permission.
 @version 2.0.0 (Feb 14, 2010)
*/
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel=Ext.extend(Ext.TabPanel,{arrowOffsetX:-9,arrowOffsetY:-8,initComponent:function(){Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);this.addEvents("reorder");this.ddGroupId||(this.ddGroupId="dd-tabpanel-group-"+Ext.ux.panel.DDTabPanel.superclass.getId.call(this))},reorder:function(a){this.fireEvent("reorder",this,a)},afterRender:function(){Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);this.arrow=Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>',
!0);this.arrow.hide();this.dd=new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup:this.ddGroupId});this.move=!1},initTab:function(a,e){Ext.ux.panel.DDTabPanel.superclass.initTab.call(this,a,e);var d=this.id+"__"+a.id;Ext.fly(d).on("click",function(){a.ownerCt.setActiveTab(a.id)});Ext.applyIf(a,{allowDrag:!0});Ext.apply(a,{ds:new Ext.dd.DragSource(d,{ddGroup:this.ddGroupId,dropEl:a,dropElHeader:Ext.get(d,!0),scroll:!1,onStartDrag:function(){if(this.dropEl.iconCls){var a=this.getProxy().getGhost().select(".x-tab-strip-text");
a.addClass("x-panel-inline-icon");var d=a.elements[0].innerHTML,d=Ext.util.Format.stripTags(d);a.elements[0].innerHTML=d;a.applyStyles({paddingLeft:"20px"})}},onMouseUp:function(a){this.dropEl.ownerCt.move?(this.dropEl.disabled||null!=this.dropEl.ownerCt.activeTab||this.dropEl.ownerCt.setActiveTab(this.dropEl),this.dropEl.ownerCt.move=!1):this.dropEl.isVisible()||this.dropEl.disabled||this.dropEl.show()}}),enableTabDrag:function(){this.allowDrag=!0;return this.ds.unlock()},disableTabDrag:function(){this.allowDrag=
!1;return this.ds.lock()}});a.allowDrag?a.enableTabDrag():a.disableTabDrag()},onRemove:function(a){var e=Ext.get(a.tabEl);e&&(e.select("a").removeAllListeners(),Ext.destroy(e));Ext.TabPanel.superclass.onRemove.call(this,a);this.stack.remove(a);delete a.tabEl;a.un("disable",this.onItemDisabled,this);a.un("enable",this.onItemEnabled,this);a.un("titlechange",this.onItemTitleChanged,this);a.un("iconchange",this.onItemIconChanged,this);a.un("beforeshow",this.onBeforeShowItem,this);a==this.activeTab&&(this.move?
this.activeTab=null:(a=this.stack.next())?this.setActiveTab(a):0<this.items.getCount()?this.setActiveTab(0):this.activeTab=null);this.destroying||this.delegateUpdates()},onDestroy:function(){Ext.destroy(this.dd,this.arrow);Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)}});
Ext.ux.panel.DDTabPanel.DropTarget=Ext.extend(Ext.dd.DropTarget,{constructor:function(a,e){this.tabpanel=a;Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(this,a.stripWrap,e)},notifyOver:function(a,e,d){var b=this.tabpanel.items,h=b.length;if(!e.within(this.getEl())||a.dropEl==this.tabpanel)return"x-dd-drop-nodrop";d=this.tabpanel.arrow;var g=this.el.getY(),k,l,f;e=e.getPageX();for(var q=0;q<h;q++){l=f;f=b.itemAt(q);var v=f.ds.dropElHeader,u=v.getX();if(e<=u+v.dom.clientWidth/2){k=
u;break}}if("undefined"==typeof k){k=b.itemAt(h-1);if(k==a.dropEl)return"x-dd-drop-nodrop";a=k.ds.dropElHeader.dom;k=(new Ext.Element(a)).getX()+a.clientWidth+3}else if(f==a.dropEl||l==a.dropEl)return this.tabpanel.arrow.hide(),"x-dd-drop-nodrop";d.setTop(g+this.tabpanel.arrowOffsetY).setLeft(k+this.tabpanel.arrowOffsetX).show();return"x-dd-drop-ok"},notifyDrop:function(a,e,d){this.tabpanel.arrow.hide();if(a.dropEl==this.tabpanel)return!1;d=this.tabpanel.items;var b=e.getPageX();for(e=0;e<d.length;e++){var h=
d.itemAt(e),g=h.ds.dropElHeader,g=g.getX()+g.dom.clientWidth/2;if(b<=g)break}if(h==a.dropEl||d.itemAt(e-1)==a.dropEl)return!1;a.proxy.hide();a.dropEl.ownerCt==this.tabpanel&&e>d.indexOf(a.dropEl)&&e--;this.tabpanel.move=!0;a=a.dropEl.ownerCt.remove(a.dropEl,!1);this.tabpanel.insert(e,a);this.tabpanel.fireEvent("drop",this.tabpanel);this.tabpanel.reorder(d.itemAt(e));return!0},notifyOut:function(a,e,d){this.tabpanel.arrow.hide()}});Ext.reg("ddtabpanel",Ext.ux.panel.DDTabPanel);Ext.ns("Application");
Application.ChatTabPanel=Ext.extend(Ext.ux.panel.DDTabPanel,{activeTab:0,deferredRender:!1,split:!0,enableTabScroll:!0,initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.ChatTabPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){this.add({contentEl:"help",title:"Help",preventBodyReset:!0,style:{margin:"5px"},autoScroll:!0});this.add(new Application.MUCChatPanel({title:"All Chats",closable:!1,chatType:"allchats",barejid:"__allchats__@"+
Application.XMPPMUCHOST,id:"__allchats__"}))},addMUC:function(a,e,d){a=new Application.MUCChatPanel({title:Strophe.getNodeFromJid(a),barejid:a,handle:e,anonymous:d});return this.add(a)},getMUC:function(a){return this.find("barejid",a)[0]},removeMUC:function(a){this.remove(this.getMUC(a))},addChat:function(a){var e=Strophe.getNodeFromJid(a);Strophe.getDomainFromJid(a)==Application.XMPPMUCHOST&&(e=Strophe.getResourceFromJid(a));a=new Application.ChatPanel({title:e,handle:Application.USERNAME,barejid:a});
return this.add(a)},getChat:function(a){return this.find("barejid",a)[0]},removeChat:function(a){this.remove(this.getChat(a))}});Ext.reg("chattabpanel",Application.ChatTabPanel);Ext.ns("Application");function nwsbotFilter(a,e){return"nwsbot"==a.get("author")?!1:!0}
function grid2html(a){var e=a.getStore();a=a.ownerCt.title;t="<html><head></head><body>";t+="<table cellpadding='2' cellspacing='0' border='1'><tr><th>Roomname</th><th>Date</th><th>Author</th><th>Message</th></tr>";for(var d=0;d<e.getCount();d++)row=e.getAt(d),t+=String.format("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>\r\n",row.get("roomname")||a,row.get("ts").format("Y/m/d g:i A"),row.get("author"),row.get("message"));return t+="</table></body></html>"}
function htmlExport(a){Ext.isIE6||Ext.isIE7||Ext.isSafari||Ext.isSafari2||Ext.isSafari3?Ext.Msg.alert("Status","Sorry, this tool does not work with this browser."):(t=grid2html(a),document.location="data:plain/html;base64,"+encode64(t))}function showHtmlVersion(a){(new Ext.Window({title:"Text Version",closable:!0,width:600,height:350,plain:!0,autoScroll:!0,html:grid2html(a)})).show()}
var LinkInterceptor={render:function(a){a.body.on({mousedown:function(a,d){d.target="_blank";Application.TextWindow.hide()},click:function(a,d){"_blank"!=String(d.target).toLowerCase()&&(a.stopEvent(),window.open(d.href));Application.TextWindow.hide()},delegate:"a"})}};Ext.ns("Application");Application.saveViews=function(){for(var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}),e=1;6>e;e++)(bnds=Ext.getCmp("mfv"+e).bounds)&&a.c("view",{label:Ext.getCmp("mfv"+e).getValue(),bounds:bnds.left+","+bnds.bottom+","+bnds.right+","+bnds.top}).up();Application.XMPPConn.sendIQ(a.tree())};Ext.util.Format.comboRenderer=function(a){return function(e){return(e=a.findRecord(a.valueField,e))?e.get(a.displayField):a.valueNotFoundText}};
Application.SoundStore=new Ext.data.ArrayStore({fields:["id","label","src"],data:[["default","Default","sounds/message_new.mp3"],["bleep","Bleep","sounds/bleep.mp3"],["cow","Cow (Mooo!)","sounds/cow.mp3"],["doorbell","Door Bell","sounds/doorbell.mp3"],["eas","EAS Beep","sounds/eas.mp3"],["elevator","Elevator","sounds/elevator.mp3"]]});
var combo=new Ext.form.ComboBox({typeAhead:!1,triggerAction:"all",lazyRender:!0,mode:"local",store:Application.SoundStore,listeners:{change:function(a,e,d){Application.playSound(e)}},valueField:"id",displayField:"label"});
Application.soundPrefs=new Ext.Window({title:"Sound Preferences",width:500,height:300,closeAction:"hide",layout:"form",buttons:[{text:"Save Sound Settings",handler:function(){Ext.getCmp("soundpanel").getStore().each(function(a){eidx=a.get("id");Application.setPreference("sound::"+eidx+"::enabled",a.get("enabled")?"true":"false");Application.setPreference("sound::"+eidx+"::sound",a.get("sound"))});Application.soundPrefs.hide();Application.syncPreferences()}}],items:[{xtype:"slider",id:"volume",minValue:0,
maxValue:100,value:50,width:200,listeners:{changecomplete:function(a,e,d){Application.setPreference("volume",e);Application.MsgBus.fireEvent("soundevent","default")}},fieldLabel:"Volume"},new Ext.grid.EditorGridPanel({store:new Ext.data.ArrayStore({data:[["new_message","New Message (Non NWSBot)",!0,"default"],["new_conversation","New Conversation",!0,"doorbell"],["nwsbot","NWSBot Message",!0,"default"],["myhandle","Message with your name in it",!0,"bleep"],["tornado",'Message with "Tornado" within text',
!0,"eas"]],fields:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"enabled",type:"bool"},{name:"sound",type:"string"}],sortInfo:{field:"label",direction:"ASC"}}),cm:new Ext.grid.ColumnModel({columns:[{dataIndex:"enabled",id:"enabled",header:"Enable",xtype:"checkcolumn"},{dataIndex:"label",id:"label",sortable:!0,header:"Event Type"},{dataIndex:"sound",id:"sound",header:"Sound",renderer:Ext.util.Format.comboRenderer(combo),editor:combo}]}),id:"soundpanel",title:"Sound Events",frame:!0,
clicksToEdit:1,stripeRows:!0,autoExpandColumn:"label",height:200,autoScroll:!0})]});
Application.boundsFavorites=new Ext.Window({title:"Map View Favorites",width:500,height:300,closeAction:"hide",layout:"table",layoutConfig:{columns:4},autoScroll:!0,buttons:[{text:"Save Settings",handler:function(){for(var a=1;6>a;a++)nval=Ext.getCmp("mfv"+a).getValue(),""!=nval&&Ext.getCmp("fm"+a).setText(nval);Application.boundsFavorites.hide()}}],items:[{html:"This form allows you to modify the 5 allowed map extent favorites. The first favorite will be your default view when you log in and for the star icon above.",colspan:4},
{html:"#1"},{xtype:"textfield",id:"mfv1",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,e){Ext.getCmp("mfv1").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,e){(bnds=Ext.getCmp("mfv1").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#2"},{xtype:"textfield",id:"mfv2",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,e){Ext.getCmp("mfv2").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,e){(bnds=Ext.getCmp("mfv2").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#3"},{xtype:"textfield",id:"mfv3",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,e){Ext.getCmp("mfv3").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,e){(bnds=Ext.getCmp("mfv3").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,
!0)}},{html:"#4"},{xtype:"textfield",id:"mfv4",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,e){Ext.getCmp("mfv4").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,e){(bnds=Ext.getCmp("mfv4").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#5"},{xtype:"textfield",id:"mfv5",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,e){Ext.getCmp("mfv5").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,e){(bnds=Ext.getCmp("mfv5").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}}]});
mucform=new Ext.form.FormPanel({labelWidth:200,padding:5,items:[{xtype:"textfield",allowBlank:!1,name:"roomname",fieldLabel:"Room Name"},{xtype:"textfield",allowBlank:!1,name:"roomhandle",value:Application.USERNAME,fieldLabel:"Chat Handle"},{xtype:"checkbox",name:"bookmark",fieldLabel:"Save Bookmark for Chatroom?",handler:function(a,e){e?mucform.getForm().findField("roomalias").enable():mucform.getForm().findField("roomalias").disable()}},{xtype:"textfield",name:"roomalias",fieldLabel:"Bookmark Alias (optional)",
disabled:!0},{xtype:"checkbox",name:"anonymous",fieldLabel:"Anonymously Monitor (read-only)"},{xtype:"checkbox",name:"autojoin",fieldLabel:"Auto Join Room after Login"}],listeners:{render:function(){mucform.getForm().findField("roomhandle").getValue()||mucform.getForm().findField("roomhandle").setValue(Application.USERNAME)}}});var privform=new Ext.form.FormPanel({labelWidth:100,padding:5,items:[{xtype:"textfield",fieldLabel:"User Name",emptyText:"media-joe.blow",name:"username"}]});
Application.CreatePrivateChat=new Ext.Window({width:400,title:"Chat with User",items:[privform],buttons:[{xtype:"button",text:"Start Chat",scope:privform,handler:function(){var a=this.getForm().findField("username").getValue();-1==a.indexOf("@")&&(a=a+"@"+Application.XMPPHOST);Application.CreatePrivateChat.hide();(cp=Ext.getCmp("chatpanel").getChat(a))||(cp=Ext.getCmp("chatpanel").addChat(a));Ext.getCmp("chatpanel").setActiveTab(cp)}},{xtype:"button",text:"Cancel",handler:function(){Application.CreatePrivateChat.hide()}}]});
Application.JoinChatroomDialog=new Ext.Window({width:400,title:"Join a Group Chat",items:[mucform],buttons:[{xtype:"button",text:"Join Room",scope:mucform,handler:function(){roomname=this.getForm().findField("roomname").getValue();room=roomname+"@conference."+Application.XMPPHOST;handle=this.getForm().findField("roomhandle").getValue();ibook=this.getForm().findField("bookmark").getValue();anonymous=this.getForm().findField("anonymous").getValue();autojoin=this.getForm().findField("autojoin").getValue();
ibook&&(alias=this.getForm().findField("roomalias").getValue(),""==alias&&(alias=roomname),Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+roomname+")",jid:room,alias:alias,anonymous:anonymous,autojoin:autojoin,icon:"icons/chat.png",handle:handle,leaf:!0}));Application.MsgBus.fireEvent("joinchat",room,handle,anonymous);Application.JoinChatroomDialog.hide()}},{xtype:"button",text:"Cancel",handler:function(){Application.JoinChatroomDialog.hide()}}]});Application.msgtpl=new Ext.XTemplate('<p>{date:date("g:i:s A")} :: {msg}</p>');
Application.TextWindow=new Ext.Window({width:550,height:300,title:"Product Text",closeAction:"hide",constrain:!0,hidden:!0,autoScroll:!0,html:"Loading...."});Application.log=function(a){Ext.getCmp("debug").addMessage(a)};Ext.ns("Application");function saveBookmarks(){var a=Ext.getCmp("bookmarks").root,e=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"});a.eachChild(function(a){this.c("conference",{name:a.attributes.alias,anonymous:a.attributes.anonymous?"true":"false",autojoin:a.attributes.autojoin?"true":"false",jid:a.attributes.jid}).c("nick",a.attributes.handle).up().up()},e);Application.XMPPConn.sendIQ(e.tree())}
function onPresenceCheck(a,e){"available"==a.xmpp?Application.XMPPConn.send($pres()):Application.XMPPConn.send($pres().c("show","away").up().c("status",a.xmpp));Ext.getCmp("presenceUI").setText(a.text)}
Application.Control={region:"west",title:"NWSChat Live",collapsible:!0,width:200,split:!0,layout:"accordion",layoutConfig:{autoWidth:!1},autoScroll:!0,tbar:[{text:"Actions",menu:[{checked:!1,text:"Show Offline Buddies",checkHandler:function(a,e){Ext.getCmp("buddies").root.cascade(function(a){e?a.ui.show():"offline"==a.attributes.presence&&a.ui.hide()})}},{xtype:"menuitem",text:"Chat with User",handler:function(){Application.CreatePrivateChat.show()}},{xtype:"menuitem",text:"Add Buddy...",handler:function(){Application.buildAddBuddy(null,
null,null)}},{xtype:"menuitem",text:"Join Group Chat",handler:function(){Application.JoinChatroomDialog.show()}},{text:"Msg Text Color",menu:{items:[new Ext.ColorPalette({id:"fgcolor",value:"000000",listeners:{select:function(a,e){Application.setPreference("fgcolor",e)}}})]}},{text:"Msg Background Color",menu:{items:[new Ext.ColorPalette({id:"bgcolor",value:"FFFFFF",listeners:{select:function(a,e){Application.setPreference("bgcolor",e)}}})]}},{xtype:"menuitem",text:"Show Debug Window",handler:function(){Ext.getCmp("debug").show()}},
{xtype:"menuitem",text:"Log Out",handler:function(){Application.log("Manual logout requested.");Application.RECONNECT=!1;Application.XMPPConn.disconnect()}}]},{xtype:"tbseparator"},{text:"Available",id:"presenceUI",menu:{items:[{text:"Available",xmpp:"available",checked:!0,group:"presence",checkHandler:onPresenceCheck},{text:"Be Right Back",xmpp:"Be Right Back",checked:!1,group:"presence",checkHandler:onPresenceCheck},{text:"Away",xmpp:"away",checked:!1,group:"presence",checkHandler:onPresenceCheck}]}},
{xtype:"splitbutton",id:"sound",scale:"medium",soundOn:!0,handler:function(a){a.soundOn?(a.setIcon("icons/mute.png"),soundManager.muteAll(),a.soundOn=!1):(a.setIcon("icons/volume.png"),soundManager.unmuteAll(),a.soundOn=!0,Application.MsgBus.fireEvent("soundevent","default"))},arrowHandler:function(){Application.soundPrefs.show()},icon:"icons/volume.png"}],items:[{flex:1,xtype:"treepanel",id:"buddies",title:"Buddies",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,plugins:new Ext.ux.DataTip({tpl:new Ext.XTemplate('<tpl if="typeof(resources) !== &quot;undefined&quot;">',
"<div>",'<tpl for="resources.items">',"<p><b>Resource:</b> {resource} <b>Status:</b> {status}</p>","</tpl>","</div>","</tpl>")}),listeners:{click:function(a){(cp=Ext.getCmp("chatpanel").getChat(a.attributes.barejid))||(cp=Ext.getCmp("chatpanel").addChat(a.attributes.barejid));Ext.getCmp("chatpanel").setActiveTab(cp)}},root:new Ext.tree.TreeNode},{flex:1,xtype:"treepanel",id:"bookmarks",title:"Chatroom Bookmarks",collapsed:!1,rootVisible:!1,enableDD:!0,lines:!1,containerScroll:!0,autoScroll:!0,plugins:new Ext.ux.DataTip({tpl:"<div>Anonymous: {anonymous}<br />Autojoin: {autojoin}</div>"}),
contextMenu:new Ext.menu.Menu({items:[{id:"delete-node",icon:"icons/close.png",text:"Delete Bookmark"}],listeners:{itemclick:function(a){var e=a.parentMenu.contextNode;switch(a.id){case "delete-node":e.parentNode&&(e.remove(),saveBookmarks())}}}}),listeners:{contextmenu:function(a,e){a.select();var d=a.getOwnerTree().contextMenu;d.contextNode=a;d.showAt(e.getXY())},movenode:function(a,e,d,b,h){saveBookmarks()},click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();
form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(a.attributes.handle);form.findField("bookmark").enable();form.findField("anonymous").setValue(a.attributes.anonymous);form.findField("autojoin").setValue(a.attributes.autojoin);form.findField("roomalias").setValue(a.attributes.alias)})}},root:new Ext.tree.TreeNode({initialLoad:!1,listeners:{beforeappend:function(a,e,d,b){if(a=e.findChild("jid",d.attributes.jid))Application.log("Replacing MUC bookmark: "+
d.attributes.jid),e.removeChild(a,!0);return!0},append:function(a,e,d,b){e.initialLoad&&saveBookmarks()}}})},{flex:2,xtype:"treepanel",id:"chatrooms",title:"Chatrooms",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,listeners:{click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(Application.USERNAME);form.findField("bookmark").enable();
form.findField("anonymous").setValue(!1);form.findField("autojoin").setValue(!1);form.findField("roomalias").setValue(Strophe.getNodeFromJid(a.attributes.jid))})}},root:new Ext.tree.TreeNode}]};
Application.doLogin=function(){Application.RECONNECT=!0;Application.ATTEMPTS+=1;11<Application.ATTEMPTS?Application.log("Application Login Limit Reached!"):(username=Ext.getCmp("username").getValue(),0<username.indexOf("@")&&(username=Strophe.getNodeFromJid(username)),username=username.toLowerCase(),username=username.replace(/^\s+|\s+$/g,""),password=Ext.getCmp("password").getValue(),""==username?Application.log("Invalid Username"):""==password?Application.log("Invalid Password"):Application.login(username,
password))};Ext.ns("Application");Application.ServiceGuard={skipFirst:!0,run:function(){this.skipFirst?this.skipFirst=!1:Application.XMPPConn&&Application.XMPPConn.authenticated&&0!=Application.XMPPConn.errors&&Application.log("Strophe error counter is non-zero: "+Application.XMPPConn.errors)},interval:12E4};function UTCStringToDate(a,e){var d=Date.parseDate(a,e);return void 0==d?"":d.fromUTC()}
function buildXMPP(){Application.log("Initializing XMPPConn Obj");Application.XMPPConn=new Strophe.Connection(Application.BOSH);Application.XMPPConn.disco.addFeature("http://jabber.org/protocol/chatstates");Application.DEBUGMODE&&(Application.XMPPConn.rawInput=rawInput,Application.XMPPConn.rawOutput=rawOutput)}
Application.login=function(a,e){jid=a+"@"+Application.XMPPHOST+"/"+Application.XMPPRESOURCE;"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(jid,e,onConnect,60,1,Application.ROUTE)};Application.doAnonymousLogin=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(Application.XMPPHOST,null,onConnect)};
Application.register=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.register.connect(Application.XMPPHOST,function(a){a===Strophe.Status.REGISTER?(Application.log("Strophe.Status.REGISTER"),Application.XMPPConn.register.fields.username=Ext.get("reguser").getValue(),Application.XMPPConn.register.fields.password=Ext.get("regpass").getValue(),Application.XMPPConn.register.fields.email=Ext.get("regemail").getValue(),Application.XMPPConn.register.submit()):a===Strophe.Status.REGISTERED?
(Ext.getCmp("loginpanel").addMessage("Username "+Application.XMPPConn.register.fields.username+" registered with server ..."),Ext.getCmp("loginwindow").items.items[0].activate(0),Ext.getCmp("username").setValue(Application.XMPPConn.register.fields.username),Ext.getCmp("password").setValue(Application.XMPPConn.register.fields.password),Application.XMPPConn.disconnect(),Application.doLogin()):a===Strophe.Status.CONFLICT?Application.log("Contact already existed!"):a===Strophe.Status.NOTACCEPTABLE?Application.log("Registration form not properly filled out."):
a===Strophe.Status.REGIFAIL?Application.log("The Server does not support In-Band Registration"):a===Strophe.Status.CONNECTED?(Application.log("connected?"),Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid)):Application.log(a)})};
function onConnect(a){if(a==Strophe.Status.CONNECTING)Application.log("Strophe.Status.CONNECTING...");else if(a==Strophe.Status.ERROR)Application.log("Strophe.Status.ERROR...");else if(a==Strophe.Status.AUTHFAIL)Application.log("Strophe.Status.AUTHFAIL..."),Application.RECONNECT=!1,Ext.getCmp("loginpanel").addMessage("Authentication failed, please check username and password..."),Application.XMPPConn.disconnect();else if(a==Strophe.Status.CONNFAIL)Application.log("Strophe.Status.CONNFAIL...");else if(a==
Strophe.Status.DISCONNECTED)Application.log("Strophe.Status.DISCONNECTED..."),Application.MsgBus.fireEvent("loggingout"),Application.RECONNECT?(Application.log("Relogging in after 3 seconds delay"),Application.doLogin.defer(3E3,this)):Application.MsgBus.fireEvent("loggedout");else if(a==Strophe.Status.AUTHENTICATING)Application.log("Strophe.Status.AUTHENTICATING...");else if(a==Strophe.Status.DISCONNECTING)Application.log("Strophe.Status.DISCONNECTING..."),Application.XMPPConn.flush();else if(a==
Strophe.Status.ATTACHED)Application.log("Strophe.Status.ATTACHED...");else if(a==Strophe.Status.CONNECTED){Application.log("Strophe.Status.CONNECTED...");Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid);Application.RECONNECT=!0;Application.XMPPConn.addHandler(onMessage,null,"message",null,null,null);Application.XMPPConn.addHandler(onPresence,null,"presence",null,null,null);Application.XMPPConn.addHandler(onRoster,Strophe.NS.ROSTER,"iq",null,null,null);Application.XMPPConn.addHandler(onIQ,
null,"iq",null,null,null);Application.XMPPConn.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.ROSTER}).tree());var e=0;Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==a.chatType){Application.log("Attempting to rejoin MUC: "+a.barejid);var b=$pres({to:a.barejid+"/"+a.handle});a.anonymous&&b.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");(function(){Application.XMPPConn.send(this.p)}).defer(5E3*e,{p:b});e+=1}});a=$iq({type:"get",id:"_get3"}).c("query",
{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"}).tree();Application.XMPPConn.sendIQ(a,parsePrefs);a=$iq({type:"get",id:"_get2"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}).tree();Application.XMPPConn.sendIQ(a,parseViews);Application.MsgBus.fireEvent("loggedin")}}
function updateMap(){var a=Application.getPreference("layers");if(null!=a)for(var a=a.split("||"),e=0;e<a.length;e++)""!=a[e]&&(idx=Application.layerstore.find("title",a[e]),-1!=idx&&(Application.log("Setting Layer "+a[e]+" visable"),layer=Application.layerstore.getAt(idx).getLayer(),layer.setVisibility(!0)))}
function setSounds(){Application.prefStore.each(function(a){key=a.get("key");"volume"==key?Ext.getCmp("volume").setValue(a.get("value")):0==key.indexOf("sound::")&&(tokens=key.split("::"),3==tokens.length&&(sidx=tokens[1],opt=tokens[2],store=Ext.getCmp("soundpanel").getStore(),idx=store.find("id",sidx),-1<idx&&(lrecord=store.getAt(idx),val=a.get("value"),"true"==val&&(val=!0),"false"==val&&(val=!1),lrecord.set(opt,val))))})}
function parsePrefs(a){Application.prefStore.removeAll();a=$(a).find("pref");for(var e=0;e<a.length;e++)key=a[e].getAttribute("key"),value=a[e].getAttribute("value"),Application.setPreference(key,value);Application.prefStore.locked=!0;setSounds();try{var d=parseInt(Application.getPreference("font-size",14))+2;cssfmt=String.format("normal {0}px arial",d);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt);updateMap();Application.updateColors()}catch(b){}Application.prefStore.locked=
!1}function parseViews(a){if(Ext.getCmp("map"))for(elem=$(a).find("view"),a=0;a<elem.length;a++)label=elem[a].getAttribute("label"),bounds=elem[a].getAttribute("bounds"),""!=label&&(Ext.getCmp("mfv"+(a+1)).setValue(label),Ext.getCmp("fm"+(a+1)).setText(label)),Ext.getCmp("mfv"+(a+1)).bounds=OpenLayers.Bounds.fromArray(bounds.split(",")),0==a&&Ext.getCmp("map").map.zoomToExtent(OpenLayers.Bounds.fromArray(bounds.split(",")),!0)}
function parseBookmarks(a){elem=$(a).find("conference");for(var e=a=0;e<elem.length;e++){alias=elem[e].getAttribute("name");jid=elem[e].getAttribute("jid");nick=$(elem[e]).find("nick").text();if(null==nick||""==nick)nick=Application.USERNAME;anonymous="true"==elem[e].getAttribute("anonymous");autojoin="true"==elem[e].getAttribute("autojoin");Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+Strophe.getNodeFromJid(jid)+")",jid:jid,alias:alias,autojoin:autojoin,iconCls:"chatroom-icon",handle:nick,
anonymous:anonymous,leaf:!0});autojoin&&null==Ext.getCmp("chatpanel").getMUC(jid)&&(Application.log("Autojoining MUC: "+jid),function(){Application.MsgBus.fireEvent("joinchat",this.jid,this.nick,this.anonymous)}.defer(5E3*a,{jid:jid,nick:nick,anonymous:anonymous}),a+=1)}Ext.getCmp("bookmarks").root.initialLoad=!0}
function onIQ(a){try{iqParser(a)}catch(d){a="IQ Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var e in d)a+="property: "+e+" value: ["+d[e]+"]\n";a+="toString():  value: ["+d.toString()+"]";Application.log(a)}return!0}
function iqParser(a){if("fetchrooms"==a.getAttribute("id")){items=a.firstChild.getElementsByTagName("item");for(a=0;a<items.length;a++)Ext.getCmp("chatrooms").root.appendChild({text:items[a].getAttribute("name")+" ("+Strophe.getNodeFromJid(items[a].getAttribute("jid"))+")",jid:items[a].getAttribute("jid"),iconCls:"chatroom-icon",leaf:!0});myTreeSorter=new Ext.tree.TreeSorter(Ext.getCmp("chatrooms"),{folderSort:!0,dir:"asc"});myTreeSorter.doSort(Ext.getCmp("chatrooms").getRootNode())}}
function onRoster(a){try{rosterParser(a)}catch(d){a="Roster Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var e in d)a+="property: "+e+" value: ["+d[e]+"]\n";a+="toString():  value: ["+d.toString()+"]";Application.log(a)}return!0}
function rosterParser(a){var e=Ext.getCmp("buddies").root;a=$(a).find("item");for(var d=0;d<a.length;d++)for(var b=$(a[d]).find("group"),h=0;h<b.length;h++){var g=$(b[h]);child=e.findChild("group",g.text())||e.appendChild({leaf:!1,group:g.text(),text:g.text(),expanded:!0,loaded:!0});child.appendChild({text:a[d].getAttribute("name"),barejid:a[d].getAttribute("jid"),resources:new Ext.util.MixedCollection,iconCls:"buddy-offline",presence:"offline",hidden:!0,leaf:!0})}Application.XMPPConn.send($pres().tree());
var k=$iq({type:"get",id:"_get1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"}).tree();(function(){Application.XMPPConn.sendIQ(k,parseBookmarks)}).defer(3E3,this);return!0}function onPresence(a){try{presenceParser(a)}catch(d){a="Presence Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var e in d)a+="property: "+e+" value: ["+d[e]+"]\n";a+="toString():  value: ["+d.toString()+"]";Application.log(a)}return!0}
function getMUCIcon(a,e){return"owner"==a?"icons/owner.png":"admin"==a?"icons/admin.png":"icons/participant.png"}
function presenceParser(a){var e=a.getAttribute("from");if(Strophe.getDomainFromJid(e)=="conference."+Application.XMPPHOST)if(room=Strophe.getBareJidFromJid(e),mcp=Ext.getCmp("chatpanel").getMUC(room),null==mcp)Application.log("ERROR: got presence from non-existant room: "+room);else{if(0<$(a).find("status").length&&(error=$(a).find("status"),"201"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, chatroom ["+room+"] does not exist.");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<
$(a).find("error").length&&(error=$(a).find("error"),"407"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your account is not authorized to access chatroom ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("error").length&&(error=$(a).find("error"),"409"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your requested chatroom handle is already in use by room ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("status").length&&
(error=$(a).find("status"),"307"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Your account signed into this chatroom ["+room+"] with the same handle from another location. Please use unique handles.");mcp.joinedChat=!1;Ext.getCmp("chatpanel").removeMUC(room);return}child=mcp.roomusers.root.findChild("text",Strophe.getResourceFromJid(e));var d=$(a).find("item"),b=e,h,g;if(0<d.length&&(b=d[0].getAttribute("jid")||b,g=d[0].getAttribute("role"),h=d[0].getAttribute("affiliation"),d=$(d[0]).find("role"),
0<d.length))try{g=d.text()}catch(l){var d="roletest bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n"),k;for(k in l)d+="property: "+k+" value: ["+l[k]+"]\n";d+="toString():  value: ["+l.toString()+"]";Application.log(d)}null!=a.getAttribute("type")||child||"visitor"==g||(mcp.joinedChat=!0,mcp.roomusers.root.appendChild({affiliation:h,role:g,icon:getMUCIcon(h,g),text:Strophe.getResourceFromJid(e),jid:b,leaf:!0}));"unavailable"==a.getAttribute("type")&&child&&mcp.roomusers.root.removeChild(child)}else onBuddyPresence(a)}
function onMessage(a){try{messageParser(a)}catch(d){a="Message Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var e in d)a+="property: "+e+" value: ["+d[e]+"]\n";a+="toString():  value: ["+d.toString()+"]";Application.log(a)}return!0}Application.replaceURLWithHTMLLinks=function(a){return null==a?null:a.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,"<a href='$1'>$1</a>")};
function messageParser(a){var e=a.getAttribute("from"),d=a.getAttribute("type"),b=a.getElementsByTagName("body"),h=$(a).find("x[xmlns='jabber:x:delay']"),g=$(a).find("html"),k=b[0],l="",b=!1;0<g.length?(l=$(a).find("html").find("body"),l=navigator.userAgent.match(/msie/i)?l[0].xml:$(l[0]).html(),l=l.replace(/\<p/g,"<span").replace(/\<\/p\>/g,"</span>"),""==l&&(Application.log("Message Failure:"+a),l=Application.replaceURLWithHTMLLinks(Strophe.getText(k)))):l=Application.replaceURLWithHTMLLinks(Strophe.getText(k));
0<h.length?(g=h[0].getAttribute("stamp"),b=!0):g=(new Date).toUTC().format("Ymd\\TH:i:s");if("groupchat"==d){product_id=null;h=$(a).find("x");for(d=0;d<h.length;d++)h[d].getAttribute("product_id")&&(product_id=h[d].getAttribute("product_id"));try{geomParser(a,b)}catch(f){}sender=Strophe.getResourceFromJid(e);room=Strophe.getBareJidFromJid(e);(mpc=Ext.getCmp("chatpanel").getMUC(room))&&sender&&(mpc.gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:sender,message:l,
room:null,jid:mpc.getJidByHandle(sender),xdelay:b,product_id:product_id})),mpc.gp.getStore().isFiltered()&&mpc.gp.getStore().filterBy(nwsbotFilter),b||(Ext.getCmp("__allchats__").gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:sender,room:Strophe.getNodeFromJid(e),message:l,jid:mpc.getJidByHandle(sender),xdelay:b,product_id:product_id})),Ext.getCmp("__allchats__").gp.getStore().isFiltered()&&Ext.getCmp("__allchats__").gp.getStore().filterBy(nwsbotFilter)))}else"chat"!=
d||l||null==e?"chat"==d&&l&&null!=e?(jid=Strophe.getBareJidFromJid(e),username=Strophe.getNodeFromJid(e),Strophe.getDomainFromJid(e)!=Application.XMPPHOST&&(jid=e,username=Strophe.getResourceFromJid(e)),cp=Ext.getCmp("chatpanel").getChat(jid),cp||(cp=Ext.getCmp("chatpanel").addChat(jid),Application.MsgBus.fireEvent("soundevent","new_conversation")),cp.gp.store.addSorted(new Ext.data.Record({ts:UTCStringToDate(g,"Ymd\\Th:i:s"),author:username,room:null,xdelay:!1,message:l}))):e==Application.XMPPHOST&&
(new Ext.Window({width:500,maxWidth:500,height:350,constrain:!0,autoScroll:!0,bodyStyle:{padding:"10",background:"#fff"},title:$(a).find("subject").text()||"System Message",html:"<p><b>System Message</b><p>"+$(a).find("body").text()+"</p>"})).show():(jid=Strophe.getBareJidFromJid(e),cp=Ext.getCmp("chatpanel").getChat(jid),0<$(a).find("composing").length&&cp&&cp.setIconCls("typing-tab"),0<$(a).find("paused").length&&cp&&cp.setIconCls("paused-tab"))}
function geomParser(a,e){if(Ext.getCmp("map")){var d=a.getElementsByTagName("body")[0],b=null;0<a.getElementsByTagName("html").length?(b=$(a).find("html").find("body"),b=navigator.userAgent.match(/msie/i)?b[0].xml:$(b[0]).html()):b=Strophe.getText(d);d=$(a).find("x");if(0!=d.length)for(var h=0;h<d.length;h++)if(null!=d[h].getAttribute("geometry")){var g=d[h].getAttribute("geometry");wkt=new OpenLayers.Format.WKT;if(collection=wkt.read(g)){collection.constructor!=Array&&(collection=[collection]);var k=
collection[0],g=36E5;if(!d[h].getAttribute("skip")){if(d[h].getAttribute("expire")){var l=UTCStringToDate(d[h].getAttribute("expire"),"Ymd\\Th:i:s");k.attributes.expire=l.toUTC();diff=l-new Date;if(0>=diff)continue;0<diff&&(g=diff)}d[h].getAttribute("valid")&&(l=UTCStringToDate(d[h].getAttribute("valid"),"Ymd\\Th:i:s"),k.attributes.valid=l.toUTC());k.attributes.ptype=d[h].getAttribute("ptype");k.attributes.message=b;k.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
"LSR"!=d[h].getAttribute("category")&&"PIREP"!=d[h].getAttribute("category")||!k.attributes.valid||e&&!(e&&72E5>new Date-k.attributes.valid)||(lsrs.addFeatures([k]),(new Ext.util.DelayedTask(function(){lsrs.removeFeatures([k])})).delay(g),sstate=Application.lsrStore.getSortState(),Application.lsrStore.sort(sstate.field,sstate.direction));"SBW"==d[h].getAttribute("category")&&(k.attributes.vtec=d[h].getAttribute("vtec"),l=Application.sbwStore.find("vtec",k.attributes.vtec),"CAN"==d[h].getAttribute("status")?
-1<l&&(Application.log("Removing SBW vtec ["+k.attributes.vtec+"]"),Application.sbwStore.removeAt(l)):(-1<l&&(Application.log("Old SBW vtec ["+k.attributes.vtec+"]"),Application.sbwStore.removeAt(l)),Application.log("Adding SBW vtec ["+k.attributes.vtec+"] delay ["+g+"]"),sbws.addFeatures([k]),(new Ext.util.DelayedTask(function(){sbws.removeFeatures([k])})).delay(g),sstate=Application.sbwStore.getSortState(),Application.sbwStore.sort(sstate.field,sstate.direction)))}}}}}
function rawInput(a){Application.log("RECV: "+Strophe.xmlescape(a))}function rawOutput(a){Application.log("SENT: "+Strophe.xmlescape(a))};Ext.ns("Application");Application.updateColors=function(){var a=Application.getPreference("bgcolor","FFFFFF"),e=Application.getPreference("fgcolor","000000");Application.log("Attempting style adjustment bgcolor:"+a+", fgcolor:"+e);Ext.getCmp("chatpanel").items.each(function(d){d.te&&d.te.items.get(0).getEl().applyStyles({background:"#"+a,color:"#"+e})})};
Application.syncPreferences=function(){Application.log("Saving preferences to server...");var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"});Application.prefStore.each(function(a){this.c("pref",{key:a.get("key"),value:a.get("value")}).up()},a);void 0!==Application.XMPPConn&&Application.XMPPConn.sendIQ(a.tree())};Application.removePreference=function(a){idx=Application.prefStore.find("key",a);-1<idx&&Application.prefStore.removeAt(idx)};
Application.getPreference=function(a,e){idx=Application.prefStore.find("key",a);return-1<idx?(record=Application.prefStore.getAt(idx),record.get("value")):e};Application.setPreference=function(a,e){idx=Application.prefStore.find("key",a);-1<idx?(Application.log("Setting Preference: "+a+" Value: "+e),record=Application.prefStore.getAt(idx),record.set("value",e)):(Application.log("Adding Preference: "+a+" Value: "+e),Application.prefStore.add(new Ext.data.Record({key:a,value:e})))};
Application.prefStore=new Ext.data.Store({fields:[{id:"key"},{id:"value"}],locked:!1,listeners:{remove:function(a,e,d){Application.log("prefStore remove event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences()},update:function(a,e,d){Application.log("prefStore update event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences();"fgcolor"!=e.get("key")&&"bgcolor"!=
e.get("key")||Application.updateColors()}}});Application.MsgBus=new Ext.util.Observable;Application.MsgBus.addEvents("message");Application.MsgBus.addEvents("loggedin");Application.MsgBus.addEvents("loggedout");
Application.playSound=function(a){if(soundManager&&soundManager.ok()&&1!=soundManager.playState){var e=soundManager.getSoundById(a);if(!e){idx=Application.SoundStore.find("id",a);if(-1==idx){Application.log("Could not find sound: "+a);return}record=Application.SoundStore.getAt(idx);e=soundManager.createSound({id:record.get("id"),url:record.get("src"),onplay:function(){},onfinish:function(){}})}e&&e.play({volume:Application.getPreference("volume",100)})}};
Application.MsgBus.on("soundevent",function(a){enable=Application.getPreference("sound::"+a+"::enabled","true");"false"!=enable&&(sidx=Application.getPreference("sound::"+a+"::sound","default"),Application.playSound(sidx))});
Application.MsgBus.on("loggingout",function(){Ext.getCmp("chatpanel").items.each(function(a){"groupchat"==a.chatType&&a.clearRoom()});Ext.getCmp("buddies").root.removeAll();Ext.getCmp("bookmarks").root.suspendEvents(!1);Ext.getCmp("bookmarks").root.removeAll();Ext.getCmp("bookmarks").root.resumeEvents();Ext.getCmp("bookmarks").root.initalLoad=!1;Ext.getCmp("chatrooms").root.removeAll()});Application.MsgBus.on("loggedout",function(){Ext.getCmp("loginwindow").show()});
Application.MsgBus.on("loggedin",function(){Ext.getCmp("loginwindow").hide();Application.XMPPConn.send($iq({type:"get",id:"fetchrooms",to:"conference."+Application.XMPPHOST}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}))});
Application.MsgBus.on("joinchat",function(a,e,d){if(null==e||""==e)e=Application.USERNAME;mcp=Ext.getCmp("chatpanel").getMUC(a);if(null==mcp){Application.log("Creating chatroom:"+a);mcp=Ext.getCmp("chatpanel").addMUC(a,e,d);var b=$pres({to:a+"/"+e});d&&b.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");Application.XMPPConn.send(b);mcp.on("destroy",function(){Application.XMPPConn.authenticated&&this.joinedChat&&Application.XMPPConn.send($pres({type:"unavailable",to:a+
"/"+e}))})}Ext.getCmp("chatpanel").setActiveTab(mcp)});Ext.ns("Application");
Application.buildAddBuddy=function(a,e,d){Ext.getCmp("addbuddy")||(new Ext.Window({title:"Add Buddy",layout:"form",width:300,height:150,id:"addbuddy",items:[{xtype:"textfield",fieldLabel:"NWSChat ID",value:a},{xtype:"textfield",fieldLabel:"Alias",value:e},{xtype:"textfield",fieldLabel:"Buddy Group",value:d}],buttons:[{text:"Add Buddy",handler:function(a){var d=a.ownerCt.ownerCt.items.items[0].getValue(),e=a.ownerCt.ownerCt.items.items[1].getValue();a=a.ownerCt.ownerCt.items.items[2].getValue();var k=
$pres({to:d+"@"+Application.XMPPHOST,type:"subscribe"});Application.XMPPConn.send(k.tree());k=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:d+"@"+Application.XMPPHOST,name:e}).c("group",a);Application.XMPPConn.send(k.tree());Ext.getCmp("addbuddy").close()}}]})).show()};
