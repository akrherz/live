Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),d="toString toLocaleString valueOf hasOwnProperty isPrototypeOf propertyIsEnumerable constructor".split(" "),e=d.length;return function(g){if("object"!==typeof g&&("function"!==typeof g||null===g))throw new TypeError("Object.keys called on non-object");var f=[],h;for(h in g)a.call(g,h)&&f.push(h);if(b)for(h=0;h<e;h++)a.call(g,d[h])&&f.push(d[h]);return f}}());
Array.prototype.forEach||(Array.prototype.forEach=function(a){if(void 0===this||null===this)throw new TypeError;var b=Object(this),d=b.length>>>0;if("function"!==typeof a)throw new TypeError;for(var e=2<=arguments.length?arguments[1]:void 0,g=0;g<d;g++)g in b&&a.call(e,b[g],g,b)});Ext.override(Date,{toUTC:function(){return this.add(Date.MINUTE,this.getTimezoneOffset())},fromUTC:function(){return this.add(Date.MINUTE,-this.getTimezoneOffset())}});
Ext.override(Ext.Panel,{setIconCls:function(a){Ext.fly(this.ownerCt.getTabEl(this)).child(".x-tab-strip-text").replaceClass(this.iconCls,a);this.setIconClass(a)}});
Ext.override(Ext.Element,{printCSS:null,printStyle:!1,printTitle:document.title,print:function(a){Ext.apply(this,a);a=Ext.get(this.id).dom;this.isGrid&&(a=a.parentNode);var b=document.getElementById("printcontainer"),d=document.getElementById("printframe"),e="";b&&(d&&b.removeChild(d),a.removeChild(b));for(d=0;d<a.attributes.length;d++)if(Ext.isEmpty(a.attributes[d].value)||"null"!=a.attributes[d].value.toLowerCase())if(b=Ext.isEmpty(a.attributes[d].value)?'{0}="true" ':'{0}="{1}" ',this.printStyle?
this.printStyle:"style"!=a.attributes[d].name.toLowerCase())e+=String.format(b,a.attributes[d].name,a.attributes[d].value);b="";if(this.printCSS)for(Ext.isArray(this.printCSS)||(this.printCSS=[this.printCSS]),d=0;d<this.printCSS.length;d++)b+=String.format('<link rel="stylesheet" type="text/css" href="{0}"/>',this.printCSS[d]);e=String.format('<HTML><HEAD>{0}<TITLE>{1}</TITLE></HEAD><BODY onload="{2}"><DIV {3}>{4}</DIV></BODY></HTML>',b,this.printTitle,"",e,a.innerHTML);b=document.createElement("div");
b.setAttribute("style","width:0px;height:0px;"+(Ext.isSafari?"display:none;":"visibility:hidden;"));b.setAttribute("id","printcontainer");a.appendChild(b);Ext.isIE&&(b.style.display="none");d=document.createElement("iframe");d.setAttribute("id","printframe");d.setAttribute("name","printframe");b.appendChild(d);d.contentWindow.document.open();d.contentWindow.document.write(e);d.contentWindow.document.close();this.isGrid&&(a=Ext.get(d.contentWindow.document.body),a=Ext.get(a.first().dom.parentNode),
a.child("div.x-panel-body").setStyle("height",""),a.child("div.x-grid3").setStyle("height",""),a.child("div.x-grid3-scroller").setStyle("height",""));Ext.isIE?d.contentWindow.document.execCommand("print"):d.contentWindow.print()}});var Base64=function(){return{encode:function(a){var b="",d,e,g,f,h,q,s=0;do d=a.charCodeAt(s++),e=a.charCodeAt(s++),g=a.charCodeAt(s++),f=d>>2,d=(d&3)<<4|e>>4,h=(e&15)<<2|g>>6,q=g&63,isNaN(e)?h=q=64:isNaN(g)&&(q=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(q);
while(s<a.length);return b},decode:function(a){var b="",d,e,g,f,h,q=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(q++)),e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(q++)),f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(q++)),h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(q++)),d=d<<2|e>>4,e=(e&15)<<
4|f>>2,g=(f&3)<<6|h,b+=String.fromCharCode(d),64!=f&&(b+=String.fromCharCode(e)),64!=h&&(b+=String.fromCharCode(g));while(q<a.length);return b}}}();function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),8*a.length))}function str_sha1(a){return binb2str(core_sha1(str2binb(a),8*a.length))}function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b))}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b))}
function core_sha1(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;var d=Array(80),e=1732584193,g=-271733879,f=-1732584194,h=271733878,q=-1009589776,s,m,n,l,k,r,u,v;for(s=0;s<a.length;s+=16){l=e;k=g;r=f;u=h;v=q;for(m=0;80>m;m++)d[m]=16>m?a[s+m]:rol(d[m-3]^d[m-8]^d[m-14]^d[m-16],1),n=safe_add(safe_add(rol(e,5),sha1_ft(m,g,f,h)),safe_add(safe_add(q,d[m]),sha1_kt(m))),q=h,h=f,f=rol(g,30),g=e,e=n;e=safe_add(e,l);g=safe_add(g,k);f=safe_add(f,r);h=safe_add(h,u);q=safe_add(q,v)}return[e,g,f,h,q]}
function sha1_ft(a,b,d,e){return 20>a?b&d|~b&e:40>a?b^d^e:60>a?b&d|b&e|d&e:b^d^e}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function core_hmac_sha1(a,b){var d=str2binb(a);16<d.length&&(d=core_sha1(d,8*a.length));for(var e=Array(16),g=Array(16),f=0;16>f;f++)e[f]=d[f]^909522486,g[f]=d[f]^1549556828;d=core_sha1(e.concat(str2binb(b)),512+8*b.length);return core_sha1(g.concat(d),672)}
function safe_add(a,b){var d=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(d>>16)<<16|d&65535}function rol(a,b){return a<<b|a>>>32-b}function str2binb(a){for(var b=[],d=0;d<8*a.length;d+=8)b[d>>5]|=(a.charCodeAt(d/8)&255)<<24-d%32;return b}function binb2str(a){for(var b="",d=0;d<32*a.length;d+=8)b+=String.fromCharCode(a[d>>5]>>>24-d%32&255);return b}
function binb2b64(a){for(var b="",d,e,g=0;g<4*a.length;g+=3)for(d=(a[g>>2]>>8*(3-g%4)&255)<<16|(a[g+1>>2]>>8*(3-(g+1)%4)&255)<<8|a[g+2>>2]>>8*(3-(g+2)%4)&255,e=0;4>e;e++)b=8*g+6*e>32*a.length?b+"=":b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>6*(3-e)&63);return b}
var MD5=function(){var a=function(a,b){var h=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(h>>16)<<16|h&65535},b=function(a){for(var b=[],h=0;h<8*a.length;h+=8)b[h>>5]|=(a.charCodeAt(h/8)&255)<<h%32;return b},d=function(b,h,d,f,e,g){b=a(a(h,b),a(f,g));return a(b<<e|b>>>32-e,d)},e=function(a,b,h,f,e,g,r){return d(b&h|~b&f,a,b,e,g,r)},g=function(a,b,h,f,e,g,r){return d(b&f|h&~f,a,b,e,g,r)},f=function(a,b,h,f,e,g,r){return d(h^(b|~f),a,b,e,g,r)},h=function(b,h){b[h>>5]|=128<<h%32;b[(h+64>>>9<<4)+14]=h;
for(var m=1732584193,n=-271733879,l=-1732584194,k=271733878,r,u,v,w,p=0;p<b.length;p+=16)r=m,u=n,v=l,w=k,m=e(m,n,l,k,b[p+0],7,-680876936),k=e(k,m,n,l,b[p+1],12,-389564586),l=e(l,k,m,n,b[p+2],17,606105819),n=e(n,l,k,m,b[p+3],22,-1044525330),m=e(m,n,l,k,b[p+4],7,-176418897),k=e(k,m,n,l,b[p+5],12,1200080426),l=e(l,k,m,n,b[p+6],17,-1473231341),n=e(n,l,k,m,b[p+7],22,-45705983),m=e(m,n,l,k,b[p+8],7,1770035416),k=e(k,m,n,l,b[p+9],12,-1958414417),l=e(l,k,m,n,b[p+10],17,-42063),n=e(n,l,k,m,b[p+11],22,-1990404162),
m=e(m,n,l,k,b[p+12],7,1804603682),k=e(k,m,n,l,b[p+13],12,-40341101),l=e(l,k,m,n,b[p+14],17,-1502002290),n=e(n,l,k,m,b[p+15],22,1236535329),m=g(m,n,l,k,b[p+1],5,-165796510),k=g(k,m,n,l,b[p+6],9,-1069501632),l=g(l,k,m,n,b[p+11],14,643717713),n=g(n,l,k,m,b[p+0],20,-373897302),m=g(m,n,l,k,b[p+5],5,-701558691),k=g(k,m,n,l,b[p+10],9,38016083),l=g(l,k,m,n,b[p+15],14,-660478335),n=g(n,l,k,m,b[p+4],20,-405537848),m=g(m,n,l,k,b[p+9],5,568446438),k=g(k,m,n,l,b[p+14],9,-1019803690),l=g(l,k,m,n,b[p+3],14,-187363961),
n=g(n,l,k,m,b[p+8],20,1163531501),m=g(m,n,l,k,b[p+13],5,-1444681467),k=g(k,m,n,l,b[p+2],9,-51403784),l=g(l,k,m,n,b[p+7],14,1735328473),n=g(n,l,k,m,b[p+12],20,-1926607734),m=d(n^l^k,m,n,b[p+5],4,-378558),k=d(m^n^l,k,m,b[p+8],11,-2022574463),l=d(k^m^n,l,k,b[p+11],16,1839030562),n=d(l^k^m,n,l,b[p+14],23,-35309556),m=d(n^l^k,m,n,b[p+1],4,-1530992060),k=d(m^n^l,k,m,b[p+4],11,1272893353),l=d(k^m^n,l,k,b[p+7],16,-155497632),n=d(l^k^m,n,l,b[p+10],23,-1094730640),m=d(n^l^k,m,n,b[p+13],4,681279174),k=d(m^n^
l,k,m,b[p+0],11,-358537222),l=d(k^m^n,l,k,b[p+3],16,-722521979),n=d(l^k^m,n,l,b[p+6],23,76029189),m=d(n^l^k,m,n,b[p+9],4,-640364487),k=d(m^n^l,k,m,b[p+12],11,-421815835),l=d(k^m^n,l,k,b[p+15],16,530742520),n=d(l^k^m,n,l,b[p+2],23,-995338651),m=f(m,n,l,k,b[p+0],6,-198630844),k=f(k,m,n,l,b[p+7],10,1126891415),l=f(l,k,m,n,b[p+14],15,-1416354905),n=f(n,l,k,m,b[p+5],21,-57434055),m=f(m,n,l,k,b[p+12],6,1700485571),k=f(k,m,n,l,b[p+3],10,-1894986606),l=f(l,k,m,n,b[p+10],15,-1051523),n=f(n,l,k,m,b[p+1],21,
-2054922799),m=f(m,n,l,k,b[p+8],6,1873313359),k=f(k,m,n,l,b[p+15],10,-30611744),l=f(l,k,m,n,b[p+6],15,-1560198380),n=f(n,l,k,m,b[p+13],21,1309151649),m=f(m,n,l,k,b[p+4],6,-145523070),k=f(k,m,n,l,b[p+11],10,-1120210379),l=f(l,k,m,n,b[p+2],15,718787259),n=f(n,l,k,m,b[p+9],21,-343485551),m=a(m,r),n=a(n,u),l=a(l,v),k=a(k,w);return[m,n,l,k]};return{hexdigest:function(a){a=h(b(a),8*a.length);for(var d="",f=0;f<4*a.length;f++)d+="0123456789abcdef".charAt(a[f>>2]>>f%4*8+4&15)+"0123456789abcdef".charAt(a[f>>
2]>>f%4*8&15);return d},hash:function(a){a=h(b(a),8*a.length);for(var d="",f=0;f<32*a.length;f+=8)d+=String.fromCharCode(a[f>>5]>>>f%32&255);return d}}}();Function.prototype.bind||(Function.prototype.bind=function(a){var b=this,d=Array.prototype.slice,e=Array.prototype.concat,g=d.call(arguments,1);return function(){return b.apply(a?a:this,e.call(g,d.call(arguments,0)))}});
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var d=this.length,e=Number(b)||0,e=0>e?Math.ceil(e):Math.floor(e);for(0>e&&(e+=d);e<d;e++)if(e in this&&this[e]===a)return e;return-1});
(function(a){function b(a,b){return new f.Builder(a,b)}function d(a){return new f.Builder("message",a)}function e(a){return new f.Builder("iq",a)}function g(a){return new f.Builder("presence",a)}var f;f={VERSION:"",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",
SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style",
"height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(a){for(var b=0;b<f.XHTML.tags.length;b++)if(a==f.XHTML.tags[b])return!0;return!1},validAttribute:function(a,b){if("undefined"!==typeof f.XHTML.attributes[a]&&0<f.XHTML.attributes[a].length)for(var d=0;d<f.XHTML.attributes[a].length;d++)if(b==f.XHTML.attributes[a][d])return!0;
return!1},validCSS:function(a){for(var b=0;b<f.XHTML.css.length;b++)if(a==f.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(a,b){f.NS[a]=b},forEachChild:function(a,b,d){var e,g;for(e=0;e<a.childNodes.length;e++)g=a.childNodes[e],g.nodeType!=
f.ElementType.NORMAL||b&&!this.isTagEqual(g,b)||d(g)},isTagEqual:function(a,b){return a.tagName.toLowerCase()==b.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var a;void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){f._xmlGenerator||
(f._xmlGenerator=f._makeGenerator());return f._xmlGenerator},_getIEXmlDom:function(){for(var a=null,b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),d=0;d<b.length;d++)if(null===a)try{a=new ActiveXObject(b[d])}catch(f){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=f.xmlGenerator().createElement(a),d,e,g;for(d=1;d<arguments.length;d++)if(arguments[d])if("string"==
typeof arguments[d]||"number"==typeof arguments[d])b.appendChild(f.xmlTextNode(arguments[d]));else if("object"==typeof arguments[d]&&"function"==typeof arguments[d].sort)for(e=0;e<arguments[d].length;e++)"object"==typeof arguments[d][e]&&"function"==typeof arguments[d][e].sort&&b.setAttribute(arguments[d][e][0],arguments[d][e][1]);else if("object"==typeof arguments[d])for(g in arguments[d])arguments[d].hasOwnProperty(g)&&b.setAttribute(g,arguments[d][g]);return b},xmlescape:function(a){a=a.replace(/\&/g,
"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlTextNode:function(a){return f.xmlGenerator().createTextNode(a)},xmlHtmlNode:function(a){var b;window.DOMParser?b=(new DOMParser).parseFromString(a,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));return b},getText:function(a){if(!a)return null;var b="";0===a.childNodes.length&&a.nodeType==f.ElementType.TEXT&&(b+=a.nodeValue);for(var d=0;d<a.childNodes.length;d++)a.childNodes[d].nodeType==
f.ElementType.TEXT&&(b+=a.childNodes[d].nodeValue);return f.xmlescape(b)},copyElement:function(a){var b,d;if(a.nodeType==f.ElementType.NORMAL){d=f.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)d.setAttribute(a.attributes[b].nodeName.toLowerCase(),a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)d.appendChild(f.copyElement(a.childNodes[b]))}else a.nodeType==f.ElementType.TEXT&&(d=f.xmlGenerator().createTextNode(a.nodeValue));return d},createHtml:function(a){var b,d,e,g,l,k,r,u,v,
w,p;if(a.nodeType==f.ElementType.NORMAL)if(g=a.nodeName.toLowerCase(),f.XHTML.validTag(g))try{d=f.xmlElement(g);for(b=0;b<f.XHTML.attributes[g].length;b++)if(l=f.XHTML.attributes[g][b],k=a.getAttribute(l),"undefined"!=typeof k&&null!==k&&""!==k&&!1!==k&&0!==k)if("style"==l&&"object"==typeof k&&"undefined"!=typeof k.cssText&&(k=k.cssText),"style"==l){r=[];u=k.split(";");for(e=0;e<u.length;e++)v=u[e].split(":"),w=v[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),f.XHTML.validCSS(w)&&(p=v[1].replace(/^\s*/,
"").replace(/\s*$/,""),r.push(w+": "+p));0<r.length&&(k=r.join("; "),d.setAttribute(l,k))}else d.setAttribute(l,k);for(b=0;b<a.childNodes.length;b++)d.appendChild(f.createHtml(a.childNodes[b]))}catch(x){d=f.xmlTextNode("")}else for(d=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)d.appendChild(f.createHtml(a.childNodes[b]));else if(a.nodeType==f.ElementType.FRAGMENT)for(d=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)d.appendChild(f.createHtml(a.childNodes[b]));
else a.nodeType==f.ElementType.TEXT&&(d=f.xmlTextNode(a.nodeValue));return d},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,
":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=f.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,
a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var b;if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var d=a.nodeName,e,g;a.getAttribute("_realname")&&(d=a.getAttribute("_realname"));b="<"+d;for(e=0;e<a.attributes.length;e++)"_realname"!=a.attributes[e].nodeName&&(b+=" "+a.attributes[e].nodeName.toLowerCase()+
"='"+a.attributes[e].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'");if(0<a.childNodes.length){b+=">";for(e=0;e<a.childNodes.length;e++)switch(g=a.childNodes[e],g.nodeType){case f.ElementType.NORMAL:b+=f.serialize(g);break;case f.ElementType.TEXT:b+=f.xmlescape(g.nodeValue);break;case f.ElementType.CDATA:b+="<![CDATA["+g.nodeValue+"]]\x3e"}b+="</"+d+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){f._connectionPlugins[a]=
b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=f.NS.CLIENT:b||(b={xmlns:f.NS.CLIENT});this.node=this.nodeTree=f.xmlElement(a,b)}};f.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return f.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.node.setAttribute(b,a[b]);return this},c:function(a,b,d){a=f.xmlElement(a,b,d);this.node.appendChild(a);
d||(this.node=a);return this},cnode:function(a){var b,d=f.xmlGenerator();try{b=void 0!==d.importNode}catch(e){b=!1}a=b?d.importNode(a,!0):f.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){a=f.xmlTextNode(a);this.node.appendChild(a);return this},h:function(a){var b=document.createElement("body");b.innerHTML=a;for(a=f.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}};f.Handler=function(a,b,d,e,g,l,k){this.handler=a;this.ns=b;this.name=
d;this.type=e;this.id=g;this.options=k||{matchBare:!1};this.options.matchBare||(this.options.matchBare=!1);this.from=this.options.matchBare?l?f.getBareJidFromJid(l):null:l;this.user=!0};f.Handler.prototype={isMatch:function(a){var b,d=null,d=this.options.matchBare?f.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");b=!1;if(this.ns){var e=this;f.forEachChild(a,null,function(a){a.getAttribute("xmlns")==e.ns&&(b=!0)});b=b||a.getAttribute("xmlns")==this.ns}else b=!0;return!b||this.name&&
!f.isTagEqual(a,this.name)||this.type&&a.getAttribute("type")!=this.type||this.id&&a.getAttribute("id")!=this.id||this.from&&d!=this.from?!1:!0},run:function(a){var b=null;try{b=this.handler(a)}catch(d){throw d.sourceURL?f.fatal("error: "+this.handler+" "+d.sourceURL+":"+d.line+" - "+d.name+": "+d.message):d.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",d,d.message)),f.fatal("error: "+this.handler+" "+d.fileName+":"+d.lineNumber+" - "+d.name+": "+
d.message)):f.fatal("error: "+d.message+"\n"+d.stack),d;}return b},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};f.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0};f.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+
")}"}};f.Connection=function(a,b){this.service=a;this.options=b||{};var d=this.options.protocol||"";0===a.indexOf("ws:")||0===a.indexOf("wss:")||0===d.indexOf("ws")?this._proto=new f.Websocket(this):this._proto=new f.Bosh(this);this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._disconnectTimeout=this._idleTimeout=
null;this.do_authentication=!0;this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var e in f._connectionPlugins)f._connectionPlugins.hasOwnProperty(e)&&(d=function(){},d.prototype=f._connectionPlugins[e],this[e]=new d,this[e].init(this))};f.Connection.prototype={reset:function(){this._proto._reset();
this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return"string"==typeof a||"number"==typeof a?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,b,d,e,g,l){this.jid=
a;this.authzid=f.getBareJidFromJid(this.jid);this.authcid=f.getNodeFromJid(this.jid);this.pass=b;this.servtype="xmpp";this.connect_callback=d;this.authenticated=this.connected=this.disconnecting=!1;this.errors=0;this.domain=f.getDomainFromJid(this.jid);this._changeConnectStatus(f.Status.CONNECTING,null);this._proto._connect(e,g,l)},attach:function(a,b,d,f,e,g,k){this._proto._attach(a,b,d,f,e,g,k)},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},send:function(a){if(null!==
a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,b,d,f){var e=null,g=this;"function"===typeof a.tree&&(a=a.tree());var k=a.getAttribute("id");k||(k=this.getUniqueId("sendIQ"),a.setAttribute("id",k));var r=this.addHandler(function(a){e&&g.deleteTimedHandler(e);var f=a.getAttribute("type");
if("result"==f)b&&b(a);else if("error"==f)d&&d(a);else throw{name:"StropheError",message:"Got bad IQ type of "+f};},null,"iq",null,k);f&&(e=this.addTimedHandler(f,function(){g.deleteHandler(r);d&&d(null);return!1}));this.send(a);return k},_queueData:function(a){if(null===a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.bind(this),
100)},addTimedHandler:function(a,b){var d=new f.TimedHandler(a,b);this.addTimeds.push(d);return d},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,b,d,e,g,l,k){a=new f.Handler(a,b,d,e,g,l,k);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(f.Status.DISCONNECTING,a);f.info("Disconnect was called because: "+a);this.connected&&(a=!1,this.disconnecting=!0,this.authenticated&&(a=g({xmlns:f.NS.CLIENT,
type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a))},_changeConnectStatus:function(a,b){for(var d in f._connectionPlugins)if(f._connectionPlugins.hasOwnProperty(d)){var e=this[d];if(e.statusChanged)try{e.statusChanged(a,b)}catch(g){f.error(""+d+" plugin caused an exception changing status: "+g)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(l){f.error("User connection callback caused an exception: "+
l)}},_doDisconnect:function(){null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);f.info("_doDisconnect was called");this._proto._doDisconnect();this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(f.Status.DISCONNECTED,null);this.connected=!1},_dataRecv:function(a,b){f.info("_dataRecv called");var d=this._proto._reqToData(a);
if(null!==d){this.xmlInput!==f.Connection.prototype.xmlInput&&(d.nodeName===this._proto.strip&&d.childNodes.length?this.xmlInput(d.childNodes[0]):this.xmlInput(d));this.rawInput!==f.Connection.prototype.rawInput&&(b?this.rawInput(b):this.rawInput(f.serialize(d)));for(var e;0<this.removeHandlers.length;)e=this.removeHandlers.pop(),e=this.handlers.indexOf(e),0<=e&&this.handlers.splice(e,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();
else if(e=d.getAttribute("type"),null!==e&&"terminate"==e)this.disconnecting||(e=d.getAttribute("condition"),d=d.getElementsByTagName("conflict"),null!==e?("remote-stream-error"==e&&0<d.length&&(e="conflict"),this._changeConnectStatus(f.Status.CONNFAIL,e)):this._changeConnectStatus(f.Status.CONNFAIL,"unknown"),this.disconnect("unknown stream-error"));else{var g=this;f.forEachChild(d,null,function(a){var b,d;d=g.handlers;g.handlers=[];for(b=0;b<d.length;b++){var e=d[b];try{!e.isMatch(a)||!g.authenticated&&
e.user?g.handlers.push(e):e.run(a)&&g.handlers.push(e)}catch(h){f.warn("Removing Strophe handlers due to uncaught exception: "+h.message)}}})}}},mechanisms:{},_connect_cb:function(a,b,d){f.info("_connect_cb was called");this.connected=!0;if(a=this._proto._reqToData(a))if(this.xmlInput!==f.Connection.prototype.xmlInput&&(a.nodeName===this._proto.strip&&a.childNodes.length?this.xmlInput(a.childNodes[0]):this.xmlInput(a)),this.rawInput!==f.Connection.prototype.rawInput&&(d?this.rawInput(d):this.rawInput(f.serialize(a))),
this._proto._connect_cb(a)!==f.Status.CONNFAIL){this._authentication.sasl_scram_sha1=!1;this._authentication.sasl_plain=!1;this._authentication.sasl_digest_md5=!1;this._authentication.sasl_anonymous=!1;this._authentication.legacy_auth=!1;var e=0<a.getElementsByTagName("stream:features").length;e||(e=0<a.getElementsByTagName("features").length);d=a.getElementsByTagName("mechanism");var g=[],l;l=!1;if(e){if(0<d.length)for(e=0;e<d.length;e++)l=f.getText(d[e]),this.mechanisms[l]&&g.push(this.mechanisms[l]);
this._authentication.legacy_auth=0<a.getElementsByTagName("auth").length;(l=this._authentication.legacy_auth||0<g.length)?!1!==this.do_authentication&&this.authenticate(g):this._proto._no_auth_received(b)}else this._proto._no_auth_received(b)}},authenticate:function(a){var d;for(d=0;d<a.length-1;++d){for(var g=d,m=d+1;m<a.length;++m)a[m].prototype.priority>a[g].prototype.priority&&(g=m);g!=d&&(m=a[d],a[d]=a[g],a[g]=m)}g=!1;for(d=0;d<a.length;++d)if(a[d].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),
null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new a[d];this._sasl_mechanism.onStart(this);a=b("auth",{xmlns:f.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(d=this._sasl_mechanism.onChallenge(this,null),a.t(Base64.encode(d)));this.send(a.tree());
g=!0;break}g||(null===f.getNodeFromJid(this.jid)?(this._changeConnectStatus(f.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(e({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).tree())))},_sasl_challenge_cb:function(a){a=Base64.decode(f.getText(a));
a=this._sasl_mechanism.onChallenge(this,a);var d=b("response",{xmlns:f.NS.SASL});""!==a&&d.t(Base64.encode(a));this.send(d.tree());return!0},_auth1_cb:function(a){a=e({type:"set",id:"_auth_2"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).up().c("password").t(this.pass);f.getResourceFromJid(this.jid)||(this.jid=f.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(f.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,
"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){if(this._sasl_data["server-signature"]){var b;a=Base64.decode(f.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"==a[1]&&(b=a[2]);if(b!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}f.info("SASL authentication succeeded.");
if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var b,d;for(b=0;b<a.childNodes.length;b++)d=a.childNodes[b],"bind"==d.nodeName&&(this.do_bind=
!0),"session"==d.nodeName&&(this.do_session=!0);this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=f.getResourceFromJid(this.jid))?this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).c("resource",{}).t(a).tree()):this.send(e({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).tree())):this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type")){f.info("SASL binding failed.");
var b;0<a.getElementsByTagName("conflict").length&&(b="conflict");this._changeConnectStatus(f.Status.AUTHFAIL,b);return!1}a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=f.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(e({type:"set",id:"_session_auth_2"}).c("session",{xmlns:f.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,
null)));else return f.info("SASL binding failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(f.info("Session creation failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=
null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(f.Status.AUTHFAIL,null),this.disconnect("authentication failed"));return!1},
_addSysTimedHandler:function(a,b){var d=new f.TimedHandler(a,b);d.user=!1;this.addTimeds.push(d);return d},_addSysHandler:function(a,b,d,e,g){a=new f.Handler(a,b,d,e,g);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){f.info("_onDisconnectTimeout was called");this._proto._onDisconnectTimeout();this._doDisconnect();return!1},_onIdle:function(){for(var a,b,d,e;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),
a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var f=(new Date).getTime();e=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)d=b.lastCalled+b.period,0>=d-f?b.run()&&e.push(b):e.push(b);this.timedHandlers=e;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}};a&&a(f,b,d,e,g);f.SASLMechanism=function(a,b,d){this.name=a;this.isClientFirst=b;this.priority=
d};f.SASLMechanism.prototype={test:function(a){return!0},onStart:function(a){this._connection=a},onChallenge:function(a,b){throw Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};f.SASLAnonymous=function(){};f.SASLAnonymous.prototype=new f.SASLMechanism("ANONYMOUS",!1,10);f.SASLAnonymous.test=function(a){return null===a.authcid};f.Connection.prototype.mechanisms[f.SASLAnonymous.prototype.name]=f.SASLAnonymous;
f.SASLPlain=function(){};f.SASLPlain.prototype=new f.SASLMechanism("PLAIN",!0,20);f.SASLPlain.test=function(a){return null!==a.authcid};f.SASLPlain.prototype.onChallenge=function(a){var b=a.authzid,b=b+"\x00"+a.authcid,b=b+"\x00";return b+=a.pass};f.Connection.prototype.mechanisms[f.SASLPlain.prototype.name]=f.SASLPlain;f.SASLSHA1=function(){};f.SASLSHA1.prototype=new f.SASLMechanism("SCRAM-SHA-1",!0,40);f.SASLSHA1.test=function(a){return null!==a.authcid};f.SASLSHA1.prototype.onChallenge=function(a,
b,d){b=d||MD5.hexdigest(1234567890*Math.random());d="n="+a.authcid;d=d+",r="+b;a._sasl_data.cnonce=b;a._sasl_data["client-first-message-bare"]=d;d="n,,"+d;this.onChallenge=function(a,b){var d,e,f,g,h,q="c=biws,",p=a._sasl_data["client-first-message-bare"]+","+b+",";h=a._sasl_data.cnonce;for(g=/([a-z]+)=([^,]+)(,|$)/;b.match(g);){var s=b.match(g);b=b.replace(s[0],"");switch(s[1]){case "r":d=s[2];break;case "s":e=s[2];break;case "i":f=s[2]}}if(d.substr(0,h.length)!==h)return a._sasl_data={},a._sasl_failure_cb();
q+="r="+d;p+=q;e=Base64.decode(e);d=e=core_hmac_sha1(a.pass,e+"\x00\x00\x00\u0001");for(h=1;h<f;h++){g=core_hmac_sha1(a.pass,binb2str(e));for(e=0;5>e;e++)d[e]^=g[e];e=g}d=binb2str(d);f=core_hmac_sha1(d,"Client Key");e=str_hmac_sha1(d,"Server Key");d=core_hmac_sha1(str_sha1(binb2str(f)),p);a._sasl_data["server-signature"]=b64_hmac_sha1(e,p);for(e=0;5>e;e++)f[e]^=d[e];return q+=",p="+Base64.encode(binb2str(f))}.bind(this);return d};f.Connection.prototype.mechanisms[f.SASLSHA1.prototype.name]=f.SASLSHA1;
f.SASLMD5=function(){};f.SASLMD5.prototype=new f.SASLMechanism("DIGEST-MD5",!1,30);f.SASLMD5.test=function(a){return null!==a.authcid};f.SASLMD5.prototype._quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};f.SASLMD5.prototype.onChallenge=function(a,b,d){var e=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;d=d||MD5.hexdigest(""+1234567890*Math.random());for(var f="",g=null,k="",r;b.match(e);)switch(r=b.match(e),b=b.replace(r[0],""),r[2]=r[2].replace(/^"(.+)"$/,"$1"),r[1]){case "realm":f=
r[2];break;case "nonce":k=r[2];break;case "host":g=r[2]}b=a.servtype+"/"+a.domain;null!==g&&(b=b+"/"+g);e=MD5.hash(a.authcid+":"+f+":"+this._connection.pass)+":"+k+":"+d;g="AUTHENTICATE:"+b;a="charset=utf-8,"+("username="+this._quote(a.authcid)+",");a+="realm="+this._quote(f)+",";a+="nonce="+this._quote(k)+",";a+="nc=00000001,";a+="cnonce="+this._quote(d)+",";a+="digest-uri="+this._quote(b)+",";a+="response="+MD5.hexdigest(MD5.hexdigest(e)+":"+k+":00000001:"+d+":auth:"+MD5.hexdigest(g))+",";a+="qop=auth";
this.onChallenge=function(){return""}.bind(this);return a};f.Connection.prototype.mechanisms[f.SASLMD5.prototype.name]=f.SASLMD5})(function(a,b,d,e,g){window.Strophe=a;window.$build=b;window.$msg=d;window.$iq=e;window.$pres=g});
Strophe.Request=function(a,b,d,e){this.id=++Strophe._requestId;this.xmlData=a;this.data=Strophe.serialize(a);this.func=this.origFunc=b;this.rid=d;this.date=NaN;this.sends=e||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?(new Date-this.dead)/1E3:0};this.xhr=this._newXHR()};
Strophe.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"==a.tagName)throw Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)),"parsererror";}else this.xhr.responseText&&(Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),
Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};Strophe.Bosh=function(a){this._conn=a;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this._requests=[]};
Strophe.Bosh.prototype={strip:null,_buildBody:function(){var a=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});null!==this.sid&&a.attrs({sid:this.sid});return a},_reset:function(){this.rid=Math.floor(4294967295*Math.random());this.sid=null},_connect:function(a,b,d){this.wait=a||this.wait;this.hold=b||this.hold;a=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});
d&&a.attrs({route:d});d=this._conn._connect_cb;this._requests.push(new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,d.bind(this._conn)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(a,b,d,e,g,f,h){this._conn.jid=a;this.sid=b;this.rid=d;this._conn.connect_callback=e;this._conn.domain=Strophe.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=g||this.wait;this.hold=f||this.hold;this.window=h||this.window;
this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null)},_connect_cb:function(a){var b=a.getAttribute("type"),d;if(null!==b&&"terminate"==b)return Strophe.error("BOSH-Connection failed: "+d),d=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==d&&0<a.length&&(d="conflict"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,d)):this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(),Strophe.Status.CONNFAIL;
this.sid||(this.sid=a.getAttribute("sid"));if(d=a.getAttribute("requests"))this.window=parseInt(d,10);if(d=a.getAttribute("hold"))this.hold=parseInt(d,10);if(a=a.getAttribute("wait"))this.wait=parseInt(a,10)},_disconnect:function(a){this._sendTerminate(a)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(4294967295*Math.random())},_emptyQueue:function(){return 0===this._requests.length},_hitError:function(a){this.errors++;Strophe.warn("request errored, status: "+a+", number of errors: "+
this.errors);4<this.errors&&this._onDisconnectTimeout()},_no_auth_received:function(a){a=a?a.bind(this._conn):this._conn._connect_cb.bind(this._conn);var b=this._buildBody();this._requests.push(new Strophe.Request(b.tree(),this._onRequestStateChange.bind(this,a.bind(this._conn)),b.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){}},_onIdle:function(){var a=
this._conn._data;this._conn.authenticated&&0===this._requests.length&&0===a.length&&!this._conn.disconnecting&&(Strophe.info("no requests during idle cycle, sending blank request"),a.push(null));if(2>this._requests.length&&0<a.length&&!this._conn.paused){for(var b=this._buildBody(),d=0;d<a.length;d++)null!==a[d]&&("restart"===a[d]?b.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH}):b.cnode(a[d]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new Strophe.Request(b.tree(),
this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),b.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}0<this._requests.length&&(a=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),a>Math.floor(Strophe.TIMEOUT*this.wait)&&(Strophe.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity"),
this._throttledRequestHandler()))},_onRequestStateChange:function(a,b){Strophe.debug("request id "+b.id+"."+b.sends+" state changed to "+b.xhr.readyState);if(b.abort)b.abort=!1;else{var d;if(4==b.xhr.readyState){d=0;try{d=b.xhr.status}catch(e){}"undefined"==typeof d&&(d=0);if(this.disconnecting&&400<=d)this._hitError(d);else{var g=this._requests[0]==b,f=this._requests[1]==b;if(0<d&&500>d||5<b.sends)this._removeRequest(b),Strophe.debug("request id "+b.id+" should now be removed");if(200==d)(f||g&&
0<this._requests.length&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),Strophe.debug("request id "+b.id+"."+b.sends+" got 200"),a(b),this.errors=0;else if(Strophe.error("request id "+b.id+"."+b.sends+" error "+d+" happened"),0===d||400<=d&&600>d||12E3<=d)this._hitError(d),400<=d&&500>d&&(this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null),this._conn._doDisconnect());0<d&&500>d||5<b.sends||this._throttledRequestHandler()}}}},_processRequest:function(a){var b=
this,d=this._requests[a],e=-1;try{4==d.xhr.readyState&&(e=d.xhr.status)}catch(g){Strophe.error("caught an error in _requests["+a+"], reqStatus: "+e)}"undefined"==typeof e&&(e=-1);if(d.sends>this.maxRetries)this._onDisconnectTimeout();else{var f=d.age(),f=!isNaN(f)&&f>Math.floor(Strophe.TIMEOUT*this.wait),h=null!==d.dead&&d.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait),e=4==d.xhr.readyState&&(1>e||500<=e);if(f||h||e)h&&Strophe.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),
d.abort=!0,d.xhr.abort(),d.xhr.onreadystatechange=function(){},this._requests[a]=new Strophe.Request(d.xmlData,d.origFunc,d.rid,d.sends),d=this._requests[a];if(0===d.xhr.readyState){Strophe.debug("request id "+d.id+"."+d.sends+" posting");try{d.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0)}catch(q){Strophe.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}a=function(){d.date=new Date;
if(b._conn.options.customHeaders){var a=b._conn.options.customHeaders,e;for(e in a)a.hasOwnProperty(e)&&d.xhr.setRequestHeader(e,a[e])}d.xhr.send(d.data)};1<d.sends?(e=1E3*Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(d.sends,3)),setTimeout(a,e)):a();d.sends++;this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput&&(d.xmlData.nodeName===this.strip&&d.xmlData.childNodes.length?this._conn.xmlOutput(d.xmlData.childNodes[0]):this._conn.xmlOutput(d.xmlData));this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput&&
this._conn.rawOutput(d.data)}else Strophe.debug("_processRequest: "+(0===a?"first":"second")+" request has readyState of "+d.xhr.readyState)}},_removeRequest:function(a){Strophe.debug("removing request");var b;for(b=this._requests.length-1;0<=b;b--)a==this._requests[b]&&this._requests.splice(b,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];null===b.dead&&(b.dead=new Date);this._processRequest(a)},_reqToData:function(a){try{return a.getResponse()}catch(b){if("parsererror"!=
b)throw b;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(a){Strophe.info("_sendTerminate was called");var b=this._buildBody().attrs({type:"terminate"});a&&b.cnode(a.tree());a=new Strophe.Request(b.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),b.tree().getAttribute("rid"));this._requests.push(a);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=
setTimeout(this._conn._onIdle.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):Strophe.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-
this._requests[1].rid)<this.window&&this._processRequest(1))}};Strophe.Websocket=function(a){this._conn=a;this.strip="stream:stream";var b=a.service;if(0!==b.indexOf("ws:")&&0!==b.indexOf("wss:")){var d="",d="ws"===a.options.protocol&&"https:"!==window.location.protocol?d+"ws":d+"wss",d=d+("://"+window.location.host),d=0!==b.indexOf("/")?d+(window.location.pathname+b):d+b;a.service=d}};
Strophe.Websocket.prototype={_buildStream:function(){return $build("stream:stream",{to:this._conn.domain,xmlns:Strophe.NS.CLIENT,"xmlns:stream":Strophe.NS.STREAM,version:"1.0"})},_check_streamerror:function(a,b){var d=a.getElementsByTagName("stream:error");if(0===d.length)return!1;for(var e=d[0],g=d="",f=0;f<e.childNodes.length;f++){var h=e.childNodes[f];if("urn:ietf:params:xml:ns:xmpp-streams"!==h.getAttribute("xmlns"))break;"text"===h.nodeName?g=h.textContent:d=h.nodeName}e="WebSocket stream error: ";
e=d?e+d:e+"unknown";g&&(e+=" - "+d);Strophe.error(e);this._conn._changeConnectStatus(b,d);this._conn._doDisconnect();return!0},_reset:function(){},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(a){if(this._check_streamerror(a,Strophe.Status.CONNFAIL))return Strophe.Status.CONNFAIL},
_handleStreamStart:function(a){var b=!1,d=a.getAttribute("xmlns");"string"!==typeof d?b="Missing xmlns in stream:stream":d!==Strophe.NS.CLIENT&&(b="Wrong xmlns in stream:stream: "+d);d=a.namespaceURI;"string"!==typeof d?b="Missing xmlns:stream in stream:stream":d!==Strophe.NS.STREAM&&(b="Wrong xmlns:stream in stream:stream: "+d);a=a.getAttribute("version");"string"!==typeof a?b="Missing version in stream:stream":"1.0"!==a&&(b="Wrong version in stream:stream: "+a);return b?(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,
b),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(a){if(0===a.data.indexOf("<stream:stream ")||0===a.data.indexOf("<?xml")){var b=a.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==b&&(b=a.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>"),b=(new DOMParser).parseFromString(b,"text/xml").documentElement,this._conn.xmlInput(b),this._conn.rawInput(a.data),this._handleStreamStart(b)&&(this._connect_cb(b),this.streamStart=a.data.replace(/^<stream:(.*)\/>$/,"<stream:$1>")))}else"</stream:stream>"===
a.data?(this._conn.rawInput(a.data),this._conn.xmlInput(document.createElement("stream:stream")),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect()):(b=this._streamWrap(a.data),b=(new DOMParser).parseFromString(b,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(b,null,a.data))},_disconnect:function(a){if(this.socket.readyState!==WebSocket.CLOSED){a&&this._conn.send(a);this._conn.xmlOutput(document.createElement("stream:stream"));
this._conn.rawOutput("</stream:stream>");try{this.socket.send("</stream:stream>")}catch(b){Strophe.info("Couldn't send closing stream tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){Strophe.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(a){return this.streamStart+a+"</stream:stream>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(a){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&
!this._conn.disconnecting?(Strophe.error("Websocket closed unexcectedly"),this._conn._doDisconnect()):Strophe.info("Websocket closed")},_no_auth_received:function(a){Strophe.error("Server did not send any auth methods");this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Server did not send any auth methods");a&&(a=a.bind(this._conn),a());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_onError:function(a){Strophe.error("Websocket error "+a);this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,
"The WebSocket connection could not be established was disconnected.");this._disconnect()},_onIdle:function(){var a=this._conn._data;if(0<a.length&&!this._conn.paused){for(var b=0;b<a.length;b++)if(null!==a[b]){var d,e;"restart"===a[b]?(d=this._buildStream(),e=this._removeClosingTag(d),d=d.tree()):(d=a[b],e=Strophe.serialize(d));this._conn.xmlOutput(d);this._conn.rawOutput(e);this.socket.send(e)}this._conn._data=[]}},_onMessage:function(a){var b;if("</stream:stream>"===a.data)this._conn.rawInput("</stream:stream>"),
this._conn.xmlInput(document.createElement("stream:stream")),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===a.data.search("<stream:stream ")){if(b=a.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>"),b=(new DOMParser).parseFromString(b,"text/xml").documentElement,!this._handleStreamStart(b))return}else b=this._streamWrap(a.data),b=(new DOMParser).parseFromString(b,"text/xml").documentElement;this._check_streamerror(b,Strophe.Status.ERROR)||(this._conn.disconnecting&&
"presence"===b.firstChild.nodeName&&"unavailable"===b.firstChild.getAttribute("type")?(this._conn.xmlInput(b),this._conn.rawInput(Strophe.serialize(b))):this._conn._dataRecv(b,a.data))}},_onOpen:function(){Strophe.info("Websocket open");var a=this._buildStream();this._conn.xmlOutput(a.tree());a=this._removeClosingTag(a);this._conn.rawOutput(a);this.socket.send(a)},_removeClosingTag:function(a){a=Strophe.serialize(a);return a=a.replace(/<(stream:stream .*[^\/])\/>$/,"<$1>")},_reqToData:function(a){return a},
_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};Strophe.addConnectionPlugin("register",{_connection:null,init:function(a){this._connection=a;var b=0;Object.keys(Strophe.Status).forEach(function(a){b=Math.max(b,Strophe.Status[a])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGIFAIL=b+1;Strophe.Status.REGISTER=b+2;Strophe.Status.REGISTERED=b+3;Strophe.Status.CONFLICT=b+4;Strophe.Status.NOTACCEPTABLE=b+5;a.disco&&a.disco.addFeature(Strophe.NS.REGISTER);var d=this,e=a.reset.bind(a);a.reset=function(){e();d.instructions="";
d.fields={};d.registered=!1};var g=a._connect_cb.bind(a);a._connect_cb=function(b,e,f){if(d._registering)d._connect_cb_data={req:b,raw:f},d.processed_features=!0,d._register_cb(b,e,f),delete d._registering;else if(d.processed_features){var m=a.xmlInput;a.xmlInput=Strophe.Connection.prototype.xmlInput;var n=a.rawInput;a.rawInput=Strophe.Connection.prototype.rawInput;g(b,e,f);a.xmlInput=m;a.rawInput=n;delete d.processed_features}else g(b,e,f)};var f=a.authenticate.bind(a);a.authenticate=function(a){"undefined"===
typeof a?(a=this._connection,this.fields.username&&this.domain&&this.fields.password?(a.jid=this.fields.username+"@"+this.domain,a.authzid=Strophe.getBareJidFromJid(a.jid),a.authcid=Strophe.getNodeFromJid(a.jid),a.pass=this.fields.password,a._connect_cb(this._connect_cb_data.req,a.connect_callback,this._connect_cb_data.raw)):Strophe.info("Register a JID first!")):f(a)}.bind(this)},connect:function(a,b,d,e,g){var f=this._connection;this.domain=Strophe.getDomainFromJid(a);this.instructions="";this.fields=
{};this.registered=!1;this._registering=!0;f.connect(this.domain,"",b,d,e,g)},_register_cb:function(a,b,d){var e=this._connection;Strophe.info("_register_cb was called");e.connected=!0;if(a=e._proto._reqToData(a))e.xmlInput!==Strophe.Connection.prototype.xmlInput&&(a.nodeName===e._proto.strip&&a.childNodes.length?e.xmlInput(a.childNodes[0]):e.xmlInput(a)),e.rawInput!==Strophe.Connection.prototype.rawInput&&(d?e.rawInput(d):e.rawInput(Strophe.serialize(a))),e._proto._connect_cb(a)!==Strophe.Status.CONNFAIL&&
(d=a.getElementsByTagName("register"),a=a.getElementsByTagName("mechanism"),0===d.length&&0===a.length?e._proto._no_auth_received(b):(e._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null),e.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree())))},_get_register_cb:function(a){var b,d,e=this._connection;b=a.getElementsByTagName("query");if(1!==b.length)return e._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;b=b[0];for(a=0;a<b.childNodes.length;a++)d=b.childNodes[a],
"instructions"===d.tagName.toLowerCase()?e.register.instructions=Strophe.getText(d):"x"!==d.tagName.toLowerCase()&&(e.register.fields[d.tagName.toLowerCase()]=Strophe.getText(d));e._changeConnectStatus(Strophe.Status.REGISTER,null);return!1},submit:function(){var a,b,d,e,g=this._connection;d=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER});e=Object.keys(this.fields);for(a=0;a<e.length;a++)b=e[a],d.c(b).t(this.fields[b]).up();g._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);
g.send(d)},_submit_cb:function(a){var b,d,e;b=null;var g=this._connection;d=a.getElementsByTagName("query");if(0<d.length)for(d=d[0],b=0;b<d.childNodes.length;b++)e=d.childNodes[b],"instructions"===e.tagName.toLowerCase()?this.instructions=Strophe.getText(e):this.fields[e.tagName.toLowerCase()]=Strophe.getText(e);if("error"===a.getAttribute("type")){b=a.getElementsByTagName("error");if(1!==b.length)return g._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;Strophe.info("Registration failed.");
b=b[0].firstChild.tagName.toLowerCase();"conflict"===b?g._changeConnectStatus(Strophe.Status.CONFLICT,b):"not-acceptable"===b?g._changeConnectStatus(Strophe.Status.NOTACCEPTABLE,b):g._changeConnectStatus(Strophe.Status.REGIFAIL,b)}Strophe.info("Registered successful.");g._changeConnectStatus(Strophe.Status.REGISTERED,null);return!1}});Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(a){this._connection=a;this._identities=[];this._features=[];this._items=[];a.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);a.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(a,b,d,e){for(var g=0;g<this._identities.length;g++)if(this._identities[g].category==a&&this._identities[g].type==b&&this._identities[g].name==
d&&this._identities[g].lang==e)return!1;this._identities.push({category:a,type:b,name:d,lang:e});return!0},addFeature:function(a){for(var b=0;b<this._features.length;b++)if(this._features[b]==a)return!1;this._features.push(a);return!0},addItem:function(a,b,d,e){if(d&&!e)return!1;this._items.push({jid:a,name:b,node:d,call_back:e});return!0},info:function(a,b,d,e){var g={xmlns:Strophe.NS.DISCO_INFO};b&&(g.node=b);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",g);this._connection.sendIQ(a,
d,e)},items:function(a,b,d,e){var g={xmlns:Strophe.NS.DISCO_ITEMS};b&&(g.node=b);a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",g);this._connection.sendIQ(a,d,e)},_onDiscoInfo:function(a){var b=a.getAttribute("id"),d=a.getAttribute("from"),e=a.getElementsByTagName("query")[0].getAttribute("node");a={xmlns:Strophe.NS.DISCO_INFO};e&&(a.node=e);b=$iq({type:"result",id:b,to:d}).c("query",a);for(d=0;d<this._identities.length;d++)a={category:this._identities[d].category,type:this._identities[d].type},
this._identities[d].name&&(a.name=this._identities[d].name),this._identities[d].lang&&(a["xml:lang"]=this._identities[d].lang),b.c("identity",a).up();for(d=0;d<this._features.length;d++)b.c("feature",{"var":this._features[d]}).up();this._connection.send(b.tree())},_onDiscoItems:function(a){var b=a.getAttribute("id"),d=a.getAttribute("from"),e={xmlns:Strophe.NS.DISCO_ITEMS},g=a.getElementsByTagName("query")[0].getAttribute("node");if(g){e.node=g;for(var f=null,h=0;h<this._items.length;h++)if(this._items[h].node==
g){f=this._items[h].call_back(a);break}}else f=this._items;a=$iq({type:"result",id:b,to:d}).c("query",e);for(h=0;h<f.length;h++)b={jid:f[h].jid},f[h].name&&(b.name=f[h].name),f[h].node&&(b.node=f[h].node),a.c("item",b).up();this._connection.send(a.tree())}});Ext.ns("Application");
Application.LoginPanel=Ext.extend(Ext.Panel,{initComponent:function(){this.items=[{html:'<img src="../images/nws.png" width="100"/>',height:105,width:105},{xtype:"panel",autoShow:!0,el:"myloginform",layout:"form",id:"myform",width:276,labelWidth:76,defaultType:"textfield",defaults:{allowBlank:!1},items:[{anchor:"100%",el:"username",id:"username",autoShow:!0,fieldLabel:"Username"},{anchor:"100%",el:"password",id:"password",autoShow:!0,fieldLabel:"Password",listeners:{specialkey:function(a,b){b.getKey()===
b.ENTER&&(Application.doLogin(),b.stopEvent())}}}],buttons:[{text:"Show Debug",handler:function(){Ext.getCmp("debug").show()}},{text:"Browser Save Login",handler:function(a,b){Ext.get("submit").dom.click()}},{text:"Login",handler:Application.doLogin}]},{xtype:"panel",colspan:2,contentEl:"loginmessage",preventBodyReset:!0}];Ext.apply(this,Ext.apply(this.initialConfig,{autoScroll:!0,title:"Login with Account",layout:"table",layoutConfig:{columns:2}}));Application.LoginPanel.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.insertFirst(this.items.items[2].body,{msg:a,date:new Date})}});Ext.namespace("Application");
Application.TabLoginPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{width:420,height:250,autoScroll:!0}));Application.TabLoginPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){Application.LOGIN_OPT_USER&&this.add(new Application.LoginPanel({id:"loginpanel"}));Application.LOGIN_OPT_ANONYMOUS&&this.add({xtype:"panel",contentEl:"anonymous_div",preventBodyReset:!0,title:"Anonymous Login"});Application.LOGIN_OPT_REGISTER&&
this.add({xtype:"panel",contentEl:"register_div",preventBodyReset:!0,title:"Register Account"});this.activate(0)}});Ext.reg("tabloginpanel",Application.TabLoginPanel);Ext.ns("Application");
Application.DebugWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{xtype:"panel",title:"Debug Log",html:"<p>Browser CodeName: "+navigator.appCodeName+"</p><p>Browser Name: "+navigator.appName+"</p><p>Browser Version: "+navigator.appVersion+"</p><p>Cookies Enabled: "+navigator.cookieEnabled+"</p><p>Platform: "+navigator.platform+"</p><p>User-agent header: "+navigator.userAgent+"</p>",autoScroll:!0}];this.tbar=[{text:"Click to send this log to developer!",icon:"icons/print.png",scope:this,
handler:function(){Ext.Ajax.request({url:"bug.php",method:"POST",success:function(a){alert(a.responseText)},failure:function(){},headers:{"my-header":"foo"},params:{data:this.items.items[0].body.dom.innerHTML,user:Application.USERNAME}})}},{text:"Clear Log",icon:"icons/close.png",handler:function(){this.items.items[0].update("")},scope:this}];Ext.apply(this,Ext.apply(this.initialConfig,{width:600,height:300,title:"Debug Window",closeAction:"hide",hidden:!0,autoScroll:!0,layout:"fit"}));Application.DebugWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(a){Application.msgtpl.append(this.items.items[0].body,{msg:a,date:new Date})}});Ext.ns("Application");
Application.MUCChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",chatType:"groupchat",barejid:null,handle:null,anonymous:null,joinedChat:!1,initComponent:function(){this.items=[{xtype:"chatgridpanel",region:"center"},{xtype:"chattextentry",region:"south",height:50,split:!0}];"allchats"!=this.initialConfig.chatType?(this.items.push({xtype:"mucroomusers",region:"east",width:175,collapsible:!0,split:!0}),this.iconCls="tabno"):this.items[1].emptyText="Type message here";Ext.apply(this,
Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.iconCls&&a.setIconCls("tabno")},deactivate:function(a){a.iconCls&&a.setIconCls("tabno")}}}));Application.MUCChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},clearRoom:function(){this.gp.getStore().removeAll();this.roomusers.root.removeAll()},getJidByHandle:function(a){a=this.roomusers.root.findChild("text",a);return null==a||Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPMUCHOST?null:a.attributes.jid},
buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];if("allchats"==this.chatType)this.gp.toolbars[0].items.items[4].disable(),this.gp.soundOn=!1,this.te.items.items[1].setText("To Room?");else{this.roomusers=this.items.items[2];new Ext.tree.TreeSorter(this.roomusers,{folderSort:!0,dir:"asc",property:"text"});this.anonymous&&this.te.disable();var a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::mute";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[4].toggle(!0,
!0),this.gp.toolbars[0].items.items[4].setText("Sounds Muted"),this.gp.soundOn=!1);a="muc::"+Strophe.getNodeFromJid(this.barejid)+"::nwsbothidden";Application.getPreference(a,!1)&&(this.gp.toolbars[0].items.items[3].toggle(!0,!0),this.gp.toolbars[0].items.items[3].setText("NWSBot Hidden"),this.gp.store.filterBy(nwsbotFilter))}}});Ext.reg("mucchatpanel",Application.MUCChatPanel);Ext.ns("Application");
Application.MUCRoomUsers=Ext.extend(Ext.tree.TreePanel,{bodyStyle:{"margin-left":"-15px"},title:"0 people in room",rootVisible:!1,lines:!1,autoScroll:!0,initComponent:function(){this.root={text:"test",listeners:{append:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")},remove:function(a,d){sz=d.childNodes.length;a.setTitle(sz+" people in room")}}};var a={plugins:new Ext.ux.DataTip({tpl:"<div>JID: {jid}<br />Affiliation: {affiliation}<br />Role: {role}</div>",constrainPosition:!0}),
listeners:{click:function(a){if(a.attributes.jid&&(username=Strophe.getNodeFromJid(a.attributes.jid),username!=Application.USERNAME)){var d=a.attributes.jid;Strophe.getDomainFromJid(a.attributes.jid)==Application.XMPPHOST&&(d=Strophe.getBareJidFromJid(a.attributes.jid));Application.log("Wish to start chat with:"+d);(cp=Ext.getCmp("chatpanel").getChat(d))||(cp=Ext.getCmp("chatpanel").addChat(d));Ext.getCmp("chatpanel").setActiveTab(cp)}}}};Ext.apply(this,Ext.apply(this.initialConfig,a));Application.MUCRoomUsers.superclass.initComponent.apply(this,
arguments);this.buildItems()},buildItems:function(){}});Ext.reg("mucroomusers",Application.MUCRoomUsers);Ext.ns("Application");Application.colors="000000 666666 D51460 FF0000 993333 FF9900 005500 009900 00DD00 0066CC 3399FF 0000FF 6666FF".split(" ");Application.colorpointer=0;Application.UserColorStore=new Ext.data.Store({fields:["user","color"]});
Application.getUserColor=function(a){idx=Application.UserColorStore.find("user",a);-1==idx?(c=Application.colors[Application.colorpointer],Application.UserColorStore.add(new Ext.data.Record({user:a,color:c})),Application.colorpointer++,12<Application.colorpointer&&(Application.colorpointer=0)):c=Application.UserColorStore.getAt(idx).get("color");return c};Ext.ns("Application");
Application.msgFormatter=new Ext.XTemplate('<p class="mymessage">',"<span ",'<tpl if="values.me == values.author">','class="author-me"',"</tpl>",'<tpl if="values.me != values.author">','class="{[this.getAuthorClass(values.jid)]}" style="color: #{[Application.getUserColor(values.author)]};"',"</tpl>",">(",'<tpl if="this.isNotToday(ts)">','{ts:date("d M")} ',"</tpl>",'{ts:date("g:i A")}) ','<tpl if="values.room != null">',"[{room}] ","</tpl>","{author}:</span> ","{message}</p>",{isNotToday:function(a){return(new Date).format("md")!=
a.format("md")},getAuthorClass:function(a){return null==a?"author-default":"nwsbot"==Strophe.getNodeFromJid(a)?"author-nwsbot":Strophe.getNodeFromJid(a).match(/^nws/)?"author-nws":"author-chatpartner"}});
Application.ChatGridPanel=Ext.extend(Ext.grid.GridPanel,{region:"center",soundOn:!0,nwsbotHide:!1,stripeRows:!0,autoExpandColumn:"message",autoScroll:!0,tbar:[{text:"Clear Room Log",cls:"x-btn-text-icon",icon:"icons/close.png",handler:function(a,b){a.ownerCt.ownerCt.getStore().removeAll()}},{text:"Print Log",icon:"icons/print.png",cls:"x-btn-text-icon",handler:function(a,b){a.ownerCt.ownerCt.getGridEl().print({isGrid:!0})}},{text:"View As HTML",handler:function(a,b){showHtmlVersion(a.ownerCt.ownerCt)},
icon:"icons/text.png",cls:"x-btn-text-icon"},{text:"Hide NWSBot",enableToggle:!0,toggleHandler:function(a,b){var d="muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::nwsbothidden",e=a.ownerCt.ownerCt.getStore();(a.ownerCt.ownerCt.nwsbotHide=b)?(Application.setPreference(d,"true"),e.filterBy(nwsbotFilter),a.setText("NWSBot Hidden")):(Application.removePreference(d),e.clearFilter(!1),a.setText("Hide NWSBot"))}},{text:"Mute Sounds",enableToggle:!0,toggleHandler:function(a,b){var d=
"muc::"+Strophe.getNodeFromJid(a.ownerCt.ownerCt.ownerCt.barejid)+"::mute";b?(Application.setPreference(d,"true"),a.ownerCt.ownerCt.soundOn=!1,a.setText("Sounds Muted")):(Application.removePreference(d),a.ownerCt.ownerCt.soundOn=!0,a.setText("Mute Sounds"))}},{icon:"icons/font-less.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))-2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message",
"font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}},{icon:"icons/font-more.png",handler:function(){var a=parseInt(Application.getPreference("font-size",14))+2;Application.setPreference("font-size",a);cssfmt=String.format("normal {0}px arial",a);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}}],initComponent:function(){this.columns=[{header:"Author",sortable:!0,dataIndex:"author",hidden:!0},{id:"message",
header:"Message",sortable:!0,dataIndex:"ts",scope:this,renderer:function(a,d,e){return Application.msgFormatter.apply({author:e.get("author"),message:e.get("message"),ts:e.get("ts"),room:e.get("room"),jid:e.get("jid"),me:this.ownerCt.handle})}}];this.store=new Ext.data.ArrayStore({sortInfo:{field:"ts",direction:"ASC"},fields:[{name:"ts",type:"date"},"author","message","product_id","jid","room",{name:"xdelay",type:"boolean"}]});this.store.on("add",function(a,d,e){if(!this.soundOn)return!0;a=!1;e=!0;
for(var g=0;g<d.length;g++)d[g].get("xdelay")||d[g].get("author")==this.ownerCt.handle||("nwsbot"!=d[g].get("author")&&(a=!0),d[g].get("message").match(/tornado/i)&&Application.MsgBus.fireEvent("soundevent","tornado"),d[g].get("message").match(this.ownerCt.handle)&&Application.MsgBus.fireEvent("soundevent","myhandle"),e=!1);if(e)return!0;a?(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent","new_message")):this.nwsbotHide||(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent",
"nwsbot"))},this);var a={viewConfig:{onAdd:function(a,d,e){this.constructor.prototype.onAdd.apply(this,arguments);(row=this.grid.getView().getRow(e))&&row.scrollIntoView()},templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}"  tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},sm:new Ext.grid.RowSelectionModel({listeners:{rowselect:function(a,d,e){e.data.product_id&&(Application.TextWindow.show(),
Application.TextWindow.load({params:{pid:e.data.product_id,bypass:1},text:"Loading...",method:"GET",url:"../p.php"}))}}}),listeners:{render:function(a){a.getView().mainBody.on("mousedown",function(a,b){"A"==b.tagName&&(a.stopEvent(),b.target="_blank")});a.body.on({mousedown:function(a,b){b.target="_blank";Application.TextWindow.hide()},click:function(a,b){"_blank"!=String(b.target).toLowerCase()&&(a.stopEvent(),window.open(b.href));Application.TextWindow.hide()},delegate:"a"})}}};Ext.apply(this,a);
Application.ChatGridPanel.superclass.initComponent.apply(this,arguments)}});Ext.reg("chatgridpanel",Application.ChatGridPanel);Ext.ns("Application");
Application.ChatTextEntry=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},border:!1,chatstate:null,initComponent:function(){this.items=[{xtype:"textarea",flex:1,cls:"message-entry-box",autoCreate:{tag:"textarea",style:'rows:10;cols:72;wrap:"hard";',autocomplete:"off"},style:{background:"#"+Application.getPreference("bgcolor","FFFFFF"),color:"#"+Application.getPreference("fgcolor","000000")},enableKeyEvents:!0,listeners:{keyup:function(a,b){if(b.getKey()===b.ENTER&&!b.shiftKey)return this.chatstate&&
this.chatstate.cancel(),this.chatstate=null,this.ownerCt.getComponent(1).handler(),!0;"chat"==this.ownerCt.ownerCt.chatType&&(this.chatstate||(this.chatstate=new Ext.util.DelayedTask(function(){this.ownerCt&&this.ownerCt.ownerCt&&(Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("paused",{xmlns:"http://jabber.org/protocol/chatstates"})),this.chatstate=null)},this),Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}))),this.chatstate.delay(5E3))},render:{delay:500,fn:function(){this.focus()}}}},{xtype:"button",text:"Send",width:60,popup:null,handler:function(){var a=this.ownerCt.getComponent(0),b=a.getValue().trim();if(0===b.length)return a.focus(),!1;var d=Application.getPreference("bgcolor","FFFFFF"),e=Application.getPreference("fgcolor","000000");if("allchats"==this.ownerCt.ownerCt.chatType)a.emptyText="",a.setValue(""),(new Application.AllChatMessageWindow({message:Application.replaceURLWithHTMLLinks(b)})).show();
else{for(var g=$.parseHTML(Application.replaceURLWithHTMLLinks(b)),f=$msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("active",{xmlns:"http://jabber.org/protocol/chatstates"}).up().c("body").t(b).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+e+";background:#"+d+";"}),h=0;h<g.length;h++)f=f.cnode(g[h]),h<g.length&&(f=f.up());Application.XMPPConn.send(f);a.setValue("");a.focus();
"chat"==this.ownerCt.ownerCt.chatType&&(b="<span style='color:#"+e+";background:#"+d+";'>"+b+"</span>",this.ownerCt.ownerCt.gp.getStore().addSorted(new Ext.data.Record({ts:new Date,author:Application.USERNAME,message:Application.replaceURLWithHTMLLinks(b)})))}}}];Application.ChatTextEntry.superclass.initComponent.apply(this,arguments)}});Ext.reg("chattextentry",Application.ChatTextEntry);Ext.ns("Application");
Application.ChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",iconCls:"tabno",chatType:"chat",barejid:null,handle:null,anonymous:null,initComponent:function(){this.items=[new Application.ChatGridPanel({region:"center"}),new Application.ChatTextEntry({region:"south",height:50,split:!0})];Ext.apply(this,Ext.apply(this.initialConfig,{listeners:{activate:function(a){a.setIconCls("tabno")},deactivate:function(a){a.setIconCls("tabno")},beforedestroy:function(a){a.te.chatstate&&a.te.chatstate.cancel();
Application.XMPPConn.send($msg({to:a.barejid,type:a.chatType}).c("gone",{xmlns:"http://jabber.org/protocol/chatstates"}))}}}));Application.ChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},getJidByHandle:function(a){return this.barejid},buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3]);this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3])}});
Ext.reg("chatpanel",Application.ChatPanel);Ext.ns("Application");
Application.LiveViewport=Ext.extend(Ext.Viewport,{initComponent:function(){var a={xtype:"panel",region:"north",height:10,hidden:!0,title:"Map Disabled by URL"};this.initialConfig.enableMap&&(a={xtype:"panel",layout:"border",region:"north",collapsible:!0,title:"Map Panel",height:300,split:!0,items:[Application.MapPanel,Application.LayerTree]});this.items=[Application.Control,{xtype:"panel",region:"center",layout:"border",items:[a,new Application.ChatTabPanel({id:"chatpanel",region:"center",split:!0})]}];
Ext.apply(this,Ext.apply(this.initialConfig,{layout:"border"}));Application.LiveViewport.superclass.initComponent.call(this);this.doStuff()},doStuff:function(){var a=Ext.getCmp("map");a&&(a.map.events.register("changelayer",null,function(a){a={lstring:""};Application.layerstore.data.each(function(a){a=a.getLayer();a.getVisibility()&&(this.lstring+="||"+a.name)},a);Application.setPreference("layers",a.lstring)}),Ext.TaskMgr.start(Application.MapTask),a=new OpenLayers.Control.SelectFeature([lsrs,sbws]),
Ext.getCmp("map").map.addControl(a),a.activate());new Application.DebugWindow({id:"debug",renderTo:Ext.getBody()});(new Ext.Window({id:"loginwindow",modal:!0,closable:!1,title:"NWSChat Live Login Options",items:[new Application.TabLoginPanel]})).show()}});Ext.ns("Application");Application.MapLegend=Ext.extend(Ext.Window,{width:300,height:200,autoScroll:!0,title:"Map Legends",hidden:!0,autoScroll:!0,closeAction:"hide",initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.MapLegend.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){}});Ext.ns("Ext.ux.grid");Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(a,b,d,e,g){if("mousedown"==a){var f=d.store.getAt(e);f.set(this.dataIndex,!f.data[this.dataIndex]);return!1}return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments)},renderer:function(a,b,d){b.css+=" x-grid3-check-col-td";return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',a?"-on":"")},init:Ext.emptyFn});Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn);
Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function a(){var a=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(a);this.dataTip.initTarget(a)}function b(a,b){a.rendered?a.update(b):Ext.isString(b)?a.html=b:a.data=b}function d(a){var d=Ext.fly(a.triggerElement).findParent("div.x-tree-node-el",null,!0);if(d=d?a.host.getNodeById(d.getAttribute("tree-node-id","ext")):null)b(a,d.attributes);else return!1}function e(a){var d=this.host.getStore().getAt(this.host.getView().findRowIndex(a.triggerElement));
if(d)b(a,d.data);else return!1}function g(a){var d=this.host.getRecord(a.triggerElement);if(d)b(a,d.data);else return!1}function f(a){var d=Ext.fly(a.triggerElement).child("input,textarea");if((d=d?this.host.getForm().findField(d.id):null)&&(d.tooltip||a.tpl))b(a,d.tooltip||d);else return!1}function h(a){var d=this.host.store.getAt(this.host.selectedIndex);if(d)b(a,d.data);else return!1}return{init:function(b){b.dataTip=this;this.host=b;b instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||
"div.x-tree-node-el",this.on("beforeshow",d)):b instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||b.getView().rowSelector,this.on("beforeshow",e)):b instanceof Ext.DataView?(this.delegate=this.delegate||b.itemSelector,this.on("beforeshow",g)):b instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",f)):b instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||b.itemSelector,this.on("beforeshow",h));b.rendered?a.call(b):b.onRender=b.onRender.createSequence(a)}}}());Ext.ns("Application");
function onBuddyPresence(a){var b=a.getAttribute("from"),d=Strophe.getBareJidFromJid(b),e=Strophe.getResourceFromJid(b),g=Strophe.getNodeFromJid(b),f="Available";g==Application.USERNAME&&e!=Application.XMPPRESOURCE&&e.match(/^NWSChatLive/)&&("unavailable"==a.getAttribute("type")?Application.log("Self presence: ["+g+"] ["+e+"] unavailable"):Application.log("Self presence: ["+g+"] ["+e+"] available"));0<$(a).find("status").length&&(f=$(a).find("status").text());"subscribe"==a.getAttribute("type")?Ext.Msg.show({title:"New Buddy Request",
msg:"User "+g+" wishes to add you as a buddy. Is this okay?",buttons:Ext.Msg.YESNO,fn:function(a){"yes"==a?(a=$pres({to:b,type:"subscribed"}),Application.XMPPConn.send(a.tree()),Application.buildAddBuddy(g,g,"Buddies")):(a=$pres({to:b,type:"unsubscribed"}),Application.XMPPConn.send(a.tree()))},icon:Ext.MessageBox.QUESTION}):Ext.getCmp("buddies").root.eachChild(function(b){b.eachChild(function(b){b.attributes.barejid==d&&(((res=b.attributes.resources.get(e))||b.attributes.resources.add(e,{status:f,
resource:e}),a.getAttribute("type"))?"unavailable"==a.getAttribute("type")&&(1==b.attributes.resources.length&&(b.attributes.presence="offline",b.setIconCls("buddy-offline"),b.ui.hide()),b.attributes.resources.remove(e)):(0<$(a).find("show").length?b.setIconCls("buddy-away"):b.setIconCls("buddy-online"),b.attributes.presence="online",b.ui.show(),b.attributes.resources.replace(e,{status:f,resource:e})))})})};Ext.ns("Application");
Application.AllChatMessageWindow=Ext.extend(Ext.Window,{title:"Where to send this message?",width:460,height:300,modal:!0,layout:"form",layoutConfig:{},defaults:{width:450},initComponent:function(){this.buttons=[{text:"Send Message",scope:this,handler:function(){var a=this.find("name","columns")[0];Ext.each(a.findByType("checkbox"),function(a){a.checked&&Application.XMPPConn.send($msg({to:a.name+"@"+Application.XMPPMUCHOST,type:"groupchat"}).c("body").t(this.message).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",
{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+Application.getPreference("fgcolor","000000")+";background:#"+Application.getPreference("bgcolor","FFFFFF")+";"}).t(this.message))},this);this.close()}},{text:"Cancel",handler:function(){this.ownerCt.ownerCt.close()}}];Application.AllChatMessageWindow.superclass.initComponent.apply(this,arguments);this.buildItems(this.message);this.addAvailableRooms()},addAvailableRooms:function(){Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==
a.chatType&&!a.anonymous&&(a=Strophe.getNodeFromJid(a.barejid),0==this.items.items[1].find("name",a).length)){var b=this.find("name","columns")[0];pos=b.entries%3;b.items.items[pos].add({xtype:"checkbox",hideLabel:!0,boxLabel:a,name:a});b.entries+=1}},this)},buildItems:function(a){this.add({xtype:"textarea",hideLabel:!0,html:a});this.add({xtype:"fieldset",title:"Send my message to the following room(s):",autoHeight:!0,autoScroll:!0,items:[{entries:0,name:"columns",layout:"table",items:[{layout:"form",
border:!1,colname:"col1",width:140,items:[]},{layout:"form",border:!1,colname:"col2",width:140,items:[]},{width:140,border:!1,colname:"col3",layout:"form",items:[]}]}]})}});/*
 Licensed under the terms of the Open Source <a href="http://www.gnu.org/licenses/lgpl.html">LGPL 3.0 license</a>. Commercial use is permitted to the extent that the code/component(s) do NOT become part of another Open Source or Commercially licensed development library or toolkit without explicit permission.
 @version 2.0.0 (Feb 14, 2010)
*/
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel=Ext.extend(Ext.TabPanel,{arrowOffsetX:-9,arrowOffsetY:-8,initComponent:function(){Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);this.addEvents("reorder");this.ddGroupId||(this.ddGroupId="dd-tabpanel-group-"+Ext.ux.panel.DDTabPanel.superclass.getId.call(this))},reorder:function(a){this.fireEvent("reorder",this,a)},afterRender:function(){Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);this.arrow=Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>',
!0);this.arrow.hide();this.dd=new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup:this.ddGroupId});this.move=!1},initTab:function(a,b){Ext.ux.panel.DDTabPanel.superclass.initTab.call(this,a,b);var d=this.id+"__"+a.id;Ext.fly(d).on("click",function(){a.ownerCt.setActiveTab(a.id)});Ext.applyIf(a,{allowDrag:!0});Ext.apply(a,{ds:new Ext.dd.DragSource(d,{ddGroup:this.ddGroupId,dropEl:a,dropElHeader:Ext.get(d,!0),scroll:!1,onStartDrag:function(){if(this.dropEl.iconCls){var a=this.getProxy().getGhost().select(".x-tab-strip-text");
a.addClass("x-panel-inline-icon");var b=a.elements[0].innerHTML,b=Ext.util.Format.stripTags(b);a.elements[0].innerHTML=b;a.applyStyles({paddingLeft:"20px"})}},onMouseUp:function(a){this.dropEl.ownerCt.move?(this.dropEl.disabled||null!=this.dropEl.ownerCt.activeTab||this.dropEl.ownerCt.setActiveTab(this.dropEl),this.dropEl.ownerCt.move=!1):this.dropEl.isVisible()||this.dropEl.disabled||this.dropEl.show()}}),enableTabDrag:function(){this.allowDrag=!0;return this.ds.unlock()},disableTabDrag:function(){this.allowDrag=
!1;return this.ds.lock()}});a.allowDrag?a.enableTabDrag():a.disableTabDrag()},onRemove:function(a){var b=Ext.get(a.tabEl);b&&(b.select("a").removeAllListeners(),Ext.destroy(b));Ext.TabPanel.superclass.onRemove.call(this,a);this.stack.remove(a);delete a.tabEl;a.un("disable",this.onItemDisabled,this);a.un("enable",this.onItemEnabled,this);a.un("titlechange",this.onItemTitleChanged,this);a.un("iconchange",this.onItemIconChanged,this);a.un("beforeshow",this.onBeforeShowItem,this);a==this.activeTab&&(this.move?
this.activeTab=null:(a=this.stack.next())?this.setActiveTab(a):0<this.items.getCount()?this.setActiveTab(0):this.activeTab=null);this.destroying||this.delegateUpdates()},onDestroy:function(){Ext.destroy(this.dd,this.arrow);Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)}});
Ext.ux.panel.DDTabPanel.DropTarget=Ext.extend(Ext.dd.DropTarget,{constructor:function(a,b){this.tabpanel=a;Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(this,a.stripWrap,b)},notifyOver:function(a,b,d){var e=this.tabpanel.items,g=e.length;if(!b.within(this.getEl())||a.dropEl==this.tabpanel)return"x-dd-drop-nodrop";d=this.tabpanel.arrow;var f=this.el.getY(),h,q,s;b=b.getPageX();for(var m=0;m<g;m++){q=s;s=e.itemAt(m);var n=s.ds.dropElHeader,l=n.getX();if(b<=l+n.dom.clientWidth/2){h=
l;break}}if("undefined"==typeof h){h=e.itemAt(g-1);if(h==a.dropEl)return"x-dd-drop-nodrop";a=h.ds.dropElHeader.dom;h=(new Ext.Element(a)).getX()+a.clientWidth+3}else if(s==a.dropEl||q==a.dropEl)return this.tabpanel.arrow.hide(),"x-dd-drop-nodrop";d.setTop(f+this.tabpanel.arrowOffsetY).setLeft(h+this.tabpanel.arrowOffsetX).show();return"x-dd-drop-ok"},notifyDrop:function(a,b,d){this.tabpanel.arrow.hide();if(a.dropEl==this.tabpanel)return!1;d=this.tabpanel.items;var e=b.getPageX();for(b=0;b<d.length;b++){var g=
d.itemAt(b),f=g.ds.dropElHeader,f=f.getX()+f.dom.clientWidth/2;if(e<=f)break}if(g==a.dropEl||d.itemAt(b-1)==a.dropEl)return!1;a.proxy.hide();a.dropEl.ownerCt==this.tabpanel&&b>d.indexOf(a.dropEl)&&b--;this.tabpanel.move=!0;a=a.dropEl.ownerCt.remove(a.dropEl,!1);this.tabpanel.insert(b,a);this.tabpanel.fireEvent("drop",this.tabpanel);this.tabpanel.reorder(d.itemAt(b));return!0},notifyOut:function(a,b,d){this.tabpanel.arrow.hide()}});Ext.reg("ddtabpanel",Ext.ux.panel.DDTabPanel);Ext.ns("Application");
Application.ChatTabPanel=Ext.extend(Ext.ux.panel.DDTabPanel,{activeTab:0,deferredRender:!1,split:!0,enableTabScroll:!0,initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.ChatTabPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){this.add({contentEl:"help",title:"Help",preventBodyReset:!0,style:{margin:"5px"},autoScroll:!0});this.add(new Application.MUCChatPanel({title:"All Chats",closable:!1,chatType:"allchats",barejid:"__allchats__@"+
Application.XMPPMUCHOST,id:"__allchats__"}))},addMUC:function(a,b,d){a=new Application.MUCChatPanel({title:Strophe.getNodeFromJid(a),barejid:a,handle:b,anonymous:d});return this.add(a)},getMUC:function(a){return this.find("barejid",a)[0]},removeMUC:function(a){this.remove(this.getMUC(a))},addChat:function(a){var b=Strophe.getNodeFromJid(a);Strophe.getDomainFromJid(a)==Application.XMPPMUCHOST&&(b=Strophe.getResourceFromJid(a));a=new Application.ChatPanel({title:b,handle:Application.USERNAME,barejid:a});
return this.add(a)},getChat:function(a){return this.find("barejid",a)[0]},removeChat:function(a){this.remove(this.getChat(a))}});Ext.reg("chattabpanel",Application.ChatTabPanel);Ext.ns("Application");function nwsbotFilter(a,b){return"nwsbot"==a.get("author")?!1:!0}
function grid2html(a){var b=a.getStore();a=a.ownerCt.title;t="<html><head></head><body>";t+="<table cellpadding='2' cellspacing='0' border='1'><tr><th>Roomname</th><th>Date</th><th>Author</th><th>Message</th></tr>";for(var d=0;d<b.getCount();d++)row=b.getAt(d),t+=String.format("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>\r\n",row.get("roomname")||a,row.get("ts").format("Y/m/d g:i A"),row.get("author"),row.get("message"));return t+="</table></body></html>"}
function htmlExport(a){Ext.isIE6||Ext.isIE7||Ext.isSafari||Ext.isSafari2||Ext.isSafari3?Ext.Msg.alert("Status","Sorry, this tool does not work with this browser."):(t=grid2html(a),document.location="data:plain/html;base64,"+encode64(t))}function showHtmlVersion(a){(new Ext.Window({title:"Text Version",closable:!0,width:600,height:350,plain:!0,autoScroll:!0,html:grid2html(a)})).show()}
var LinkInterceptor={render:function(a){a.body.on({mousedown:function(a,d){d.target="_blank";Application.TextWindow.hide()},click:function(a,d){"_blank"!=String(d.target).toLowerCase()&&(a.stopEvent(),window.open(d.href));Application.TextWindow.hide()},delegate:"a"})}};Ext.ns("Application");Application.saveViews=function(){for(var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}),b=1;6>b;b++)(bnds=Ext.getCmp("mfv"+b).bounds)&&a.c("view",{label:Ext.getCmp("mfv"+b).getValue(),bounds:bnds.left+","+bnds.bottom+","+bnds.right+","+bnds.top}).up();Application.XMPPConn.sendIQ(a.tree())};Ext.util.Format.comboRenderer=function(a){return function(b){return(b=a.findRecord(a.valueField,b))?b.get(a.displayField):a.valueNotFoundText}};
Application.SoundStore=new Ext.data.ArrayStore({fields:["id","label","src"],data:[["default","Default","sounds/message_new.mp3"],["bleep","Bleep","sounds/bleep.mp3"],["cow","Cow (Mooo!)","sounds/cow.mp3"],["doorbell","Door Bell","sounds/doorbell.mp3"],["eas","EAS Beep","sounds/eas.mp3"],["elevator","Elevator","sounds/elevator.mp3"]]});
var combo=new Ext.form.ComboBox({typeAhead:!1,triggerAction:"all",lazyRender:!0,mode:"local",store:Application.SoundStore,listeners:{change:function(a,b,d){Application.playSound(b)}},valueField:"id",displayField:"label"});
Application.soundPrefs=new Ext.Window({title:"Sound Preferences",width:500,height:300,closeAction:"hide",layout:"form",buttons:[{text:"Save Sound Settings",handler:function(){Ext.getCmp("soundpanel").getStore().each(function(a){eidx=a.get("id");Application.setPreference("sound::"+eidx+"::enabled",a.get("enabled")?"true":"false");Application.setPreference("sound::"+eidx+"::sound",a.get("sound"))});Application.soundPrefs.hide();Application.syncPreferences()}}],items:[{xtype:"slider",id:"volume",minValue:0,
maxValue:100,value:50,width:200,listeners:{changecomplete:function(a,b,d){Application.setPreference("volume",b);Application.MsgBus.fireEvent("soundevent","default")}},fieldLabel:"Volume"},new Ext.grid.EditorGridPanel({store:new Ext.data.ArrayStore({data:[["new_message","New Message (Non NWSBot)",!0,"default"],["new_conversation","New Conversation",!0,"doorbell"],["nwsbot","NWSBot Message",!0,"default"],["myhandle","Message with your name in it",!0,"bleep"],["tornado",'Message with "Tornado" within text',
!0,"eas"]],fields:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"enabled",type:"bool"},{name:"sound",type:"string"}],sortInfo:{field:"label",direction:"ASC"}}),cm:new Ext.grid.ColumnModel({columns:[{dataIndex:"enabled",id:"enabled",header:"Enable",xtype:"checkcolumn"},{dataIndex:"label",id:"label",sortable:!0,header:"Event Type"},{dataIndex:"sound",id:"sound",header:"Sound",renderer:Ext.util.Format.comboRenderer(combo),editor:combo}]}),id:"soundpanel",title:"Sound Events",frame:!0,
clicksToEdit:1,stripeRows:!0,autoExpandColumn:"label",height:200,autoScroll:!0})]});
Application.boundsFavorites=new Ext.Window({title:"Map View Favorites",width:500,height:300,closeAction:"hide",layout:"table",layoutConfig:{columns:4},autoScroll:!0,buttons:[{text:"Save Settings",handler:function(){for(var a=1;6>a;a++)nval=Ext.getCmp("mfv"+a).getValue(),""!=nval&&Ext.getCmp("fm"+a).setText(nval);Application.boundsFavorites.hide()}}],items:[{html:"This form allows you to modify the 5 allowed map extent favorites. The first favorite will be your default view when you log in and for the star icon above.",colspan:4},
{html:"#1"},{xtype:"textfield",id:"mfv1",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv1").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv1").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#2"},{xtype:"textfield",id:"mfv2",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv2").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv2").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#3"},{xtype:"textfield",id:"mfv3",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv3").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv3").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,
!0)}},{html:"#4"},{xtype:"textfield",id:"mfv4",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv4").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv4").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#5"},{xtype:"textfield",id:"mfv5",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(a,b){Ext.getCmp("mfv5").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(a,b){(bnds=Ext.getCmp("mfv5").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}}]});
mucform=new Ext.form.FormPanel({labelWidth:200,padding:5,items:[{xtype:"textfield",allowBlank:!1,name:"roomname",fieldLabel:"Room Name"},{xtype:"textfield",allowBlank:!1,name:"roomhandle",value:Application.USERNAME,fieldLabel:"Chat Handle"},{xtype:"checkbox",name:"bookmark",fieldLabel:"Save Bookmark for Chatroom?",handler:function(a,b){b?mucform.getForm().findField("roomalias").enable():mucform.getForm().findField("roomalias").disable()}},{xtype:"textfield",name:"roomalias",fieldLabel:"Bookmark Alias (optional)",
disabled:!0},{xtype:"checkbox",name:"anonymous",fieldLabel:"Anonymously Monitor (read-only)"},{xtype:"checkbox",name:"autojoin",fieldLabel:"Auto Join Room after Login"}],listeners:{render:function(){mucform.getForm().findField("roomhandle").getValue()||mucform.getForm().findField("roomhandle").setValue(Application.USERNAME)}}});var privform=new Ext.form.FormPanel({labelWidth:100,padding:5,items:[{xtype:"textfield",fieldLabel:"User Name",emptyText:"media-joe.blow",name:"username"}]});
Application.CreatePrivateChat=new Ext.Window({width:400,title:"Chat with User",items:[privform],buttons:[{xtype:"button",text:"Start Chat",scope:privform,handler:function(){var a=this.getForm().findField("username").getValue();-1==a.indexOf("@")&&(a=a+"@"+Application.XMPPHOST);Application.CreatePrivateChat.hide();(cp=Ext.getCmp("chatpanel").getChat(a))||(cp=Ext.getCmp("chatpanel").addChat(a));Ext.getCmp("chatpanel").setActiveTab(cp)}},{xtype:"button",text:"Cancel",handler:function(){Application.CreatePrivateChat.hide()}}]});
Application.JoinChatroomDialog=new Ext.Window({width:400,title:"Join a Group Chat",items:[mucform],buttons:[{xtype:"button",text:"Join Room",scope:mucform,handler:function(){roomname=this.getForm().findField("roomname").getValue();room=roomname+"@conference."+Application.XMPPHOST;handle=this.getForm().findField("roomhandle").getValue();ibook=this.getForm().findField("bookmark").getValue();anonymous=this.getForm().findField("anonymous").getValue();autojoin=this.getForm().findField("autojoin").getValue();
ibook&&(alias=this.getForm().findField("roomalias").getValue(),""==alias&&(alias=roomname),Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+roomname+")",jid:room,alias:alias,anonymous:anonymous,autojoin:autojoin,icon:"icons/chat.png",handle:handle,leaf:!0}));Application.MsgBus.fireEvent("joinchat",room,handle,anonymous);Application.JoinChatroomDialog.hide()}},{xtype:"button",text:"Cancel",handler:function(){Application.JoinChatroomDialog.hide()}}]});Application.msgtpl=new Ext.XTemplate('<p>{date:date("g:i:s A")} :: {msg}</p>');
Application.TextWindow=new Ext.Window({width:550,height:300,title:"Product Text",closeAction:"hide",constrain:!0,hidden:!0,autoScroll:!0,html:"Loading...."});Application.log=function(a){Ext.getCmp("debug").addMessage(a)};Ext.ns("Application");function saveBookmarks(){var a=Ext.getCmp("bookmarks").root,b=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"});a.eachChild(function(a){this.c("conference",{name:a.attributes.alias,anonymous:a.attributes.anonymous?"true":"false",autojoin:a.attributes.autojoin?"true":"false",jid:a.attributes.jid}).c("nick",a.attributes.handle).up().up()},b);Application.XMPPConn.sendIQ(b.tree())}
function onPresenceCheck(a,b){"available"==a.xmpp?Application.XMPPConn.send($pres()):Application.XMPPConn.send($pres().c("show","away").up().c("status",a.xmpp));Ext.getCmp("presenceUI").setText(a.text)}
Application.Control={region:"west",title:"NWSChat Live",collapsible:!0,width:200,split:!0,layout:"accordion",layoutConfig:{autoWidth:!1},autoScroll:!0,tbar:[{text:"Actions",menu:[{checked:!1,text:"Show Offline Buddies",checkHandler:function(a,b){Ext.getCmp("buddies").root.cascade(function(a){b?a.ui.show():"offline"==a.attributes.presence&&a.ui.hide()})}},{xtype:"menuitem",text:"Chat with User",handler:function(){Application.CreatePrivateChat.show()}},{xtype:"menuitem",text:"Add Buddy...",handler:function(){Application.buildAddBuddy(null,
null,null)}},{xtype:"menuitem",text:"Join Group Chat",handler:function(){Application.JoinChatroomDialog.show()}},{text:"Msg Text Color",menu:{items:[new Ext.ColorPalette({id:"fgcolor",value:"000000",listeners:{select:function(a,b){Application.setPreference("fgcolor",b)}}})]}},{text:"Msg Background Color",menu:{items:[new Ext.ColorPalette({id:"bgcolor",value:"FFFFFF",listeners:{select:function(a,b){Application.setPreference("bgcolor",b)}}})]}},{xtype:"menuitem",text:"Show Debug Window",handler:function(){Ext.getCmp("debug").show()}},
{xtype:"menuitem",text:"Log Out",handler:function(){Application.log("Manual logout requested.");Application.RECONNECT=!1;Application.XMPPConn.disconnect()}}]},{xtype:"tbseparator"},{text:"Available",id:"presenceUI",menu:{items:[{text:"Available",xmpp:"available",checked:!0,group:"presence",checkHandler:onPresenceCheck},{text:"Be Right Back",xmpp:"Be Right Back",checked:!1,group:"presence",checkHandler:onPresenceCheck},{text:"Away",xmpp:"away",checked:!1,group:"presence",checkHandler:onPresenceCheck}]}},
{xtype:"splitbutton",id:"sound",scale:"medium",soundOn:!0,handler:function(a){a.soundOn?(a.setIcon("icons/mute.png"),soundManager.muteAll(),a.soundOn=!1):(a.setIcon("icons/volume.png"),soundManager.unmuteAll(),a.soundOn=!0,Application.MsgBus.fireEvent("soundevent","default"))},arrowHandler:function(){Application.soundPrefs.show()},icon:"icons/volume.png"}],items:[{flex:1,xtype:"treepanel",id:"buddies",title:"Buddies",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,plugins:new Ext.ux.DataTip({tpl:new Ext.XTemplate('<tpl if="typeof(resources) !== &quot;undefined&quot;">',
"<div>",'<tpl for="resources.items">',"<p><b>Resource:</b> {resource} <b>Status:</b> {status}</p>","</tpl>","</div>","</tpl>")}),listeners:{click:function(a){(cp=Ext.getCmp("chatpanel").getChat(a.attributes.barejid))||(cp=Ext.getCmp("chatpanel").addChat(a.attributes.barejid));Ext.getCmp("chatpanel").setActiveTab(cp)}},root:new Ext.tree.TreeNode},{flex:1,xtype:"treepanel",id:"bookmarks",title:"Chatroom Bookmarks",collapsed:!1,rootVisible:!1,enableDD:!0,lines:!1,containerScroll:!0,autoScroll:!0,plugins:new Ext.ux.DataTip({tpl:"<div>Anonymous: {anonymous}<br />Autojoin: {autojoin}</div>"}),
contextMenu:new Ext.menu.Menu({items:[{id:"delete-node",icon:"icons/close.png",text:"Delete Bookmark"}],listeners:{itemclick:function(a){var b=a.parentMenu.contextNode;switch(a.id){case "delete-node":b.parentNode&&(b.remove(),saveBookmarks())}}}}),listeners:{contextmenu:function(a,b){a.select();var d=a.getOwnerTree().contextMenu;d.contextNode=a;d.showAt(b.getXY())},movenode:function(a,b,d,e,g){saveBookmarks()},click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();
form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(a.attributes.handle);form.findField("bookmark").enable();form.findField("anonymous").setValue(a.attributes.anonymous);form.findField("autojoin").setValue(a.attributes.autojoin);form.findField("roomalias").setValue(a.attributes.alias)})}},root:new Ext.tree.TreeNode({initialLoad:!1,listeners:{beforeappend:function(a,b,d,e){if(a=b.findChild("jid",d.attributes.jid))Application.log("Replacing MUC bookmark: "+
d.attributes.jid),b.removeChild(a,!0);return!0},append:function(a,b,d,e){b.initialLoad&&saveBookmarks()}}})},{flex:2,xtype:"treepanel",id:"chatrooms",title:"Chatrooms",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,listeners:{click:function(a){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();form.findField("roomname").setValue(Strophe.getNodeFromJid(a.attributes.jid));form.findField("roomhandle").setValue(Application.USERNAME);form.findField("bookmark").enable();
form.findField("anonymous").setValue(!1);form.findField("autojoin").setValue(!1);form.findField("roomalias").setValue(Strophe.getNodeFromJid(a.attributes.jid))})}},root:new Ext.tree.TreeNode}]};
Application.doLogin=function(){Application.RECONNECT=!0;Application.ATTEMPTS+=1;11<Application.ATTEMPTS?Application.log("Application Login Limit Reached!"):(username=Ext.getCmp("username").getValue(),0<username.indexOf("@")&&(username=Strophe.getNodeFromJid(username)),username=username.toLowerCase(),username=username.replace(/^\s+|\s+$/g,""),password=Ext.getCmp("password").getValue(),""==username?Application.log("Invalid Username"):""==password?Application.log("Invalid Password"):(Application.USERNAME=
username,Application.login(username,password)))};Ext.ns("Application");Application.ServiceGuard={skipFirst:!0,run:function(){this.skipFirst?this.skipFirst=!1:Application.XMPPConn&&Application.XMPPConn.authenticated&&0!=Application.XMPPConn.errors&&Application.log("Strophe error counter is non-zero: "+Application.XMPPConn.errors)},interval:12E4};function UTCStringToDate(a,b){var d=Date.parseDate(a,b);return void 0==d?"":d.fromUTC()}
function buildXMPP(){Application.log("Initializing XMPPConn Obj");Application.XMPPConn=new Strophe.Connection(Application.BOSH);Application.XMPPConn.disco.addFeature("http://jabber.org/protocol/chatstates");Application.DEBUGMODE&&(Application.XMPPConn.rawInput=rawInput,Application.XMPPConn.rawOutput=rawOutput)}
Application.login=function(a,b){jid=a+"@"+Application.XMPPHOST+"/"+Application.XMPPRESOURCE;"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(jid,b,onConnect,60,1,Application.ROUTE)};Application.doAnonymousLogin=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(Application.XMPPHOST,null,onConnect)};
Application.register=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.register.connect(Application.XMPPHOST,function(a){a===Strophe.Status.REGISTER?(Application.log("Strophe.Status.REGISTER"),Application.XMPPConn.register.fields.username=Ext.get("reguser").getValue(),Application.XMPPConn.register.fields.password=Ext.get("regpass").getValue(),Application.XMPPConn.register.fields.email=Ext.get("regemail").getValue(),Application.XMPPConn.register.submit()):a===Strophe.Status.REGISTERED?
(Ext.getCmp("loginpanel").addMessage("Username "+Application.XMPPConn.register.fields.username+" registered with server ..."),Ext.getCmp("loginwindow").items.items[0].activate(0),Ext.getCmp("username").setValue(Application.XMPPConn.register.fields.username),Ext.getCmp("password").setValue(Application.XMPPConn.register.fields.password),Application.XMPPConn.disconnect(),Application.doLogin()):a===Strophe.Status.CONFLICT?Application.log("Contact already existed!"):a===Strophe.Status.NOTACCEPTABLE?Application.log("Registration form not properly filled out."):
a===Strophe.Status.REGIFAIL?Application.log("The Server does not support In-Band Registration"):a===Strophe.Status.CONNECTED?Application.log("connected?"):Application.log(a)})};
function onConnect(a){if(a==Strophe.Status.CONNECTING)Application.log("Strophe.Status.CONNECTING...");else if(a==Strophe.Status.ERROR)Application.log("Strophe.Status.ERROR...");else if(a==Strophe.Status.AUTHFAIL)Application.log("Strophe.Status.AUTHFAIL..."),Application.RECONNECT=!1,Ext.getCmp("loginpanel").addMessage("Authentication failed, please check username and password..."),Application.XMPPConn.disconnect();else if(a==Strophe.Status.CONNFAIL)Application.log("Strophe.Status.CONNFAIL...");else if(a==
Strophe.Status.DISCONNECTED)Application.log("Strophe.Status.DISCONNECTED..."),Application.MsgBus.fireEvent("loggingout"),Application.RECONNECT?(Application.log("Relogging in after 3 seconds delay"),Application.doLogin.defer(3E3,this)):Application.MsgBus.fireEvent("loggedout");else if(a==Strophe.Status.AUTHENTICATING)Application.log("Strophe.Status.AUTHENTICATING...");else if(a==Strophe.Status.DISCONNECTING)Application.log("Strophe.Status.DISCONNECTING..."),Application.XMPPConn.flush();else if(a==
Strophe.Status.ATTACHED)Application.log("Strophe.Status.ATTACHED...");else if(a==Strophe.Status.CONNECTED){Application.log("Strophe.Status.CONNECTED...");Application.RECONNECT=!0;Application.XMPPConn.addHandler(onMessage,null,"message",null,null,null);Application.XMPPConn.addHandler(onPresence,null,"presence",null,null,null);Application.XMPPConn.addHandler(onRoster,Strophe.NS.ROSTER,"iq",null,null,null);Application.XMPPConn.addHandler(onIQ,null,"iq",null,null,null);Application.XMPPConn.send($iq({type:"get"}).c("query",
{xmlns:Strophe.NS.ROSTER}).tree());var b=0;Ext.getCmp("chatpanel").items.each(function(a){if("groupchat"==a.chatType){Application.log("Attempting to rejoin MUC: "+a.barejid);var e=$pres({to:a.barejid+"/"+a.handle});a.anonymous&&e.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");(function(){Application.XMPPConn.send(this.p)}).defer(5E3*b,{p:e});b+=1}});a=$iq({type:"get",id:"_get3"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"}).tree();
Application.XMPPConn.sendIQ(a,parsePrefs);a=$iq({type:"get",id:"_get2"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}).tree();Application.XMPPConn.sendIQ(a,parseViews);Application.MsgBus.fireEvent("loggedin")}}
function updateMap(){var a=Application.getPreference("layers");if(null!=a)for(var a=a.split("||"),b=0;b<a.length;b++)""!=a[b]&&(idx=Application.layerstore.find("title",a[b]),-1!=idx&&(Application.log("Setting Layer "+a[b]+" visable"),layer=Application.layerstore.getAt(idx).getLayer(),layer.setVisibility(!0)))}
function setSounds(){Application.prefStore.each(function(a){key=a.get("key");"volume"==key?Ext.getCmp("volume").setValue(a.get("value")):0==key.indexOf("sound::")&&(tokens=key.split("::"),3==tokens.length&&(sidx=tokens[1],opt=tokens[2],store=Ext.getCmp("soundpanel").getStore(),idx=store.find("id",sidx),-1<idx&&(lrecord=store.getAt(idx),val=a.get("value"),"true"==val&&(val=!0),"false"==val&&(val=!1),lrecord.set(opt,val))))})}
function parsePrefs(a){Application.prefStore.removeAll();a=$(a).find("pref");for(var b=0;b<a.length;b++)key=a[b].getAttribute("key"),value=a[b].getAttribute("value"),Application.setPreference(key,value);Application.prefStore.locked=!0;setSounds();try{var d=parseInt(Application.getPreference("font-size",14))+2;cssfmt=String.format("normal {0}px arial",d);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt);updateMap();Application.updateColors()}catch(e){}Application.prefStore.locked=
!1}function parseViews(a){if(Ext.getCmp("map"))for(elem=$(a).find("view"),a=0;a<elem.length;a++)label=elem[a].getAttribute("label"),bounds=elem[a].getAttribute("bounds"),""!=label&&(Ext.getCmp("mfv"+(a+1)).setValue(label),Ext.getCmp("fm"+(a+1)).setText(label)),Ext.getCmp("mfv"+(a+1)).bounds=OpenLayers.Bounds.fromArray(bounds.split(",")),0==a&&Ext.getCmp("map").map.zoomToExtent(OpenLayers.Bounds.fromArray(bounds.split(",")),!0)}
function parseBookmarks(a){elem=$(a).find("conference");for(var b=a=0;b<elem.length;b++){alias=elem[b].getAttribute("name");jid=elem[b].getAttribute("jid");nick=$(elem[b]).find("nick").text();if(null==nick||""==nick)nick=Application.USERNAME;anonymous="true"==elem[b].getAttribute("anonymous");autojoin="true"==elem[b].getAttribute("autojoin");Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+Strophe.getNodeFromJid(jid)+")",jid:jid,alias:alias,autojoin:autojoin,iconCls:"chatroom-icon",handle:nick,
anonymous:anonymous,leaf:!0});autojoin&&null==Ext.getCmp("chatpanel").getMUC(jid)&&(Application.log("Autojoining MUC: "+jid),function(){Application.MsgBus.fireEvent("joinchat",this.jid,this.nick,this.anonymous)}.defer(5E3*a,{jid:jid,nick:nick,anonymous:anonymous}),a+=1)}Ext.getCmp("bookmarks").root.initialLoad=!0}
function onIQ(a){try{iqParser(a)}catch(b){a="IQ Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function iqParser(a){if("fetchrooms"==a.getAttribute("id")){items=a.firstChild.getElementsByTagName("item");for(a=0;a<items.length;a++)Ext.getCmp("chatrooms").root.appendChild({text:items[a].getAttribute("name")+" ("+Strophe.getNodeFromJid(items[a].getAttribute("jid"))+")",jid:items[a].getAttribute("jid"),iconCls:"chatroom-icon",leaf:!0});myTreeSorter=new Ext.tree.TreeSorter(Ext.getCmp("chatrooms"),{folderSort:!0,dir:"asc"});myTreeSorter.doSort(Ext.getCmp("chatrooms").getRootNode())}}
function onRoster(a){try{rosterParser(a)}catch(b){a="Roster Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function rosterParser(a){var b=Ext.getCmp("buddies").root;a=$(a).find("item");for(var d=0;d<a.length;d++)for(var e=$(a[d]).find("group"),g=0;g<e.length;g++){var f=$(e[g]);child=b.findChild("group",f.text())||b.appendChild({leaf:!1,group:f.text(),text:f.text(),expanded:!0,loaded:!0});child.appendChild({text:a[d].getAttribute("name"),barejid:a[d].getAttribute("jid"),resources:new Ext.util.MixedCollection,iconCls:"buddy-offline",presence:"offline",hidden:!0,leaf:!0})}Application.XMPPConn.send($pres().tree());
var h=$iq({type:"get",id:"_get1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"}).tree();(function(){Application.XMPPConn.sendIQ(h,parseBookmarks)}).defer(3E3,this);return!0}function onPresence(a){try{presenceParser(a)}catch(b){a="Presence Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}
function getMUCIcon(a,b){return"owner"==a?"icons/owner.png":"admin"==a?"icons/admin.png":"icons/participant.png"}
function presenceParser(a){var b=a.getAttribute("from");if(Strophe.getDomainFromJid(b)=="conference."+Application.XMPPHOST)if(room=Strophe.getBareJidFromJid(b),mcp=Ext.getCmp("chatpanel").getMUC(room),null==mcp)Application.log("ERROR: got presence from non-existant room: "+room);else{if(0<$(a).find("status").length&&(error=$(a).find("status"),"201"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, chatroom ["+room+"] does not exist.");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<
$(a).find("error").length&&(error=$(a).find("error"),"407"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your account is not authorized to access chatroom ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("error").length&&(error=$(a).find("error"),"409"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your requested chatroom handle is already in use by room ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(a).find("status").length&&
(error=$(a).find("status"),"307"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Your account signed into this chatroom ["+room+"] with the same handle from another location. Please use unique handles.");mcp.joinedChat=!1;Ext.getCmp("chatpanel").removeMUC(room);return}child=mcp.roomusers.root.findChild("text",Strophe.getResourceFromJid(b));var d=$(a).find("item"),e=b,g,f;if(0<d.length&&(e=d[0].getAttribute("jid")||e,f=d[0].getAttribute("role"),g=d[0].getAttribute("affiliation"),d=$(d[0]).find("role"),
0<d.length))try{f=d.text()}catch(h){var d="roletest bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n"),q;for(q in h)d+="property: "+q+" value: ["+h[q]+"]\n";d+="toString():  value: ["+h.toString()+"]";Application.log(d)}null!=a.getAttribute("type")||child||"visitor"==f||(mcp.joinedChat=!0,mcp.roomusers.root.appendChild({affiliation:g,role:f,icon:getMUCIcon(g,f),text:Strophe.getResourceFromJid(b),jid:e,leaf:!0}));"unavailable"==a.getAttribute("type")&&child&&mcp.roomusers.root.removeChild(child)}else onBuddyPresence(a)}
function onMessage(a){try{messageParser(a)}catch(b){a="Message Bug\n:"+(Strophe.xmlescape(Strophe.serialize(a))+"\n");for(var d in b)a+="property: "+d+" value: ["+b[d]+"]\n";a+="toString():  value: ["+b.toString()+"]";Application.log(a)}return!0}Application.replaceURLWithHTMLLinks=function(a){return null==a?null:a.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,"<a href='$1'>$1</a>")};
function messageParser(a){var b=a.getAttribute("from"),d=a.getAttribute("type"),e=a.getElementsByTagName("body"),g=$(a).find("x[xmlns='jabber:x:delay']"),f=$(a).find("html"),h=e[0],q="",e=!1;0<f.length?(q=$(a).find("html").find("body"),q=navigator.userAgent.match(/msie/i)?q[0].xml:$(q[0]).html(),q=q.replace(/\<p/g,"<span").replace(/\<\/p\>/g,"</span>"),""==q&&(Application.log("Message Failure:"+a),q=Application.replaceURLWithHTMLLinks(Strophe.getText(h)))):q=Application.replaceURLWithHTMLLinks(Strophe.getText(h));
0<g.length?(f=g[0].getAttribute("stamp"),e=!0):f=(new Date).toUTC().format("Ymd\\TH:i:s");if("groupchat"==d){product_id=null;g=$(a).find("x");for(d=0;d<g.length;d++)g[d].getAttribute("product_id")&&(product_id=g[d].getAttribute("product_id"));try{geomParser(a,e)}catch(s){}sender=Strophe.getResourceFromJid(b);room=Strophe.getBareJidFromJid(b);(mpc=Ext.getCmp("chatpanel").getMUC(room))&&sender&&(mpc.gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(f,"Ymd\\Th:i:s"),author:sender,message:q,
room:null,jid:mpc.getJidByHandle(sender),xdelay:e,product_id:product_id})),mpc.gp.getStore().isFiltered()&&mpc.gp.getStore().filterBy(nwsbotFilter),e||(Ext.getCmp("__allchats__").gp.getStore().addSorted(new Ext.data.Record({ts:UTCStringToDate(f,"Ymd\\Th:i:s"),author:sender,room:Strophe.getNodeFromJid(b),message:q,jid:mpc.getJidByHandle(sender),xdelay:e,product_id:product_id})),Ext.getCmp("__allchats__").gp.getStore().isFiltered()&&Ext.getCmp("__allchats__").gp.getStore().filterBy(nwsbotFilter)))}else"chat"!=
d||q||null==b?"chat"==d&&q&&null!=b?(jid=Strophe.getBareJidFromJid(b),username=Strophe.getNodeFromJid(b),Strophe.getDomainFromJid(b)!=Application.XMPPHOST&&(jid=b,username=Strophe.getResourceFromJid(b)),cp=Ext.getCmp("chatpanel").getChat(jid),cp||(cp=Ext.getCmp("chatpanel").addChat(jid),Application.MsgBus.fireEvent("soundevent","new_conversation")),cp.gp.store.addSorted(new Ext.data.Record({ts:UTCStringToDate(f,"Ymd\\Th:i:s"),author:username,room:null,xdelay:!1,message:q}))):b==Application.XMPPHOST&&
(new Ext.Window({width:500,maxWidth:500,height:350,constrain:!0,autoScroll:!0,bodyStyle:{padding:"10",background:"#fff"},title:$(a).find("subject").text()||"System Message",html:"<p><b>System Message</b><p>"+$(a).find("body").text()+"</p>"})).show():(jid=Strophe.getBareJidFromJid(b),cp=Ext.getCmp("chatpanel").getChat(jid),0<$(a).find("composing").length&&cp&&cp.setIconCls("typing-tab"),0<$(a).find("paused").length&&cp&&cp.setIconCls("paused-tab"))}
function geomParser(a,b){if(Ext.getCmp("map")){var d=a.getElementsByTagName("body")[0],e=null;0<a.getElementsByTagName("html").length?(e=$(a).find("html").find("body"),e=navigator.userAgent.match(/msie/i)?e[0].xml:$(e[0]).html()):e=Strophe.getText(d);d=$(a).find("x");if(0!=d.length)for(var g=0;g<d.length;g++)if(null!=d[g].getAttribute("geometry")){var f=d[g].getAttribute("geometry");wkt=new OpenLayers.Format.WKT;if(collection=wkt.read(f)){collection.constructor!=Array&&(collection=[collection]);var h=
collection[0],f=36E5;if(!d[g].getAttribute("skip")){if(d[g].getAttribute("expire")){var q=UTCStringToDate(d[g].getAttribute("expire"),"Ymd\\Th:i:s");h.attributes.expire=q.toUTC();diff=q-new Date;if(0>=diff)continue;0<diff&&(f=diff)}d[g].getAttribute("valid")&&(q=UTCStringToDate(d[g].getAttribute("valid"),"Ymd\\Th:i:s"),h.attributes.valid=q.toUTC());h.attributes.ptype=d[g].getAttribute("ptype");h.attributes.message=e;h.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
"LSR"!=d[g].getAttribute("category")&&"PIREP"!=d[g].getAttribute("category")||!h.attributes.valid||b&&!(b&&72E5>new Date-h.attributes.valid)||(lsrs.addFeatures([h]),(new Ext.util.DelayedTask(function(){lsrs.removeFeatures([h])})).delay(f),sstate=Application.lsrStore.getSortState(),Application.lsrStore.sort(sstate.field,sstate.direction));"SBW"==d[g].getAttribute("category")&&(h.attributes.vtec=d[g].getAttribute("vtec"),q=Application.sbwStore.find("vtec",h.attributes.vtec),"CAN"==d[g].getAttribute("status")?
-1<q&&(Application.log("Removing SBW vtec ["+h.attributes.vtec+"]"),Application.sbwStore.removeAt(q)):(-1<q&&(Application.log("Old SBW vtec ["+h.attributes.vtec+"]"),Application.sbwStore.removeAt(q)),Application.log("Adding SBW vtec ["+h.attributes.vtec+"] delay ["+f+"]"),sbws.addFeatures([h]),(new Ext.util.DelayedTask(function(){sbws.removeFeatures([h])})).delay(f),sstate=Application.sbwStore.getSortState(),Application.sbwStore.sort(sstate.field,sstate.direction)))}}}}}
function rawInput(a){Application.log("RECV: "+Strophe.xmlescape(a))}function rawOutput(a){Application.log("SENT: "+Strophe.xmlescape(a))};Ext.ns("Application");Application.updateColors=function(){var a=Application.getPreference("bgcolor","FFFFFF"),b=Application.getPreference("fgcolor","000000");Application.log("Attempting style adjustment bgcolor:"+a+", fgcolor:"+b);Ext.getCmp("chatpanel").items.each(function(d){d.te&&d.te.items.get(0).getEl().applyStyles({background:"#"+a,color:"#"+b})})};
Application.syncPreferences=function(){Application.log("Saving preferences to server...");var a=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"});Application.prefStore.each(function(a){this.c("pref",{key:a.get("key"),value:a.get("value")}).up()},a);Application.XMPPConn.sendIQ(a.tree())};Application.removePreference=function(a){idx=Application.prefStore.find("key",a);-1<idx&&Application.prefStore.removeAt(idx)};
Application.getPreference=function(a,b){idx=Application.prefStore.find("key",a);return-1<idx?(record=Application.prefStore.getAt(idx),record.get("value")):b};Application.setPreference=function(a,b){idx=Application.prefStore.find("key",a);-1<idx?(Application.log("Setting Preference: "+a+" Value: "+b),record=Application.prefStore.getAt(idx),record.set("value",b)):(Application.log("Adding Preference: "+a+" Value: "+b),Application.prefStore.add(new Ext.data.Record({key:a,value:b})))};
Application.prefStore=new Ext.data.Store({fields:[{id:"key"},{id:"value"}],locked:!1,listeners:{remove:function(a,b,d){Application.log("prefStore remove event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences()},update:function(a,b,d){Application.log("prefStore update event fired...");if(a.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences();"fgcolor"!=b.get("key")&&"bgcolor"!=
b.get("key")||Application.updateColors()}}});Application.MsgBus=new Ext.util.Observable;Application.MsgBus.addEvents("message");Application.MsgBus.addEvents("loggedin");Application.MsgBus.addEvents("loggedout");
Application.playSound=function(a){if(soundManager&&soundManager.ok()&&1!=soundManager.playState){var b=soundManager.getSoundById(a);if(!b){idx=Application.SoundStore.find("id",a);if(-1==idx){Application.log("Could not find sound: "+a);return}record=Application.SoundStore.getAt(idx);b=soundManager.createSound({id:record.get("id"),url:record.get("src"),onplay:function(){},onfinish:function(){}})}b&&b.play({volume:Application.getPreference("volume",100)})}};
Application.MsgBus.on("soundevent",function(a){enable=Application.getPreference("sound::"+a+"::enabled","true");"false"!=enable&&(sidx=Application.getPreference("sound::"+a+"::sound","default"),Application.playSound(sidx))});
Application.MsgBus.on("loggingout",function(){Ext.getCmp("chatpanel").items.each(function(a){"groupchat"==a.chatType&&a.clearRoom()});Ext.getCmp("buddies").root.removeAll();Ext.getCmp("bookmarks").root.suspendEvents(!1);Ext.getCmp("bookmarks").root.removeAll();Ext.getCmp("bookmarks").root.resumeEvents();Ext.getCmp("bookmarks").root.initalLoad=!1;Ext.getCmp("chatrooms").root.removeAll()});Application.MsgBus.on("loggedout",function(){Ext.getCmp("loginwindow").show()});
Application.MsgBus.on("loggedin",function(){Ext.getCmp("loginwindow").hide();Application.XMPPConn.send($iq({type:"get",id:"fetchrooms",to:"conference."+Application.XMPPHOST}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}))});
Application.MsgBus.on("joinchat",function(a,b,d){if(null==b||""==b)b=Application.USERNAME;mcp=Ext.getCmp("chatpanel").getMUC(a);if(null==mcp){Application.log("Creating chatroom:"+a);mcp=Ext.getCmp("chatpanel").addMUC(a,b,d);var e=$pres({to:a+"/"+b});d&&e.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");Application.XMPPConn.send(e);mcp.on("destroy",function(){Application.XMPPConn.authenticated&&this.joinedChat&&Application.XMPPConn.send($pres({type:"unavailable",to:a+
"/"+b}))})}Ext.getCmp("chatpanel").setActiveTab(mcp)});Ext.ns("Application");
Application.buildAddBuddy=function(a,b,d){Ext.getCmp("addbuddy")||(new Ext.Window({title:"Add Buddy",layout:"form",width:300,height:150,id:"addbuddy",items:[{xtype:"textfield",fieldLabel:"NWSChat ID",value:a},{xtype:"textfield",fieldLabel:"Alias",value:b},{xtype:"textfield",fieldLabel:"Buddy Group",value:d}],buttons:[{text:"Add Buddy",handler:function(a){var b=a.ownerCt.ownerCt.items.items[0].getValue(),d=a.ownerCt.ownerCt.items.items[1].getValue();a=a.ownerCt.ownerCt.items.items[2].getValue();var h=
$pres({to:b+"@"+Application.XMPPHOST,type:"subscribe"});Application.XMPPConn.send(h.tree());h=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:b+"@"+Application.XMPPHOST,name:d}).c("group",a);Application.XMPPConn.send(h.tree());Ext.getCmp("addbuddy").close()}}]})).show()};
